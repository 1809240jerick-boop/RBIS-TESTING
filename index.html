<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBI Management System 2026 (Final)</title>
    <meta name="theme-color" content="#0d6efd">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>

    <style>
    :root {
        --sidebar-bg: #111827;
        --sidebar-hover: #1f2937;
        --sidebar-active: #2563eb;
        --body-bg: #f0f2f7;
        --card-bg: #ffffff;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --accent-blue: #2563eb;
        --accent-green: #059669;
        --accent-amber: #d97706;
        --accent-red: #dc2626;
        --accent-cyan: #0891b2;
        --accent-purple: #7c3aed;
        --accent-indigo: #4f46e5;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.04);
        --shadow-lg: 0 10px 25px rgba(0,0,0,0.08), 0 4px 10px rgba(0,0,0,0.04);
        --radius: 12px;
        --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    body { background-color: var(--body-bg); font-family: 'DM Sans', 'Plus Jakarta Sans', -apple-system, sans-serif; color: var(--text-primary); margin: 0; }
    .sidebar { height: 100vh; width: 260px; position: fixed; top: 0; left: 0; background: var(--sidebar-bg); padding-top: 0; color: white; transition: all 0.3s cubic-bezier(.4,0,.2,1); z-index: 1000; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.05); }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
    .sidebar-header { padding: 24px 24px 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px; background: linear-gradient(135deg, rgba(37,99,235,0.15) 0%, transparent 100%); }
    .sidebar-header h4 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; font-size: 1.15rem; margin-bottom: 2px; letter-spacing: -0.3px; }
    .sidebar-header small { color: rgba(255,255,255,0.45); font-size: 0.75rem; }
    .sidebar .nav-label { padding: 18px 24px 6px 24px; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; color: rgba(255,255,255,0.3); font-weight: 700; display: block; }
    .sidebar a { padding: 11px 24px; text-decoration: none; font-size: 0.88rem; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 12px; transition: all 0.2s ease; border-left: 3px solid transparent; font-weight: 500; margin: 1px 0; }
    .sidebar a i { font-size: 1rem; width: 20px; text-align: center; }
    .sidebar a:hover { background: var(--sidebar-hover); color: #fff; border-left-color: rgba(255,255,255,0.2); }
    .sidebar a.active { background: rgba(37,99,235,0.18); color: #60a5fa; border-left-color: var(--sidebar-active); font-weight: 600; }
    .content { margin-left: 260px; padding: 28px 32px; min-height: 100vh; }
    .page-title { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; font-size: 1.6rem; letter-spacing: -0.5px; color: var(--text-primary); margin-bottom: 6px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.88rem; margin-bottom: 24px; }
    .card-custom { border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow-sm); background: var(--card-bg); transition: all 0.25s cubic-bezier(.4,0,.2,1); }
    .card-custom:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .stat-card { border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; cursor: pointer; transition: all 0.25s cubic-bezier(.4,0,.2,1); border: 1px solid var(--border-color); background: var(--card-bg); }
    .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; border-radius: 4px 0 0 4px; }
    .stat-card .stat-icon { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-bottom: 14px; }
    .stat-card .stat-label { font-size: 0.78rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .stat-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.8rem; font-weight: 800; letter-spacing: -1px; margin-top: 2px; }
    .stat-card .print-hint { font-size: 0.68rem; color: var(--text-secondary); opacity: 0; transition: opacity 0.2s; margin-top: 4px; }
    .stat-card:hover .print-hint { opacity: 1; }
    .stat-primary::before { background: var(--accent-blue); }
    .stat-primary .stat-icon { background: rgba(37,99,235,0.1); color: var(--accent-blue); }
    .stat-success::before { background: var(--accent-green); }
    .stat-success .stat-icon { background: rgba(5,150,105,0.1); color: var(--accent-green); }
    .stat-warning::before { background: var(--accent-amber); }
    .stat-warning .stat-icon { background: rgba(217,119,6,0.1); color: var(--accent-amber); }
    .stat-danger::before { background: var(--accent-red); }
    .stat-danger .stat-icon { background: rgba(220,38,38,0.1); color: var(--accent-red); }
    .stat-info::before { background: var(--accent-cyan); }
    .stat-info .stat-icon { background: rgba(8,145,178,0.1); color: var(--accent-cyan); }
    .stat-indigo::before { background: var(--accent-indigo); }
    .stat-indigo .stat-icon { background: rgba(79, 70, 229, 0.1); color: var(--accent-indigo); }
    .mini-stat { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 14px 16px; cursor: pointer; transition: all 0.2s ease; text-align: center; }
    .mini-stat:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-sm); transform: translateY(-1px); }
    .mini-stat .mini-label { font-size: 0.72rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; }
    .mini-stat .mini-value { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.35rem; font-weight: 800; color: var(--text-primary); }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #111827 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .login-box { background: rgba(30,41,59,0.8); backdrop-filter: blur(20px); padding: 44px 40px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 25px 50px rgba(0,0,0,0.3); width: 420px; text-align: center; position: relative; z-index: 1; }
    .login-box h3 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 800; letter-spacing: -0.5px; }
    .login-box .form-control { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: white; border-radius: 10px; padding: 12px 16px; }
    .login-box .form-control::placeholder { color: rgba(255,255,255,0.35); }
    .login-box .form-control:focus { background: rgba(255,255,255,0.1); border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }
    .login-box .btn-primary { background: var(--accent-blue); border: none; border-radius: 10px; padding: 12px; font-weight: 600; transition: all 0.2s; }
    .login-box .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .d-none { display: none !important; }
    #search-input { border-radius: 10px; border: 1px solid var(--border-color); padding: 10px 16px 10px 40px; font-size: 0.9rem; transition: all 0.2s; background: var(--card-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 14px center; background-size: 16px; }
    #search-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .record-card { border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 16px 20px; margin-bottom: 8px; background: var(--card-bg); cursor: pointer; transition: all 0.2s ease; }
    .record-card:hover { border-color: var(--accent-blue); box-shadow: var(--shadow-sm); }
    .form-control, .form-select { border-radius: var(--radius-sm); border: 1px solid var(--border-color); padding: 9px 14px; font-size: 0.88rem; transition: all 0.2s; }
    .form-control:focus, .form-select:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .form-check-input:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
    .btn { border-radius: var(--radius-sm); font-weight: 600; font-size: 0.88rem; padding: 9px 18px; transition: all 0.2s; }
    .btn-primary { background: var(--accent-blue); border-color: var(--accent-blue); }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-success { background: var(--accent-green); border-color: var(--accent-green); }
    .btn-dark { background: var(--sidebar-bg); border-color: var(--sidebar-bg); }
    .badge { font-weight: 600; font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; }
    .modal-content { border-radius: var(--radius); border: none; box-shadow: var(--shadow-lg); }
    .modal-header { border-bottom: 1px solid var(--border-color); padding: 20px 24px; }
    .modal-header h5 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; }
    .modal-body { padding: 24px; }
    .modal-footer { border-top: 1px solid var(--border-color); padding: 16px 24px; }
    .table { border-radius: var(--radius-sm); overflow: hidden; }
    .table thead th { background: #f9fafb; font-weight: 600; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-secondary); border-bottom: 2px solid var(--border-color); }
    .system-card { border: 1px solid var(--border-color); border-radius: var(--radius); background: var(--card-bg); overflow: hidden; transition: all 0.25s ease; position: relative; }
    .system-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-3px); }
    .system-card .system-img { height: 180px; background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #1e293b 100%); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
    .system-card .system-img::before { content: ''; position: absolute; width: 200px; height: 200px; background: radial-gradient(circle, rgba(37,99,235,0.2) 0%, transparent 70%); top: 50%; left: 50%; transform: translate(-50%,-50%); }
    .system-card .system-img i { font-size: 4rem; color: rgba(255,255,255,0.7); position: relative; z-index: 1; }
    .system-card .system-body { padding: 20px; }
    .system-card .system-body h5 { font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 700; }
    .system-card .sale-badge { position: absolute; top: 14px; right: 14px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; z-index: 2; box-shadow: 0 2px 8px rgba(217,119,6,0.4); }
    .section-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .search-results { position: absolute; z-index: 100; background: white; border: 1px solid var(--border-color); border-radius: var(--radius-sm); max-height: 200px; overflow-y: auto; width: 100%; box-shadow: var(--shadow-md); }
    .search-item { padding: 10px 14px; cursor: pointer; transition: background 0.15s; }
    .search-item:hover { background: #f0f4ff; }
    .list-group-item { border-color: var(--border-color); border-radius: var(--radius-sm) !important; margin-bottom: 4px; }
    .list-group-item:hover { background: #f8fafc; }
    .print-preview-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .print-preview-table th { background: #f9fafb; font-weight: 600; padding: 8px 10px; border-bottom: 2px solid var(--border-color); text-align: left; }
    .print-preview-table td { padding: 7px 10px; border-bottom: 1px solid var(--border-color); }
    .pagination-controls { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 16px; padding: 12px; background: var(--card-bg); border-radius: var(--radius-sm); border: 1px solid var(--border-color); }
    .pagination-controls .page-info { font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; }
    .pagination-controls .btn { padding: 6px 14px; font-size: 0.82rem; }
    #print-area { display: none; }
    @media print {
        body > * { display: none !important; }
        .sidebar, .content, #security-overlay { display: none !important; }
        #print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; z-index: 99999; }
        @page { margin: 10mm; }
        .print-table { width: 100%; border-collapse: collapse; font-family: 'Times New Roman', serif; font-size: 10pt; }
        .print-table th, .print-table td { border: 1px solid black; padding: 4px; vertical-align: middle; }
        .form-b-page { page-break-after: always; }
        .form-b-page:last-child { page-break-after: auto; }
    }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .anim-in { animation: fadeUp 0.4s cubic-bezier(.4,0,.2,1) forwards; }
    .anim-d1 { animation-delay: 0.05s; }
    .anim-d2 { animation-delay: 0.1s; }
    .anim-d3 { animation-delay: 0.15s; }
    .anim-d4 { animation-delay: 0.2s; }
    .bulk-formb-preview { max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 10px; background: #f9fafb; }
    .bulk-formb-item { display: flex; align-items: center; padding: 8px 12px; background: white; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 6px; }
    .bulk-formb-item .formb-num { width: 40px; height: 40px; background: var(--accent-blue); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; margin-right: 12px; }
    .bulk-formb-item .formb-info { flex: 1; }
    .bulk-formb-item .formb-name { font-weight: 600; font-size: 0.9rem; }
    .bulk-formb-item .formb-meta { font-size: 0.75rem; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div id="security-overlay" class="overlay">
        <div class="login-box">
            <h3 class="mb-4"><i class="fas fa-shield-alt" style="color:#60a5fa;"></i> RBI SECURE</h3>
            <div id="login-phase-1">
                <p class="text-muted small mb-3" style="color:rgba(255,255,255,0.45)!important;">System requires Dynamic Authentication.</p>
                <input type="password" id="dynamic-code" class="form-control mb-3 text-center" placeholder="Enter Dynamic Access Code">
                <button onclick="checkDynamic()" class="btn btn-primary w-100">Authenticate</button>
                <div class="mt-3" style="font-size: 0.8rem; color:rgba(255,255,255,0.3);" id="server-time-display"></div>
            </div>
            <div id="login-phase-2" class="d-none">
                <p class="small mb-3" style="color:#34d399;">Authentication Verified.</p>
                <p class="small" style="color:rgba(255,255,255,0.5);">Please set your personal password.</p>
                <input type="password" id="new-custom-pass" class="form-control mb-2" placeholder="New Password">
                <input type="password" id="confirm-custom-pass" class="form-control mb-3" placeholder="Confirm Password">
                <button onclick="setCustomPassword()" class="btn btn-success w-100">Set Password & Login</button>
            </div>
            <div id="login-phase-3" class="d-none">
                <p class="small mb-3" style="color:rgba(255,255,255,0.6);">Welcome Back</p>
                <input type="password" id="input-custom-pass" class="form-control mb-3 text-center" placeholder="Enter Password">
                <button onclick="verifyCustomPassword()" class="btn btn-primary w-100">Login</button>
                <button onclick="forgotPassword()" class="btn btn-link btn-sm mt-2" style="color:rgba(255,255,255,0.4);">Forgot Password?</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-users-cog" style="color:#60a5fa;"></i> RBI System</h4>
            <small>Brgy. Data Management</small>
        </div>
        <span class="nav-label">Main</span>
        <a href="#" onclick="showHome()" class="nav-link active"><i class="fas fa-th-large me-1"></i> Dashboard</a>
        <a href="#" onclick="showAdd()" class="nav-link"><i class="fas fa-user-plus me-1"></i> Add Resident</a>
        <a href="#" onclick="showHouseholds()" class="nav-link"><i class="fas fa-house-user me-1"></i> Households</a>
        <a href="#" onclick="showDeaths()" class="nav-link"><i class="fas fa-book-dead me-1"></i> Death Registry</a>
        <span class="nav-label">Data</span>
        <a href="#" onclick="showImport()" class="nav-link"><i class="fas fa-file-import me-1"></i> Import / Export</a>
        <a href="#" onclick="showSettings()" class="nav-link"><i class="fas fa-cogs me-1"></i> Settings</a>
        <span class="nav-label">Modules</span>
        <a href="#" onclick="showOtherSystems()" class="nav-link"><i class="fas fa-th me-1"></i> Other Systems</a>
        <a href="#" onclick="logout()" class="nav-link" style="margin-top:30px; color:rgba(255,255,255,0.35);"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
    </div>

    <div class="content" id="main-container">
        <div id="section-home">
            <div class="page-title">Dashboard Overview</div>
            <div class="page-subtitle">Real-time barangay population summary (IndexedDB Powered)</div>
            <div class="row g-3 mb-4">
                <div class="col-md-3 anim-in">
                    <div class="stat-card stat-primary" onclick="printStatCategory('total')" title="Click to print all residents">
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-label">Total Residents</div>
                        <div class="stat-value" id="rep-total">0</div>
                        <div class="print-hint"><i class="fas fa-print"></i> Click to print</div>
                    </div>
                </div>
                <div class="col-md-3 anim-in anim-d1">
                    <div class="stat-card stat-info" onclick="printStatCategory('households')" title="Click to print households">
                        <div class="stat-icon"><i class="fas fa-home"></i></div>
                        <div class="stat-label">Total Households</div>
                        <div class="stat-value" id="rep-hh-total">0</div>
                        <div class="print-hint"><i class="fas fa-print"></i> Click to print</div>
                    </div>
                </div>
                <div class="col-md-3 anim-in anim-d2">
                    <div class="stat-card stat-success" onclick="printStatCategory('families')" title="Click to print families">
                        <div class="stat-icon"><i class="fas fa-people-roof"></i></div>
                        <div class="stat-label">Total Families</div>
                        <div class="stat-value" id="rep-family-total">0</div>
                        <div class="print-hint"><i class="fas fa-print"></i> Click to print</div>
                    </div>
                </div>
                <div class="col-md-3 anim-in anim-d3">
                    <div class="stat-card stat-indigo" onclick="printStatCategory('voters')" title="Click to print voters">
                        <div class="stat-icon"><i class="fas fa-vote-yea"></i></div>
                        <div class="stat-label">Registered Voters</div>
                        <div class="stat-value" id="rep-voters">0</div>
                        <div class="print-hint"><i class="fas fa-print"></i> Click to print</div>
                    </div>
                </div>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('seniors')" title="Print Seniors"><div class="mini-label">Seniors (60+)</div><div class="mini-value" id="rep-senior">0</div></div></div>
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('male')" title="Print Males"><div class="mini-label">Male</div><div class="mini-value" id="rep-male">0</div></div></div>
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('female')" title="Print Females"><div class="mini-label">Female</div><div class="mini-value" id="rep-female">0</div></div></div>
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('children')" title="Print Children"><div class="mini-label">Children</div><div class="mini-value" id="rep-child">0</div></div></div>
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('adults')" title="Print Adults"><div class="mini-label">Adults</div><div class="mini-value" id="rep-adult">0</div></div></div>
                <div class="col-md-2 col-6"><div class="mini-stat" onclick="printStatCategory('pwd')" title="Print PWD"><div class="mini-label">PWD</div><div class="mini-value" id="rep-pwd">0</div></div></div>
                <div class="col-md-2 col-6 mt-2"><div class="mini-stat" onclick="printStatCategory('solo')" title="Print Solo Parents"><div class="mini-label">Solo Parent</div><div class="mini-value" id="rep-solo">0</div></div></div>
                <div class="col-md-2 col-6 mt-2"><div class="mini-stat" onclick="printStatCategory('osy')" title="Print OSY"><div class="mini-label">OSY (15-24)</div><div class="mini-value" id="rep-osy">0</div></div></div>
            </div>
            <div class="section-bar">
                <input type="text" id="search-input" class="form-control" style="max-width:400px;" placeholder="Search resident name..." onkeyup="debouncedRenderList()">
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" onclick="showAgeRangeModal()"><i class="fas fa-sliders-h me-1"></i> Print by Age Range</button>
                    <button class="btn btn-outline-success" onclick="showBulkFormBModal()"><i class="fas fa-file-alt me-1"></i> Bulk Print Form B</button>
                    <button class="btn btn-dark" onclick="printStats()"><i class="fas fa-print me-1"></i> Print Demographics (Form C)</button>
                </div>
            </div>
            <div id="record-list"></div>
            <div class="pagination-controls" id="resident-pagination">
                <button class="btn btn-outline-secondary" id="btn-res-prev" onclick="residentPrevPage()" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <span class="page-info" id="resident-page-info">Page 1 of 1</span>
                <button class="btn btn-outline-secondary" id="btn-res-next" onclick="residentNextPage()" disabled>Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="section-add" class="d-none">
            <div class="page-title">Resident Information Sheet</div>
            <div class="page-subtitle">Add or edit an individual resident record</div>
            <div class="card card-custom p-4">
                <input type="hidden" id="rec-id">
                <div class="row g-3">
                    <div class="col-md-12"><h5 class="text-primary border-bottom pb-2" style="font-family:'Plus Jakarta Sans'; font-weight:700;">I. Personal Profile</h5></div>
                    <div class="col-md-3"><label>Last Name <span class="text-danger">*</span></label><input type="text" id="f-last" class="form-control text-uppercase"></div>
                    <div class="col-md-3"><label>First Name <span class="text-danger">*</span></label><input type="text" id="f-first" class="form-control text-uppercase"></div>
                    <div class="col-md-3"><label>Middle Name</label><input type="text" id="f-middle" class="form-control text-uppercase"></div>
                    <div class="col-md-3"><label>Suffix</label><input type="text" id="f-suffix" class="form-control text-uppercase" placeholder="e.g. JR, III"></div>
                    <div class="col-md-3"><label>Birth Date <span class="text-danger">*</span></label><input type="date" id="f-bdate" class="form-control"></div>
                    <div class="col-md-3"><label>Sex <span class="text-danger">*</span></label><select id="f-sex" class="form-select"><option value="MALE">MALE</option><option value="FEMALE">FEMALE</option></select></div>
                    <div class="col-md-3"><label>Civil Status</label><select id="f-civil" class="form-select"><option value="SINGLE">SINGLE</option><option value="MARRIED">MARRIED</option><option value="WIDOWED">WIDOWED</option><option value="SEPARATED">SEPARATED</option><option value="LIVE-IN">LIVE-IN / COMMON LAW</option><option value="ANNULLED">ANNULLED</option></select></div>
                    <div class="col-md-3"><label>Religion</label><input type="text" id="f-religion" class="form-control text-uppercase" placeholder="e.g. ROMAN CATHOLIC"></div>
                    <div class="col-md-3"><label>Citizenship</label><select id="f-citizen" class="form-select"><option value="FILIPINO">FILIPINO</option><option value="FOREIGNER">FOREIGNER</option></select></div>
                    <div class="col-md-4"><label>Birth Place</label><input type="text" id="f-bplace" class="form-control text-uppercase"></div>
                    <div class="col-md-4"><label>Occupation</label><input type="text" id="f-prof" class="form-control text-uppercase" placeholder="Put 'Student' or 'Unemployed' if applicable"></div>
                    <div class="col-md-4"><label>PhilSys ID</label><input type="text" id="f-philsys" class="form-control"></div>
                    <div class="col-md-12 position-relative">
                        <label class="fw-bold">Mother's Maiden Name</label>
                        <input type="text" class="form-control mb-1" id="mother-search-input" placeholder="Type to search mother from DB..." onkeyup="debouncedSearchMother(this.value)">
                        <div id="mother-search-results" class="search-results d-none"></div>
                        <div class="row g-2 mt-1">
                            <div class="col-4"><input type="text" id="f-m-last" class="form-control form-control-sm text-uppercase" placeholder="Mother's Last Name"></div>
                            <div class="col-4"><input type="text" id="f-m-first" class="form-control form-control-sm text-uppercase" placeholder="Mother's First Name"></div>
                            <div class="col-4"><input type="text" id="f-m-middle" class="form-control form-control-sm text-uppercase" placeholder="Mother's Middle Name"></div>
                        </div>
                    </div>
                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2" style="font-family:'Plus Jakarta Sans'; font-weight:700;">II. Special Categories & Status</h5></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-voter"><label class="form-check-label fw-bold" style="color:var(--accent-indigo);">Registered Voter</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-solo"><label class="form-check-label">Solo Parent</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-pwd"><label class="form-check-label">Person with Disability (PWD)</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-ofw"><label class="form-check-label">OFW</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-ip"><label class="form-check-label">Indigenous People (IP)</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-osc"><label class="form-check-label">Out of School Child (6-14 y/o)</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-osy"><label class="form-check-label">Out of School Youth (15-24 y/o)</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-unemployed"><label class="form-check-label text-warning">Unemployed (Labor Force)</label></div></div>
                    <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="f-dead" onchange="toggleDeathInput()"><label class="form-check-label text-danger">Deceased</label></div></div>
                    <div class="col-md-4 d-none" id="death-date-container"><label class="text-danger">Date of Death</label><input type="date" id="f-death-date" class="form-control border-danger"></div>
                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2" style="font-family:'Plus Jakarta Sans'; font-weight:700;">III. Contact & Residence</h5></div>
                    <div class="col-md-6"><label>Inhabitant Type</label><select id="f-type" class="form-select"><option value="NON-MIGRANT">NON-MIGRANT (Permanent)</option><option value="MIGRANT">MIGRANT</option><option value="TRANSIENT">TRANSIENT</option></select></div>
                    <div class="col-md-6"><label>Contact Number</label><input type="text" id="f-contact" class="form-control"></div>
                    <div class="col-md-6"><label>Email Address</label><input type="email" id="f-email" class="form-control"></div>
                    <div class="col-md-6"><label>Educational Attainment</label><select id="f-edu" class="form-select"><option value="">Select...</option><option value="ELEMENTARY">ELEMENTARY</option><option value="HIGH SCHOOL">HIGH SCHOOL</option><option value="COLLEGE UNDERGRAD">COLLEGE UNDERGRAD</option><option value="COLLEGE GRADUATE">COLLEGE GRADUATE</option><option value="POST GRAD">POST GRAD</option><option value="VOCATIONAL">VOCATIONAL</option><option value="NONE">NONE</option></select></div>
                    <div class="col-md-12"><label>Current Address (Street/Sitio)</label><input type="text" id="f-address" class="form-control text-uppercase"></div>
                    <div class="col-md-12 mt-3 p-3" style="background:#f8fafc; border:1px solid var(--border-color); border-radius:var(--radius-sm);"><strong>Current Household: </strong><span id="f-hh-display" class="fw-bold" style="color:var(--accent-blue);">No Household Assigned</span></div>
                    <div class="col-md-12 mt-4 text-end">
                        <button class="btn btn-secondary me-2" onclick="showHome()">Cancel</button>
                        <button class="btn btn-danger me-2" id="btn-del" style="display:none;" onclick="deleteRecord()">Delete</button>
                        <button class="btn btn-primary px-4" onclick="saveRecord()"><i class="fas fa-save me-1"></i> Save Record</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-hh" class="d-none">
            <div class="section-bar">
                <div><div class="page-title">Household Management</div><div class="page-subtitle">Manage household groups and members</div></div>
                <div class="d-flex gap-2">
                     <button class="btn btn-dark" onclick="printHHHeads()"><i class="fas fa-print me-1"></i> Print Household Heads</button>
                     <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-new-hh"><i class="fas fa-plus me-1"></i> New Household</button>
                </div>
            </div>
            <div class="row" id="hh-view" style="display:none;">
                <div class="col-md-12 mb-3"><button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('hh-view').style.display='none'; document.getElementById('hh-list-container').style.display='block';"><i class="fas fa-arrow-left me-1"></i> Back to List</button></div>
                <div class="col-md-4">
                    <div class="card card-custom p-3">
                        <h4 id="view-hh-title" class="mb-3" style="font-family:'Plus Jakarta Sans'; font-weight:700; color:var(--accent-blue);"></h4>
                        <p class="mb-1"><strong>Purok:</strong> <span id="view-hh-purok">-</span></p>
                        <p class="mb-3"><strong>House No:</strong> <span id="view-hh-num">-</span></p>
                        <input type="hidden" id="manage-hh-name">
                        <button class="btn btn-primary w-100 mb-2" onclick="showAddMemberModal()"><i class="fas fa-user-plus me-1"></i> Add Member</button>
                        <div class="d-grid gap-2 mb-3"><button class="btn btn-outline-dark" onclick="printFormA()"><i class="fas fa-print me-1"></i> Print Form A (Household)</button></div>
                        <div class="border-top pt-3">
                            <label class="small text-muted mb-2">Manage Household</label>
                            <button class="btn btn-warning w-100 mb-2 btn-sm" onclick="showEditHHModal()"><i class="fas fa-edit me-1"></i> Edit Details</button>
                            <button class="btn btn-danger w-100 btn-sm" onclick="deleteHH()"><i class="fas fa-trash me-1"></i> Delete Household</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card card-custom p-3">
                        <h5 style="font-family:'Plus Jakarta Sans'; font-weight:700;">Members</h5>
                        <table class="table table-bordered table-hover"><thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead><tbody id="hh-members-body"></tbody></table>
                    </div>
                </div>
            </div>
            <div id="hh-list-container">
                <input type="text" id="hh-search-input" class="form-control mb-3" style="max-width:400px;" placeholder="Search Household..." onkeyup="debouncedFilterHHList()">
                <ul class="list-group" id="hh-list"></ul>
                <div class="pagination-controls" id="hh-pagination">
                    <button class="btn btn-outline-secondary" id="btn-hh-prev" onclick="hhPrevPage()" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                    <span class="page-info" id="hh-page-info">Page 1 of 1</span>
                    <button class="btn btn-outline-secondary" id="btn-hh-next" onclick="hhNextPage()" disabled>Next <i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </div>

        <div id="section-deaths" class="d-none">
             <div class="page-title" style="color:var(--accent-red);">Death Registry <span class="badge bg-danger rounded-pill" id="death-total" style="font-size:0.9rem;">0</span></div>
             <div class="page-subtitle">List of deceased barangay residents</div>
             <div class="row" id="death-list"></div>
             <div class="pagination-controls" id="death-pagination">
                <button class="btn btn-outline-secondary" id="btn-death-prev" onclick="deathPrevPage()" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <span class="page-info" id="death-page-info">Page 1 of 1</span>
                <button class="btn btn-outline-secondary" id="btn-death-next" onclick="deathNextPage()" disabled>Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="section-import" class="d-none">
            <div class="page-title">Data Import / Export</div>
            <div class="page-subtitle">Backup, restore, or export data in BIMS format</div>
            <div class="row g-4 mt-2">
                <div class="col-md-6">
                    <div class="card card-custom p-4 h-100">
                        <h4 style="font-family:'Plus Jakarta Sans'; font-weight:700;"><i class="fas fa-file-excel" style="color:var(--accent-green);"></i> Export Data</h4>
                        <p class="text-muted">Download database compatible with DILG BIMS (Excel format).</p>
                        <button class="btn btn-success" onclick="processExport()">Download BIMS Excel</button>
                        <hr>
                        <h4 style="font-family:'Plus Jakarta Sans'; font-weight:700;"><i class="fas fa-database" style="color:var(--accent-blue);"></i> System Backup</h4>
                        <p class="text-muted">Full system backup (JSON) including settings and logs.</p>
                        <button class="btn btn-primary" onclick="backupData()">Download Backup</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card card-custom p-4 h-100">
                        <h4 style="font-family:'Plus Jakarta Sans'; font-weight:700;"><i class="fas fa-upload" style="color:var(--accent-amber);"></i> Import Data</h4>
                        <p class="text-muted">Restore from Backup or Import BIMS Excel.</p>
                        <input type="file" id="import-file" class="form-control mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning" onclick="previewImport()">Process BIMS Excel</button>
                            <input type="file" id="restore-file" class="d-none" onchange="restoreData(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()">Restore JSON Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-settings" class="d-none">
            <div class="page-title">System Configuration</div>
            <div class="page-subtitle">Configure barangay details and signatories</div>
            <div class="card card-custom p-4 mt-3" style="max-width: 600px;">
                <div class="mb-3"><label>LGU Type</label><select id="set-lgu-type" class="form-select"><option value="MUNICIPALITY">MUNICIPALITY</option><option value="CITY">CITY</option></select></div>
                <div class="mb-3"><label>Region</label><input type="text" id="set-region" class="form-control text-uppercase" placeholder="e.g. REGION II"></div>
                <div class="mb-3"><label>Province</label><input type="text" id="set-prov" class="form-control text-uppercase"></div>
                <div class="mb-3"><label>Municipality/City</label><input type="text" id="set-muni" class="form-control text-uppercase"></div>
                <div class="mb-3"><label>Barangay</label><input type="text" id="set-brgy" class="form-control text-uppercase"></div>
                <div class="mb-3"><label>Punong Barangay (Signatory)</label><input type="text" id="set-captain" class="form-control text-uppercase" placeholder="Full Name of Captain"></div>
                <div class="mb-3"><label>Barangay Secretary (Signatory)</label><input type="text" id="set-sec" class="form-control text-uppercase" placeholder="Full Name of Secretary"></div>
                <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save me-1"></i> Save Configuration</button>
            </div>
        </div>

        <div id="section-other" class="d-none">
            <div class="page-title">Other Systems</div>
            <div class="page-subtitle">Additional barangay management modules</div>
            <div class="row g-4 mt-2">
                <div class="col-md-4">
                    <div class="system-card">
                        <div class="sale-badge"><i class="fas fa-tag me-1"></i> AVAILABLE SOON</div>
                        <div class="system-img"><i class="fas fa-balance-scale"></i></div>
                        <div class="system-body">
                            <h5>Katarungang Pambarangay</h5>
                            <p class="text-muted small mb-2">Barangay justice system case management, mediation tracking, and settlement documentation.</p>
                            <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                <span class="badge" style="background:rgba(37,99,235,0.1); color:var(--accent-blue);">Case Filing</span>
                                <span class="badge" style="background:rgba(5,150,105,0.1); color:var(--accent-green);">Mediation</span>
                                <span class="badge" style="background:rgba(124,58,237,0.1); color:var(--accent-purple);">Settlement</span>
                            </div>
                            <button class="btn btn-outline-secondary w-100 mt-3" disabled><i class="fas fa-lock me-1"></i> Coming Soon</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-new-hh" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Create New Household</h5></div><div class="modal-body"><label>Household Name (Family Name)</label><input type="text" id="new-hh-name" class="form-control text-uppercase mb-2"><label>Purok</label><input type="text" id="new-hh-purok" class="form-control text-uppercase mb-2"><label>House Number</label><input type="text" id="new-hh-num" class="form-control text-uppercase"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="createHH()">Create</button></div></div></div></div>

    <div class="modal fade" id="modal-edit-hh" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Edit Household Details</h5></div><div class="modal-body"><input type="hidden" id="edit-hh-old-name"><label>Household Name (Family Name)</label><input type="text" id="edit-hh-name" class="form-control text-uppercase mb-2"><label>Purok</label><input type="text" id="edit-hh-purok" class="form-control text-uppercase mb-2"><label>House Number</label><input type="text" id="edit-hh-num" class="form-control text-uppercase"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-success" onclick="saveEditedHH()">Save Changes</button></div></div></div></div>

    <div class="modal fade" id="modal-add-mem" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Add Member to Household</h5></div><div class="modal-body"><input type="text" id="search-mem-hh" class="form-control mb-2" placeholder="Search Resident..." onkeyup="debouncedSearchMemForHH()"><div class="list-group" id="hh-search-results" style="max-height: 300px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('modal-add-mem')">Close</button></div></div></div></div>

    <div class="modal fade" id="modal-select-role" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5>Select Role</h5></div><div class="modal-body"><input type="hidden" id="temp-mem-id"><select id="select-role-input" class="form-select"><option value="HEAD">HEAD OF FAMILY</option><option value="SPOUSE">SPOUSE</option><option value="SON">SON</option><option value="DAUGHTER">DAUGHTER</option><option value="MEMBER">MEMBER (Other)</option></select></div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="confirmAddToHH()">Add</button></div></div></div></div>

    <div class="modal" id="modal-import" tabindex="-1" style="background:rgba(0,0,0,0.5);"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5>Import Preview</h5></div><div class="modal-body"><ul class="nav nav-tabs mb-3"><li class="nav-item"><a class="nav-link active" onclick="showImportTab('valid')" href="#">Valid (<span id="count-valid">0</span>)</a></li><li class="nav-item"><a class="nav-link text-warning" onclick="showImportTab('dup')" href="#">Duplicates (<span id="count-dup">0</span>)</a></li><li class="nav-item"><a class="nav-link text-danger" onclick="showImportTab('invalid')" href="#">Invalid (<span id="count-invalid">0</span>)</a></li></ul><div id="view-valid" class="import-view" style="max-height:300px; overflow-y:auto;"><p class="text-success">Ready to import <span id="lbl-valid-count">0</span> records.</p></div><div id="view-dup" class="import-view d-none" style="max-height:300px; overflow-y:auto;"><div id="list-dup" class="text-warning small"></div></div><div id="view-invalid" class="import-view d-none" style="max-height:300px; overflow-y:auto;"><div id="list-invalid" class="text-danger small"></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button><button class="btn btn-success" id="btn-commit-import" onclick="commitImport()" disabled>Import Valid Records</button></div></div></div></div>

    <div class="modal fade" id="modal-age-range" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 style="font-family:'Plus Jakarta Sans'; font-weight:700;"><i class="fas fa-sliders-h me-2" style="color:var(--accent-blue);"></i>Print by Age Range</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="row g-3">
                <div class="col-12"><label class="fw-bold">Age Unit</label><select id="age-unit" class="form-select" onchange="toggleAgeUnit()"><option value="years">Years</option><option value="months">Months (0-11 months old)</option></select></div>
                <div class="col-6" id="age-years-min-container"><label class="fw-bold">Minimum Age (Years)</label><input type="number" id="age-min" class="form-control" value="0" min="0" max="150"></div>
                <div class="col-6" id="age-years-max-container"><label class="fw-bold">Maximum Age (Years)</label><input type="number" id="age-max" class="form-control" value="100" min="0" max="150"></div>
                <div class="col-6 d-none" id="age-months-min-container"><label class="fw-bold">Minimum Months</label><select id="age-months-min" class="form-select"><option value="0">0 months</option><option value="1">1 month</option><option value="2">2 months</option><option value="3">3 months</option><option value="4">4 months</option><option value="5">5 months</option><option value="6">6 months</option><option value="7">7 months</option><option value="8">8 months</option><option value="9">9 months</option><option value="10">10 months</option><option value="11">11 months</option></select></div>
                <div class="col-6 d-none" id="age-months-max-container"><label class="fw-bold">Maximum Months</label><select id="age-months-max" class="form-select"><option value="0">0 months</option><option value="1">1 month</option><option value="2">2 months</option><option value="3">3 months</option><option value="4">4 months</option><option value="5">5 months</option><option value="6">6 months</option><option value="7">7 months</option><option value="8">8 months</option><option value="9">9 months</option><option value="10">10 months</option><option value="11" selected>11 months</option></select></div>
                <div class="col-12"><label class="fw-bold">Filter by Sex</label><select id="age-sex-filter" class="form-select"><option value="ALL">ALL</option><option value="MALE">MALE ONLY</option><option value="FEMALE">FEMALE ONLY</option></select></div>
            </div>
            <div class="mt-3 p-3" style="background:#f8fafc; border-radius:var(--radius-sm); border:1px solid var(--border-color);"><small class="text-muted">Will print up to 100 records per page batch.</small></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="printAgeRange()"><i class="fas fa-print me-1"></i> Print</button></div>
    </div></div></div>

    <div class="modal fade" id="modal-print-category" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 style="font-family:'Plus Jakarta Sans'; font-weight:700;" id="print-cat-title"><i class="fas fa-print me-2" style="color:var(--accent-blue);"></i>Print Records</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div><span class="text-muted">Total records: </span><strong id="print-cat-total">0</strong><span class="ms-3 text-muted">Showing page: </span><strong id="print-cat-page-label">1</strong></div>
                <div class="d-flex gap-2"><button class="btn btn-sm btn-outline-secondary" id="btn-cat-prev" onclick="printCatPrev()"><i class="fas fa-chevron-left"></i> Prev</button><button class="btn btn-sm btn-outline-secondary" id="btn-cat-next" onclick="printCatNext()">Next <i class="fas fa-chevron-right"></i></button></div>
            </div>
            <div style="max-height: 400px; overflow-y: auto;"><table class="print-preview-table" id="print-cat-table"><thead><tr><th>#</th><th>Name</th><th>Sex</th><th>Age</th><th>Civil Status</th><th>Address</th></tr></thead><tbody id="print-cat-body"></tbody></table></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" onclick="executePrintCategory()"><i class="fas fa-print me-1"></i> Print This Page (100 max)</button></div>
    </div></div></div>

    <div class="modal fade" id="custom-alert-modal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content text-center p-3">
                <div class="mb-2"><i class="fas fa-info-circle fa-2x text-primary"></i></div>
                <h6 class="fw-bold mb-2" id="custom-alert-title">System Alert</h6>
                <p class="small text-muted mb-3" id="custom-alert-msg"></p>
                <button type="button" class="btn btn-sm btn-primary w-100" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-bulk-formb" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 style="font-family:'Plus Jakarta Sans'; font-weight:700;"><i class="fas fa-file-alt me-2" style="color:var(--accent-green);"></i>Bulk Print RBI Form B</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Print up to <strong>200 Form B documents</strong> at a time. Documents will be printed with page breaks for easy separation.</div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div><span class="text-muted">Total residents: </span><strong id="bulk-formb-total">0</strong><span class="ms-3 text-muted">Batch: </span><strong id="bulk-formb-batch-label">1 of 1</strong><span class="ms-3 text-muted">Showing: </span><strong id="bulk-formb-range">1-200</strong></div>
                <div class="d-flex gap-2"><button class="btn btn-sm btn-outline-secondary" id="btn-bulk-prev" onclick="bulkFormBPrev()"><i class="fas fa-chevron-left"></i> Prev Batch</button><button class="btn btn-sm btn-outline-secondary" id="btn-bulk-next" onclick="bulkFormBNext()">Next Batch <i class="fas fa-chevron-right"></i></button></div>
            </div>
            <div class="bulk-formb-preview" id="bulk-formb-list"></div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-success" onclick="executeBulkFormBPrint()"><i class="fas fa-print me-1"></i> Print This Batch (200 max)</button></div>
    </div></div></div>

    <div id="print-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- GLOBAL STATE & DATABASE ---
        const iDB = new Dexie('RBI_DB_2026');
        iDB.version(1).stores({
            residents: 'id, last, hh_name',
            households: 'name'
        });

        let db = [];
        let household_db = [];
        let settings = JSON.parse(localStorage.getItem('rbi_settings')) || { user_password: null, barangay: '', province: '', municipality: '', secretary: '', region: '', captain: '', lguType: 'MUNICIPALITY' };
        
        let stagingValid = [], stagingInvalid = [], stagingDup = [];
        let printCatData = [], printCatPage = 0, printCatLabel = '';
        let residentPage = 0, residentPerPage = 10, residentFiltered = [];
        let hhPage = 0, hhPerPage = 10, hhFiltered = [];
        let deathPage = 0, deathPerPage = 10;
        let bulkFormBData = [], bulkFormBPage = 0, bulkFormBPerPage = 200;

        // Debounce function (400ms delay)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedRenderList = debounce(() => { residentPage = 0; renderList(); }, 400);
        const debouncedSearchMother = debounce((val) => searchMother(val), 400);
        const debouncedFilterHHList = debounce(() => { hhPage = 0; renderHHList(); }, 400);
        const debouncedSearchMemForHH = debounce(() => searchMemForHH(), 400);

        function showSystemAlert(message, title = "System Notification") {
            document.getElementById('custom-alert-msg').innerText = message;
            document.getElementById('custom-alert-title').innerText = title;
            new bootstrap.Modal(document.getElementById('custom-alert-modal')).show();
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const oldDB = localStorage.getItem('rbi_db');
            const oldHH = localStorage.getItem('rbi_hh_db');

            if (oldDB) {
                try {
                    await iDB.residents.bulkPut(JSON.parse(oldDB));
                    localStorage.removeItem('rbi_db');
                } catch(e) { console.error("Migration Error", e); }
            }
            if (oldHH) {
                try {
                    await iDB.households.bulkPut(JSON.parse(oldHH));
                    localStorage.removeItem('rbi_hh_db');
                } catch(e) { console.error("Migration Error", e); }
            }

            await refreshData();

            if(settings.user_password) { document.getElementById('login-phase-1').classList.add('d-none'); document.getElementById('login-phase-2').classList.add('d-none'); document.getElementById('login-phase-3').classList.remove('d-none'); }
            else { document.getElementById('login-phase-1').classList.remove('d-none'); document.getElementById('login-phase-2').classList.add('d-none'); document.getElementById('login-phase-3').classList.add('d-none'); }
            updateServerTime(); renderList();
        });

        async function refreshData() {
            db = await iDB.residents.toArray();
            household_db = await iDB.households.toArray();
            updateReportUI();
        }

        function updateServerTime() { const now = new Date(); document.getElementById('server-time-display').innerText = `System Time: ${now.toLocaleString()}`; }
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); return Math.ceil((((d - yearStart) / 86400000) + 1)/7); }
        function numToLetter(num) { let s = ''; while(num > 0) { let t = (num - 1) % 26; s = String.fromCharCode(97 + t) + s; num = Math.floor((num - 1) / 26); } return s; }
        function checkDynamic() {
            const input = document.getElementById('dynamic-code').value;
            const now = new Date(); const month = now.getMonth(); const day = now.getDate(); const year = now.getFullYear();
            const week = getWeekNumber(now) * 2; const dayLetter = numToLetter(day); const hours = now.getHours();
            const ampm = hours >= 12 ? 'mp' : 'ma'; const hourLetter = String.fromCharCode(97 + hours);
            const code = `RBI-${month}${day}${year}${week}${dayLetter}${ampm}${hourLetter}`;
            if(input === code) { document.getElementById('login-phase-1').classList.add('d-none'); document.getElementById('login-phase-2').classList.remove('d-none'); }
            else { showSystemAlert("Incorrect Access Code."); }
        }
        function setCustomPassword() {
            const p1 = document.getElementById('new-custom-pass').value; const p2 = document.getElementById('confirm-custom-pass').value;
            if(!p1 || p1 !== p2) return showSystemAlert("Passwords do not match or are empty.");
            settings.user_password = p1; localStorage.setItem('rbi_settings', JSON.stringify(settings));
            showSystemAlert("Password set successfully!"); document.getElementById('security-overlay').classList.add('d-none');
        }
        function verifyCustomPassword() {
            const input = document.getElementById('input-custom-pass').value;
            if(input === settings.user_password) { document.getElementById('security-overlay').classList.add('d-none'); document.getElementById('main-container').classList.remove('d-none'); document.querySelector('.sidebar').style.display = 'block'; }
            else { showSystemAlert("Incorrect Password."); }
        }
        function forgotPassword() { document.getElementById('login-phase-2').classList.add('d-none'); document.getElementById('login-phase-3').classList.add('d-none'); document.getElementById('login-phase-1').classList.remove('d-none'); showSystemAlert("Please enter the Dynamic Access Code to reset your password."); }
        function logout() { document.getElementById('main-container').classList.add('d-none'); document.querySelector('.sidebar').style.display = 'none'; document.getElementById('security-overlay').classList.remove('d-none'); document.getElementById('login-phase-1').classList.add('d-none'); document.getElementById('login-phase-2').classList.add('d-none'); document.getElementById('login-phase-3').classList.remove('d-none'); document.getElementById('input-custom-pass').value = ''; }

        function hideAll() { ['section-home','section-add','section-hh','section-import','section-settings','section-deaths','section-other'].forEach(id => { document.getElementById(id).classList.add('d-none'); }); document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); }
        function showHome() { hideAll(); document.getElementById('section-home').classList.remove('d-none'); residentPage = 0; renderList(); }
        function showAdd() { hideAll(); document.getElementById('section-add').classList.remove('d-none'); clearForm(); }
        function showHouseholds() { hideAll(); document.getElementById('section-hh').classList.remove('d-none'); hhPage = 0; renderHHList(); }
        function showImport() { hideAll(); document.getElementById('section-import').classList.remove('d-none'); }
        function showOtherSystems() { hideAll(); document.getElementById('section-other').classList.remove('d-none'); }
        function showSettings() { hideAll(); document.getElementById('section-settings').classList.remove('d-none'); document.getElementById('set-lgu-type').value = settings.lguType || 'MUNICIPALITY'; document.getElementById('set-region').value = settings.region || ''; document.getElementById('set-prov').value = settings.province || ''; document.getElementById('set-muni').value = settings.municipality || ''; document.getElementById('set-brgy').value = settings.barangay || ''; document.getElementById('set-captain').value = settings.captain || ''; document.getElementById('set-sec').value = settings.secretary || ''; }
        function showDeaths() { hideAll(); document.getElementById('section-deaths').classList.remove('d-none'); deathPage = 0; renderDeathList(); }

        function calculateAgeDetailed(bdate) { 
            if(!bdate) return { y: 0, m: 0, d: 0, totalMonths: 0 }; 
            const birth = new Date(bdate); const now = new Date(); 
            let years = now.getFullYear() - birth.getFullYear(); 
            let months = now.getMonth() - birth.getMonth(); 
            let days = now.getDate() - birth.getDate(); 
            if (days < 0) { months--; days += 30; } 
            if (months < 0) { years--; months += 12; } 
            return { y: years, m: months, d: days, totalMonths: (years * 12) + months }; 
        }

        function searchMother(val) { const list = document.getElementById('mother-search-results'); if(!val || val.length < 2) { list.classList.add('d-none'); return; } const matches = db.filter(r => r.sex === 'FEMALE' && !r.isDead && (r.last + ' ' + r.first).toLowerCase().includes(val.toLowerCase())); list.innerHTML = ''; if(matches.length > 0) { matches.forEach(m => { const div = document.createElement('div'); div.className = 'search-item'; div.innerHTML = `<strong>${m.last}, ${m.first}</strong> <small>(${m.middle||'-'})</small>`; div.onclick = () => { document.getElementById('f-m-last').value = m.last; document.getElementById('f-m-first').value = m.first; document.getElementById('f-m-middle').value = m.middle; document.getElementById('mother-search-input').value = ''; list.classList.add('d-none'); }; list.appendChild(div); }); list.classList.remove('d-none'); } else { list.classList.add('d-none'); } }

        async function saveRecord() {
            const id = document.getElementById('rec-id').value; const last = document.getElementById('f-last').value; const first = document.getElementById('f-first').value; const bdate = document.getElementById('f-bdate').value;
            if(!last || !first || !bdate) return showSystemAlert('Last Name, First Name, and Birthdate are required.');
            if(!id) { const exists = db.some(x => x.last.toLowerCase() === last.toLowerCase() && x.first.toLowerCase() === first.toLowerCase() && x.bdate === bdate); if(exists) return showSystemAlert('Resident already exists!'); }
            const currentRec = id ? db.find(x=>x.id===id) : null;
            const record = { id: id || Date.now().toString(), type: document.getElementById('f-type').value, last: last, first: first, middle: document.getElementById('f-middle').value, suffix: document.getElementById('f-suffix').value, bdate: bdate, sex: document.getElementById('f-sex').value, civil: document.getElementById('f-civil').value, religion: document.getElementById('f-religion').value, citizen: document.getElementById('f-citizen').value, philsys: document.getElementById('f-philsys').value, bplace: document.getElementById('f-bplace').value, prof: document.getElementById('f-prof').value, mother_last: document.getElementById('f-m-last').value, mother_first: document.getElementById('f-m-first').value, mother_middle: document.getElementById('f-m-middle').value, isVoter: document.getElementById('f-voter').checked, isSoloParent: document.getElementById('f-solo').checked, isPwd: document.getElementById('f-pwd').checked, isOfw: document.getElementById('f-ofw').checked, isIp: document.getElementById('f-ip').checked, isOsc: document.getElementById('f-osc').checked, isOSY: document.getElementById('f-osy').checked, isUnemployed: document.getElementById('f-unemployed').checked, isDead: document.getElementById('f-dead').checked, deathDate: document.getElementById('f-death-date').value, contact: document.getElementById('f-contact').value, email: document.getElementById('f-email').value, edu: document.getElementById('f-edu').value, address: document.getElementById('f-address').value, hh_name: currentRec ? currentRec.hh_name : '', hh_role: currentRec ? currentRec.hh_role : 'MEMBER' };
            
            await iDB.residents.put(record);
            await refreshData();
            
            showSystemAlert('Saved Successfully!'); if(record.isDead) showDeaths(); else showHome();
        }

        function loadRecord(id) {
            const r = db.find(x => x.id === id); if(!r) return; showAdd();
            document.getElementById('rec-id').value = r.id; document.getElementById('f-type').value = r.type; document.getElementById('f-last').value = r.last; document.getElementById('f-first').value = r.first; document.getElementById('f-middle').value = r.middle; document.getElementById('f-suffix').value = r.suffix; document.getElementById('f-bdate').value = r.bdate; document.getElementById('f-sex').value = r.sex; document.getElementById('f-civil').value = r.civil; document.getElementById('f-religion').value = r.religion || ''; document.getElementById('f-citizen').value = r.citizen || 'FILIPINO'; document.getElementById('f-philsys').value = r.philsys || ''; document.getElementById('f-bplace').value = r.bplace || ''; document.getElementById('f-prof').value = r.prof || ''; document.getElementById('f-m-last').value = r.mother_last || ''; document.getElementById('f-m-first').value = r.mother_first || ''; document.getElementById('f-m-middle').value = r.mother_middle || ''; document.getElementById('f-voter').checked = r.isVoter || false; document.getElementById('f-solo').checked = r.isSoloParent || false; document.getElementById('f-pwd').checked = r.isPwd || false; document.getElementById('f-ofw').checked = r.isOfw || false; document.getElementById('f-ip').checked = r.isIp || false; document.getElementById('f-osc').checked = r.isOsc || false; document.getElementById('f-osy').checked = r.isOSY || false; document.getElementById('f-unemployed').checked = r.isUnemployed || false; document.getElementById('f-dead').checked = r.isDead || false; document.getElementById('f-death-date').value = r.deathDate || ''; toggleDeathInput(); document.getElementById('f-contact').value = r.contact || ''; document.getElementById('f-email').value = r.email || ''; document.getElementById('f-edu').value = r.edu || ''; document.getElementById('f-address').value = r.address || '';
            let hhTxt = r.hh_name ? r.hh_name : 'No Household Assigned'; if(r.hh_name && r.hh_role) hhTxt += ` (${r.hh_role})`; document.getElementById('f-hh-display').innerText = hhTxt; document.getElementById('btn-del').style.display = 'inline-block';
        }

        async function deleteRecord() { if(!confirm("Are you sure?")) return; const id = document.getElementById('rec-id').value; 
            await iDB.residents.delete(id);
            await refreshData();
            showHome(); 
        }

        function clearForm() { document.querySelectorAll('#section-add input').forEach(i => i.value = ''); document.querySelectorAll('#section-add select').forEach(s => s.selectedIndex = 0); document.querySelectorAll('#section-add input[type=checkbox]').forEach(c => c.checked = false); document.getElementById('f-citizen').value = 'FILIPINO'; document.getElementById('f-religion').value = ''; document.getElementById('btn-del').style.display = 'none'; document.getElementById('mother-search-results').classList.add('d-none'); toggleDeathInput(); }
        function toggleDeathInput() { const isDead = document.getElementById('f-dead').checked; const container = document.getElementById('death-date-container'); if(isDead) container.classList.remove('d-none'); else { container.classList.add('d-none'); document.getElementById('f-death-date').value = ''; } }

        function renderList() {
            const q = document.getElementById('search-input').value.toLowerCase(); const list = document.getElementById('record-list'); list.innerHTML = '';
            residentFiltered = db.filter(r => { const fullName = (r.last + ' ' + r.first + ' ' + (r.middle||'')).toLowerCase(); const hh = (r.hh_name || '').toLowerCase(); return (fullName.includes(q) || hh.includes(q)) && !r.isDead; });
            const totalPages = Math.ceil(residentFiltered.length / residentPerPage); const start = residentPage * residentPerPage; const end = Math.min(start + residentPerPage, residentFiltered.length); const pageData = residentFiltered.slice(start, end);
            if(residentFiltered.length === 0) { list.innerHTML = '<div class="text-center p-4 text-muted">No residents found.</div>'; }
            pageData.forEach(r => { const age = calculateAgeDetailed(r.bdate).y; const item = document.createElement('div'); item.className = 'record-card'; item.onclick = () => loadRecord(r.id);
                let badges = ''; if(r.isVoter) badges += '<span class="badge bg-indigo text-white me-1" style="background:#4f46e5;">VOTER</span>'; if(r.isPwd) badges += '<span class="badge bg-danger me-1">PWD</span>'; if(r.isSoloParent) badges += '<span class="badge bg-info text-dark me-1">SOLO</span>'; if(r.isOSY) badges += '<span class="badge bg-secondary me-1">OSY</span>'; if(r.isOfw) badges += '<span class="badge bg-primary me-1">OFW</span>';
                item.innerHTML = `<div class="d-flex justify-content-between align-items-center"><div><h6 class="fw-bold mb-0" style="font-family:'Plus Jakarta Sans';">${r.last}, ${r.first} ${r.suffix || ''}</h6><small class="text-muted">${r.sex} | ${age} y/o | ${r.civil}</small><br>${r.hh_name ? `<span class="badge" style="background:rgba(37,99,235,0.1); color:var(--accent-blue);"><i class="fas fa-home"></i> ${r.hh_name}</span>` : '<span class="badge" style="background:#f1f5f9; color:#94a3b8;">No HH</span>'} ${badges}</div><div class="no-print"><button class="btn btn-sm btn-outline-dark" onclick="event.stopPropagation(); printFormB('${r.id}')"><i class="fas fa-print"></i> Form B</button></div></div>`;
                list.appendChild(item); });
            document.getElementById('resident-page-info').innerText = `Page ${residentPage + 1} of ${totalPages || 1} (${residentFiltered.length} total)`;
            document.getElementById('btn-res-prev').disabled = residentPage === 0; document.getElementById('btn-res-next').disabled = end >= residentFiltered.length;
            updateReportUI();
        }
        function residentPrevPage() { if(residentPage > 0) { residentPage--; renderList(); } }
        function residentNextPage() { if((residentPage + 1) * residentPerPage < residentFiltered.length) { residentPage++; renderList(); } }

        function renderDeathList() {
            const list = document.getElementById('death-list'); list.innerHTML = ''; const dead = db.filter(r => r.isDead); document.getElementById('death-total').innerText = dead.length;
            const totalPages = Math.ceil(dead.length / deathPerPage); const start = deathPage * deathPerPage; const end = Math.min(start + deathPerPage, dead.length); const pageData = dead.slice(start, end);
            if(dead.length === 0) { list.innerHTML = '<div class="col-12 text-center text-muted p-4">No records found.</div>'; }
            pageData.forEach(r => { list.innerHTML += `<div class="col-md-4 mb-3"><div class="card card-custom p-3" style="border-left:4px solid var(--accent-red); cursor:pointer;" onclick="loadRecord('${r.id}')"><div class="d-flex justify-content-between align-items-center"><div><h6 class="fw-bold mb-0" style="color:var(--accent-red);">${r.last}, ${r.first}</h6><small class="text-muted">Died: ${r.deathDate || 'N/A'}</small></div><i class="fas fa-edit text-secondary"></i></div></div></div>`; });
            document.getElementById('death-page-info').innerText = `Page ${deathPage + 1} of ${totalPages || 1} (${dead.length} total)`;
            document.getElementById('btn-death-prev').disabled = deathPage === 0; document.getElementById('btn-death-next').disabled = end >= dead.length;
        }
        function deathPrevPage() { if(deathPage > 0) { deathPage--; renderDeathList(); } }
        function deathNextPage() { const dead = db.filter(r => r.isDead); if((deathPage + 1) * deathPerPage < dead.length) { deathPage++; renderDeathList(); } }

        function renderHHList() {
            const q = document.getElementById('hh-search-input') ? document.getElementById('hh-search-input').value.toLowerCase() : ''; const list = document.getElementById('hh-list'); list.innerHTML = '';
            let existingNames = new Set(db.map(r => r.hh_name).filter(n => n && n.trim() !== '')); let hhObjects = household_db.filter(h => h && h.name); let hhMap = {}; hhObjects.forEach(h => hhMap[h.name] = h);
            let allNames = new Set([...existingNames, ...hhObjects.map(h => h.name)]); let sortedNames = [...allNames].sort();
            hhFiltered = sortedNames.filter(name => name.toLowerCase().includes(q));
            const totalPages = Math.ceil(hhFiltered.length / hhPerPage); const start = hhPage * hhPerPage; const end = Math.min(start + hhPerPage, hhFiltered.length); const pageData = hhFiltered.slice(start, end);
            pageData.forEach(hName => { const meta = hhMap[hName] || { purok: '', houseNo: '' }; const li = document.createElement('li'); li.className = 'list-group-item list-group-item-action d-flex justify-content-between'; li.innerHTML = `<div><strong>${hName}</strong><br><small class="text-muted">Purok: ${meta.purok || 'N/A'} | #: ${meta.houseNo || 'N/A'}</small></div><button class="btn btn-sm btn-primary align-self-center">Manage</button>`; li.onclick = () => loadHH(hName, meta.purok, meta.houseNo); list.appendChild(li); });
            document.getElementById('hh-page-info').innerText = `Page ${hhPage + 1} of ${totalPages || 1} (${hhFiltered.length} total)`;
            document.getElementById('btn-hh-prev').disabled = hhPage === 0; document.getElementById('btn-hh-next').disabled = end >= hhFiltered.length;
        }
        function hhPrevPage() { if(hhPage > 0) { hhPage--; renderHHList(); } }
        function hhNextPage() { if((hhPage + 1) * hhPerPage < hhFiltered.length) { hhPage++; renderHHList(); } }
        
        async function createHH() { const name = document.getElementById('new-hh-name').value.toUpperCase(); const purok = document.getElementById('new-hh-purok').value.toUpperCase(); const num = document.getElementById('new-hh-num').value.toUpperCase(); if(!name) return showSystemAlert('Enter Name'); 
            const exists = household_db.some(h => h.name === name); 
            if(!exists) { 
                await iDB.households.put({ name: name, purok: purok, houseNo: num });
                await refreshData();
            } else { showSystemAlert("Household Name already exists in registry."); return; } 
            const modalEl = document.getElementById('modal-new-hh'); const modal = bootstrap.Modal.getInstance(modalEl); modal.hide(); loadHH(name, purok, num); renderHHList(); 
        }

        function loadHH(name, purok, num) { if(!purok || !num) { const meta = household_db.find(h => h.name === name); if(meta) { purok = meta.purok; num = meta.houseNo; } } document.getElementById('manage-hh-name').value = name; document.getElementById('view-hh-title').innerText = name; document.getElementById('view-hh-purok').innerText = purok || 'N/A'; document.getElementById('view-hh-num').innerText = num || 'N/A'; document.getElementById('hh-list-container').style.display = 'none'; document.getElementById('hh-view').style.display = 'flex'; renderHHMembers(name); }
        function showEditHHModal() { const name = document.getElementById('manage-hh-name').value; const meta = household_db.find(h => h.name === name) || { purok: '', houseNo: '' }; document.getElementById('edit-hh-old-name').value = name; document.getElementById('edit-hh-name').value = name; document.getElementById('edit-hh-purok').value = meta.purok; document.getElementById('edit-hh-num').value = meta.houseNo; new bootstrap.Modal(document.getElementById('modal-edit-hh')).show(); }
        
        async function saveEditedHH() { 
            const oldName = document.getElementById('edit-hh-old-name').value; 
            const newName = document.getElementById('edit-hh-name').value.toUpperCase(); 
            const newPurok = document.getElementById('edit-hh-purok').value.toUpperCase(); 
            const newNum = document.getElementById('edit-hh-num').value.toUpperCase(); 
            if(!newName) return showSystemAlert("Household Name cannot be empty"); 
            
            if(oldName !== newName && household_db.some(h => h.name === newName)) { return showSystemAlert("Household Name already exists. Please choose another."); } 
            
            await iDB.households.put({ name: newName, purok: newPurok, houseNo: newNum });
            if(oldName !== newName) {
                await iDB.households.delete(oldName);
                const residentsToUpdate = db.filter(r => r.hh_name === oldName);
                if(residentsToUpdate.length > 0) {
                    residentsToUpdate.forEach(r => r.hh_name = newName);
                    await iDB.residents.bulkPut(residentsToUpdate);
                }
            }
            await refreshData();
            const el = document.getElementById('modal-edit-hh'); const modal = bootstrap.Modal.getInstance(el); if(modal) modal.hide(); loadHH(newName, newPurok, newNum); renderHHList(); showSystemAlert("Household details updated successfully."); 
        }
        
        async function deleteHH() { 
            const name = document.getElementById('manage-hh-name').value; 
            if(!confirm(`Are you sure you want to delete the household "${name}"? \n\nNote: Members will NOT be deleted, but they will be unassigned from this household.`)) return; 
            
            const residentsToUpdate = db.filter(r => r.hh_name === name);
            if(residentsToUpdate.length > 0) {
                residentsToUpdate.forEach(r => { r.hh_name = ''; r.hh_role = ''; });
                await iDB.residents.bulkPut(residentsToUpdate);
            }
            
            await iDB.households.delete(name);
            await refreshData();
            showSystemAlert("Household deleted."); document.getElementById('hh-view').style.display='none'; document.getElementById('hh-list-container').style.display='block'; renderHHList(); 
        }

        function renderHHMembers(hhName) { const tbody = document.getElementById('hh-members-body'); tbody.innerHTML = ''; const mems = db.filter(r => r.hh_name === hhName); mems.forEach(m => { tbody.innerHTML += `<tr><td>${m.last}, ${m.first}</td><td><select onchange="updateRole('${m.id}', this.value)" class="form-select form-select-sm"><option value="HEAD" ${m.hh_role==='HEAD'?'selected':''}>HEAD OF FAMILY</option><option value="SPOUSE" ${m.hh_role==='SPOUSE'?'selected':''}>SPOUSE</option><option value="SON" ${m.hh_role==='SON'?'selected':''}>SON</option><option value="DAUGHTER" ${m.hh_role==='DAUGHTER'?'selected':''}>DAUGHTER</option><option value="MEMBER" ${m.hh_role==='MEMBER'?'selected':''}>MEMBER (Other)</option></select></td><td><button class="btn btn-sm btn-danger" onclick="removeFromHH('${m.id}')">Remove</button></td></tr>`; }); }
        
        async function updateRole(id, role) { const r = db.find(x => x.id === id); if(r) { r.hh_role = role; await iDB.residents.put(r); await refreshData(); } }
        async function removeFromHH(id) { const r = db.find(x => x.id === id); if(r) { r.hh_name = ''; r.hh_role = ''; await iDB.residents.put(r); await refreshData(); renderHHMembers(document.getElementById('manage-hh-name').value); } }
        
        function showAddMemberModal() { new bootstrap.Modal(document.getElementById('modal-add-mem')).show(); }
        function closeModal(id) { const el = document.getElementById(id); const modal = bootstrap.Modal.getInstance(el); if(modal) modal.hide(); }
        function searchMemForHH() { 
            const q = document.getElementById('search-mem-hh').value.toLowerCase(); 
            const res = document.getElementById('hh-search-results'); 
            res.innerHTML = ''; 
            db.filter(r => (!r.hh_name || r.hh_name.trim() === '') && !r.isDead && (r.last+' '+r.first).toLowerCase().includes(q))
              .slice(0,10)
              .forEach(r => { 
                res.innerHTML += `<button class="list-group-item list-group-item-action" onclick="promptRole('${r.id}')">${r.last}, ${r.first}</button>`; 
              }); 
        }
        function promptRole(id) { document.getElementById('temp-mem-id').value = id; closeModal('modal-add-mem'); new bootstrap.Modal(document.getElementById('modal-select-role')).show(); }
        async function confirmAddToHH() { const id = document.getElementById('temp-mem-id').value; const role = document.getElementById('select-role-input').value; const hh = document.getElementById('manage-hh-name').value; const r = db.find(x => x.id === id); if(r) { r.hh_name = hh; r.hh_role = role; await iDB.residents.put(r); await refreshData(); renderHHMembers(hh); closeModal('modal-select-role'); } }

        function generateFormBHTML(r) {
            const chk = (val, target) => (val === target) ? '&#9745;' : '&#9744;'; const edu = r.edu || '';
            let isElem = edu === 'ELEMENTARY'; let isHS = edu === 'HIGH SCHOOL'; let isCol = edu.includes('COLLEGE'); let isPost = edu === 'POST GRAD'; let isVoc = edu === 'VOCATIONAL'; let isGrad = edu.includes('GRADUATE') && !edu.includes('UNDER'); let isUnder = edu.includes('UNDER');
            let hhNum = ''; if (r.hh_name) { const hhObj = household_db.find(h => h.name === r.hh_name); if (hhObj) hhNum = hhObj.houseNo; }
            return `<div class="form-b-container"><div class="form-header"><div style="font-size: 9pt;">RBI Form B (Revised 2024)</div><div class="form-title">INDIVIDUAL RECORDS OF BARANGAY INHABITANT</div></div><table style="width:100%; font-size: 9pt; font-weight: bold; margin-bottom: 10px;"><tr><td width="10%">REGION</td><td width="2%">:</td><td style="border-bottom: 1px solid black;">${settings.region}</td><td width="5%"></td><td width="15%">CITY/MUN</td><td width="2%">:</td><td style="border-bottom: 1px solid black;">${settings.municipality}</td></tr><tr><td>PROVINCE</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.province}</td><td></td><td>BARANGAY</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.barangay}</td></tr></table><div class="main-box"><div class="box-title">PERSONAL INFORMATION</div><table class="layout-table"><tr><td width="30%"><div class="input-box">${r.philsys || ''}</div><div class="label-under">(PhilSys Card No.)</div></td><td width="70%"></td></tr></table><table class="layout-table"><tr><td width="25%"><div class="input-box">${r.last}</div><div class="label-under">(Last Name)</div></td><td width="10%"><div class="input-box">${r.suffix || ''}</div><div class="label-under">(Suffix)</div></td><td width="35%"><div class="input-box">${r.first}</div><div class="label-under">(First Name)</div></td><td width="30%"><div class="input-box">${r.middle || ''}</div><div class="label-under">(Middle Name)</div></td></tr></table><table class="layout-table"><tr><td width="20%"><div class="input-box">${r.bdate}</div><div class="label-under">(Birth Date)</div></td><td width="30%"><div class="input-box">${r.bplace || ''}</div><div class="label-under">(Birth Place)</div></td><td width="10%"><div class="input-box">${r.sex}</div><div class="label-under">(Sex)</div></td><td width="15%"><div class="input-box">${r.civil}</div><div class="label-under">(Civil Status)</div></td><td width="25%"><div class="input-box">${r.religion || ''}</div><div class="label-under">(Religion)</div></td></tr></table><table class="layout-table"><tr><td width="65%"><div class="input-box">${r.address}</div><div class="label-under">(Residence Address)</div></td><td width="35%"><div class="input-box">${r.citizen || 'FILIPINO'}</div><div class="label-under">(Citizenship)</div></td></tr></table><table class="layout-table"><tr><td width="35%"><div class="input-box">${r.prof || ''}</div><div class="label-under">(Profession / Occupation)</div></td><td width="30%"><div class="input-box">${r.contact || ''}</div><div class="label-under">(Contact Number)</div></td><td width="35%"><div class="input-box">${r.email || ''}</div><div class="label-under">(E-mail Address)</div></td></tr></table><hr style="border-top: 1px dashed #ccc; margin: 5px 0;"><div style="font-size: 9pt; padding: 5px;"><strong>HIGHEST EDUCATIONAL ATTAINMENT:</strong><span class="chk-group" style="display:inline-flex;"><span><span class="chk-box">${chk(isElem, true)}</span> ELEMENTARY</span><span><span class="chk-box">${chk(isHS, true)}</span> HIGH SCHOOL</span><span><span class="chk-box">${chk(isCol, true)}</span> COLLEGE</span><span><span class="chk-box">${chk(isPost, true)}</span> POST GRAD</span><span><span class="chk-box">${chk(isVoc, true)}</span> VOCATIONAL</span></span><div style="margin-top:5px; margin-left: 200px;"><em>Please specify:</em> <span class="chk-box" style="margin-left: 10px;">${chk(isGrad, true)}</span> Graduate <span class="chk-box" style="margin-left: 20px;">${chk(isUnder, true)}</span> Under Graduate</div></div><div class="legal-text">I hereby certify that the above information is true and correct to the best of my knowledge. I understand that for the Barangay to carry out its mandate pursuant to Section 394 (d)(6) of the Local Government Code of 1991, they must necessarily process my personal information for easy identification of inhabitants, as a tool in planning, and as an updated reference in the number of inhabitants of the Barangay. Therefore, I grant my consent and recognize the authority of the Barangay to process my personal information, subject to the provision of the Philippine Data Privacy Act of 2012.</div><table style="width:100%; margin-top: 30px; font-size: 9pt;"><tr><td width="40%" style="text-align:center;"><div class="sig-line"></div><div>Date Accomplished</div></td><td width="20%"></td><td width="40%" style="text-align:center;"><div class="sig-line"></div><div>Name/Signature of Person Accomplishing the Form</div></td></tr></table><div style="margin-top: 20px; font-size: 9pt;">Attested By:</div><table style="width:100%; margin-top: 10px; font-size: 9pt;"><tr><td width="40%" style="text-align:center; vertical-align: bottom;"><div class="sig-line" style="font-weight:bold; text-transform:uppercase;">${settings.secretary}</div><div style="font-weight:bold;">Barangay Secretary</div></td><td width="30%" style="text-align:center;"><div class="thumb-box"></div><div style="font-size:8pt;">Left Thumbmark</div></td><td width="30%" style="text-align:center;"><div class="thumb-box"></div><div style="font-size:8pt;">Right Thumbmark</div></td></tr></table><div style="margin-top: 20px; display: flex; align-items: center;"><span style="font-weight:bold; font-size: 9pt; margin-right: 10px;">Household Number:</span><div style="border: 2px solid black; width: 200px; height: 30px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${hhNum}</div></div><div style="font-size: 8pt; font-style: italic; margin-top: 5px;">Note: The household number shall be filled up by the Barangay Secretary.</div></div></div>`;
        }

        function printFormB(id) {
            const r = db.find(x => x.id === id); if (!r) return;
            const formBStyles = `<style>@media print { @page { margin: 10mm; size: portrait; } body { -webkit-print-color-adjust: exact; } } .form-b-container { font-family: Arial, sans-serif; width: 100%; max-width: 800px; margin: 0 auto; color: black; } .form-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; line-height: 1.2; } .form-title { font-weight: 800; font-size: 13pt; margin-top: 15px; } .main-box { border: 2px solid black; padding: 2px; } .box-title { text-align: center; font-weight: bold; padding: 5px; font-size: 11pt; margin-bottom: 10px; } .input-box { border: 1px solid black; height: 25px; display: flex; align-items: center; padding-left: 5px; font-weight: bold; font-size: 10pt; background: #fff; } .label-under { text-align: center; font-size: 8pt; margin-top: 2px; margin-bottom: 5px; } .layout-table { width: 100%; border-collapse: separate; border-spacing: 5px 0; } .layout-table td { vertical-align: bottom; } .chk-group { display: flex; gap: 10px; font-size: 9pt; align-items: center; margin-left: 10px; } .chk-box { font-size: 14pt; line-height: 10pt; } .legal-text { text-align: justify; font-size: 8pt; margin: 15px 5px; line-height: 1.1; } .thumb-box { border: 1px solid black; width: 80px; height: 80px; margin: 0 auto; } .sig-line { border-bottom: 1px solid black; margin-top: 30px; }</style>`;
            document.getElementById('print-area').innerHTML = formBStyles + generateFormBHTML(r);
            window.print();
        }

        function showBulkFormBModal() { bulkFormBData = db.filter(r => !r.isDead).sort((a,b) => a.last.localeCompare(b.last)); bulkFormBPage = 0; renderBulkFormBModal(); new bootstrap.Modal(document.getElementById('modal-bulk-formb')).show(); }
        function renderBulkFormBModal() {
            const total = bulkFormBData.length; const totalBatches = Math.ceil(total / bulkFormBPerPage); const start = bulkFormBPage * bulkFormBPerPage; const end = Math.min(start + bulkFormBPerPage, total); const pageData = bulkFormBData.slice(start, end);
            document.getElementById('bulk-formb-total').innerText = total; document.getElementById('bulk-formb-batch-label').innerText = `${bulkFormBPage + 1} of ${totalBatches || 1}`; document.getElementById('bulk-formb-range').innerText = `${start + 1}-${end}`;
            document.getElementById('btn-bulk-prev').disabled = bulkFormBPage === 0; document.getElementById('btn-bulk-next').disabled = end >= total;
            const list = document.getElementById('bulk-formb-list'); list.innerHTML = '';
            pageData.forEach((r, i) => { const age = calculateAgeDetailed(r.bdate); const ageStr = age.y > 0 ? `${age.y} y/o` : `${age.m} mo`; list.innerHTML += `<div class="bulk-formb-item"><div class="formb-num">${start + i + 1}</div><div class="formb-info"><div class="formb-name">${r.last}, ${r.first} ${r.suffix || ''}</div><div class="formb-meta">${r.sex} | ${ageStr} | ${r.civil} | ${r.hh_name || 'No HH'}</div></div></div>`; });
        }
        function bulkFormBPrev() { if(bulkFormBPage > 0) { bulkFormBPage--; renderBulkFormBModal(); } }
        function bulkFormBNext() { if((bulkFormBPage + 1) * bulkFormBPerPage < bulkFormBData.length) { bulkFormBPage++; renderBulkFormBModal(); } }
        function executeBulkFormBPrint() {
            const start = bulkFormBPage * bulkFormBPerPage; const end = Math.min(start + bulkFormBPerPage, bulkFormBData.length); const pageData = bulkFormBData.slice(start, end);
            if(pageData.length === 0) return showSystemAlert('No records to print.');
            let allFormsHTML = `<style>@media print { @page { margin: 10mm; size: portrait; } body { -webkit-print-color-adjust: exact; } .form-b-page { page-break-after: always; } .form-b-page:last-child { page-break-after: auto; } } .form-b-container { font-family: Arial, sans-serif; width: 100%; max-width: 800px; margin: 0 auto; color: black; } .form-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; line-height: 1.2; } .form-title { font-weight: 800; font-size: 13pt; margin-top: 15px; } .main-box { border: 2px solid black; padding: 2px; } .box-title { text-align: center; font-weight: bold; padding: 5px; font-size: 11pt; margin-bottom: 10px; } .input-box { border: 1px solid black; height: 25px; display: flex; align-items: center; padding-left: 5px; font-weight: bold; font-size: 10pt; background: #fff; } .label-under { text-align: center; font-size: 8pt; margin-top: 2px; margin-bottom: 5px; } .layout-table { width: 100%; border-collapse: separate; border-spacing: 5px 0; } .layout-table td { vertical-align: bottom; } .chk-group { display: flex; gap: 10px; font-size: 9pt; align-items: center; margin-left: 10px; } .chk-box { font-size: 14pt; line-height: 10pt; } .legal-text { text-align: justify; font-size: 8pt; margin: 15px 5px; line-height: 1.1; } .thumb-box { border: 1px solid black; width: 80px; height: 80px; margin: 0 auto; } .sig-line { border-bottom: 1px solid black; margin-top: 30px; }</style>`;
            pageData.forEach((r) => { allFormsHTML += `<div class="form-b-page">${generateFormBHTML(r)}</div>`; });
            document.getElementById('print-area').innerHTML = allFormsHTML; window.print();
        }

        function printFormA() {
            const hhName = document.getElementById('manage-hh-name').value; const purok = document.getElementById('view-hh-purok').innerText; const houseNo = document.getElementById('view-hh-num').innerText;
            const members = db.filter(r => r.hh_name === hhName && !r.isDead);
            members.sort((a, b) => { const roles = { 'HEAD': 1, 'SPOUSE': 2, 'SON': 3, 'DAUGHTER': 4, 'MEMBER': 5 }; const ra = roles[a.hh_role] || 99; const rb = roles[b.hh_role] || 99; if (ra !== rb) return ra - rb; return a.last.localeCompare(b.last); });
            let rowsHtml = ''; members.forEach((m, i) => { let indicators = []; if (m.prof && !m.isUnemployed) indicators.push("Employed"); if (m.isUnemployed) indicators.push("Unemployed"); if (m.isVoter) indicators.push("VOTER"); if (m.isPwd) indicators.push("PWD"); if (m.isOfw) indicators.push("OFW"); if (m.isSoloParent) indicators.push("Solo Parent"); if (m.isOSY) indicators.push("OSY"); if (m.isOsc) indicators.push("OSC"); if (m.isIp) indicators.push("IP");
                rowsHtml += `<tr><td>${i + 1}</td><td>${m.last}</td><td>${m.first}</td><td>${m.middle}</td><td>${m.suffix || ''}</td><td>${m.bplace}</td><td>${m.bdate}</td><td>${calculateAgeDetailed(m.bdate).y}</td><td>${m.sex}</td><td>${m.civil}</td><td>${m.citizen || 'FILIPINO'}</td><td>${m.prof || ''}</td><td>${indicators.join(', ')}</td></tr>`; });
            for (let i = members.length; i < 15; i++) { rowsHtml += `<tr><td>${i + 1}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`; }
            const html = `<div class="landscape-page"><div class="print-header"><strong>RBI FORM A (Revised 2024)</strong><br><strong>RECORDS OF BARANGAY INHABITANTS BY HOUSEHOLD</strong></div><table style="width:100%; margin-bottom: 10px; font-family: Arial; font-size: 10pt;"><tr><td style="border:none; width: 100px;">REGION:</td><td style="border:none; border-bottom: 1px solid black;">${settings.region}</td><td style="border:none; width: 50px;"></td><td style="border:none; width: 150px;">PROVINCE:</td><td style="border:none; border-bottom: 1px solid black;">${settings.province}</td></tr><tr><td style="border:none;">CITY/MUNICIPALITY:</td><td style="border:none; border-bottom: 1px solid black;">${settings.municipality}</td><td style="border:none;"></td><td style="border:none;">BARANGAY:</td><td style="border:none; border-bottom: 1px solid black;">${settings.barangay}</td></tr><tr><td style="border:none;">HOUSEHOLD ADDRESS:</td><td style="border:none; border-bottom: 1px solid black;" colspan="4">PUROK ${purok}, HOUSE NO. ${houseNo}</td></tr><tr><td style="border:none;">NO. OF MEMBERS:</td><td style="border:none; border-bottom: 1px solid black;">${members.length}</td></tr></table><table class="print-table"><thead><tr><th rowspan="2" width="3%">NO.</th><th colspan="4" width="25%">NAME</th><th rowspan="2" width="10%">PLACE OF BIRTH</th><th rowspan="2" width="8%">DATE OF BIRTH</th><th rowspan="2" width="4%">AGE</th><th rowspan="2" width="5%">SEX</th><th rowspan="2" width="8%">CIVIL STATUS</th><th rowspan="2" width="8%">CITIZENSHIP</th><th rowspan="2" width="10%">OCCUPATION</th><th rowspan="2" width="15%">REMARKS / STATUS</th></tr><tr><th>LAST NAME</th><th>FIRST NAME</th><th>MIDDLE NAME</th><th>EXT</th></tr></thead><tbody>${rowsHtml}</tbody></table><div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px; font-family: Arial; page-break-inside: avoid;"><div style="width: 30%; text-align: center;"><p style="text-align: left; margin-bottom: 30px;">Prepared by:</p><div style="border-bottom: 1px solid black; margin-bottom: 5px; height: 1em;"></div><strong>Name of Household/Head Member</strong><br><span style="font-size: 0.8em;">(Signature over Printed Name)</span></div><div style="width: 30%; text-align: center;"><p style="text-align: left; margin-bottom: 30px;">Certified Correct:</p><div style="border-bottom: 1px solid black; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;">${settings.secretary}</div><strong>Barangay Secretary</strong><br><span style="font-size: 0.8em;">(Signature over Printed Name)</span></div><div style="width: 30%; text-align: center;"><p style="text-align: left; margin-bottom: 30px;">Validated by:</p><div style="border-bottom: 1px solid black; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;">${settings.captain}</div><strong>Punong Barangay</strong><br><span style="font-size: 0.8em;">(Signature over Printed Name)</span></div></div></div>`;
            document.getElementById('print-area').innerHTML = html; window.print();
        }

        // --- REPORTING ---
        function updateReportUI() {
            const living = db.filter(r => !r.isDead); const stats = { male: 0, female: 0, adults: 0, children: 0, solo: 0, pwd: 0, senior: 0, osy: 0, voter: 0, total: living.length };
            const totalFamilies = living.filter(r => r.hh_role === 'HEAD').length; const uniqueHH = new Set(living.map(r => r.hh_name).filter(n => n && n.trim() !== '')); const totalHH = uniqueHH.size;
            living.forEach(r => { if(r.sex === 'MALE') stats.male++; else if(r.sex === 'FEMALE') stats.female++; const age = calculateAgeDetailed(r.bdate).y; if(age < 18) stats.children++; else if(age >= 60) stats.senior++; else stats.adults++; if(r.isPwd) stats.pwd++; if(r.isSoloParent) stats.solo++; if(r.isOSY) stats.osy++; if(r.isVoter) stats.voter++; });
            document.getElementById('rep-male').innerText = stats.male; document.getElementById('rep-female').innerText = stats.female; document.getElementById('rep-total').innerText = stats.total; document.getElementById('rep-child').innerText = stats.children; document.getElementById('rep-adult').innerText = stats.adults; document.getElementById('rep-senior').innerText = stats.senior; document.getElementById('rep-pwd').innerText = stats.pwd; document.getElementById('rep-solo').innerText = stats.solo; document.getElementById('rep-osy').innerText = stats.osy; document.getElementById('rep-hh-total').innerText = totalHH; document.getElementById('rep-family-total').innerText = totalFamilies;
            document.getElementById('rep-voters').innerText = stats.voter;
        }

        // --- PRINT STAT CATEGORY ---
        function printStatCategory(category) {
            const living = db.filter(r => !r.isDead); let filtered = []; let label = '';
            switch(category) { case 'total': filtered = living; label = 'ALL RESIDENTS'; break; case 'male': filtered = living.filter(r => r.sex === 'MALE'); label = 'MALE RESIDENTS'; break; case 'female': filtered = living.filter(r => r.sex === 'FEMALE'); label = 'FEMALE RESIDENTS'; break; case 'children': filtered = living.filter(r => calculateAgeDetailed(r.bdate).y < 18); label = 'CHILDREN (Below 18)'; break; case 'adults': filtered = living.filter(r => { const a = calculateAgeDetailed(r.bdate).y; return a >= 18 && a < 60; }); label = 'ADULTS (18-59)'; break; case 'seniors': filtered = living.filter(r => calculateAgeDetailed(r.bdate).y >= 60); label = 'SENIOR CITIZENS (60+)'; break; case 'pwd': filtered = living.filter(r => r.isPwd); label = 'PERSONS WITH DISABILITY (PWD)'; break; case 'solo': filtered = living.filter(r => r.isSoloParent); label = 'SOLO PARENTS'; break; case 'osy': filtered = living.filter(r => r.isOSY); label = 'OUT OF SCHOOL YOUTH (OSY)'; break; case 'voters': filtered = living.filter(r => r.isVoter); label = 'REGISTERED VOTERS'; break; case 'households': printHHHeads(); return; case 'families': filtered = living.filter(r => r.hh_role === 'HEAD'); label = 'HEAD OF FAMILIES'; break; default: filtered = living; label = 'ALL RESIDENTS'; }
            filtered.sort((a,b) => a.last.localeCompare(b.last)); printCatData = filtered; printCatPage = 0; printCatLabel = label; renderPrintCatModal(); new bootstrap.Modal(document.getElementById('modal-print-category')).show();
        }
        function renderPrintCatModal() {
            const perPage = 100; const start = printCatPage * perPage; const end = Math.min(start + perPage, printCatData.length); const pageData = printCatData.slice(start, end); const totalPages = Math.ceil(printCatData.length / perPage);
            document.getElementById('print-cat-title').innerHTML = `<i class="fas fa-print me-2" style="color:var(--accent-blue);"></i>${printCatLabel}`; document.getElementById('print-cat-total').innerText = printCatData.length; document.getElementById('print-cat-page-label').innerText = `${printCatPage + 1} of ${totalPages}`; document.getElementById('btn-cat-prev').disabled = (printCatPage === 0); document.getElementById('btn-cat-next').disabled = (end >= printCatData.length);
            const tbody = document.getElementById('print-cat-body'); tbody.innerHTML = ''; pageData.forEach((r, i) => { const age = calculateAgeDetailed(r.bdate).y; tbody.innerHTML += `<tr><td>${start + i + 1}</td><td>${r.last}, ${r.first} ${r.suffix || ''}</td><td>${r.sex}</td><td>${age}</td><td>${r.civil}</td><td>${r.address || '-'}</td></tr>`; });
        }
        function printCatPrev() { if(printCatPage > 0) { printCatPage--; renderPrintCatModal(); } }
        function printCatNext() { const perPage = 100; if((printCatPage + 1) * perPage < printCatData.length) { printCatPage++; renderPrintCatModal(); } }
        function executePrintCategory() {
            const perPage = 100; const start = printCatPage * perPage; const end = Math.min(start + perPage, printCatData.length); const pageData = printCatData.slice(start, end); const totalPages = Math.ceil(printCatData.length / perPage);
            let rows = pageData.map((r, i) => { const age = calculateAgeDetailed(r.bdate).y; return `<tr><td>${start+i+1}</td><td>${r.last}, ${r.first} ${r.suffix||''}</td><td>${r.sex}</td><td>${age}</td><td>${r.civil}</td><td>${r.address || '-'}</td></tr>`; }).join('');
            const html = `<style>table { width:100%; border-collapse:collapse; font-family:Arial; font-size:10pt; } th,td { border:1px solid black; padding:4px; } h2,h3 { text-align:center; margin:5px; }</style><h2>${printCatLabel}</h2><h3 style="font-size:11pt;">Barangay ${settings.barangay}, ${settings.municipality}, ${settings.province}</h3><p style="text-align:center; font-size:9pt;">Page ${printCatPage+1} of ${totalPages} | Total: ${printCatData.length} records | Printed: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>#</th><th>Name</th><th>Sex</th><th>Age</th><th>Civil Status</th><th>Address</th></tr></thead><tbody>${rows}</tbody></table><br><br><div style="display:flex; justify-content:space-between; font-size:9pt;"><div style="text-align:center; width:40%;"><div style="border-top:1px solid black; padding-top:5px; font-weight:bold;">${settings.secretary || '_______________'}</div>Barangay Secretary</div><div style="text-align:center; width:40%;"><div style="border-top:1px solid black; padding-top:5px; font-weight:bold;">${settings.captain || '_______________'}</div>Punong Barangay</div></div>`;
            document.getElementById('print-area').innerHTML = html; window.print();
        }

        // --- NEW: PRINT AGE RANGE (Updated Logic) ---
        function showAgeRangeModal() { new bootstrap.Modal(document.getElementById('modal-age-range')).show(); toggleAgeUnit(); }
        function toggleAgeUnit() {
            const unit = document.getElementById('age-unit').value;
            if(unit === 'years') {
                document.getElementById('age-years-min-container').classList.remove('d-none');
                document.getElementById('age-years-max-container').classList.remove('d-none');
                document.getElementById('age-months-min-container').classList.add('d-none');
                document.getElementById('age-months-max-container').classList.add('d-none');
            } else {
                document.getElementById('age-years-min-container').classList.add('d-none');
                document.getElementById('age-years-max-container').classList.add('d-none');
                document.getElementById('age-months-min-container').classList.remove('d-none');
                document.getElementById('age-months-max-container').classList.remove('d-none');
            }
        }

        function printAgeRange() {
            const unit = document.getElementById('age-unit').value;
            const sexFilter = document.getElementById('age-sex-filter').value;
            let filtered = db.filter(r => !r.isDead);

            if(sexFilter !== 'ALL') {
                filtered = filtered.filter(r => r.sex === sexFilter);
            }

            let label = "";

            if(unit === 'years') {
                const min = parseInt(document.getElementById('age-min').value);
                const max = parseInt(document.getElementById('age-max').value);
                filtered = filtered.filter(r => {
                    const age = calculateAgeDetailed(r.bdate).y;
                    return age >= min && age <= max;
                });
                label = `RESIDENTS AGED ${min} TO ${max} YEARS OLD`;
            } else {
                const min = parseInt(document.getElementById('age-months-min').value);
                const max = parseInt(document.getElementById('age-months-max').value);
                filtered = filtered.filter(r => {
                    const age = calculateAgeDetailed(r.bdate); // returns {y, m, d, totalMonths}
                    // Logic: Must be 0 years old AND within month range
                    if(age.y > 0) return false; 
                    return age.m >= min && age.m <= max;
                });
                label = `RESIDENTS AGED ${min} TO ${max} MONTHS OLD`;
            }

            if(sexFilter !== 'ALL') label += ` (${sexFilter})`;

            if(filtered.length === 0) return showSystemAlert("No residents found in this range.");
            
            // Close filter modal
            const el = document.getElementById('modal-age-range'); 
            const modal = bootstrap.Modal.getInstance(el); 
            if(modal) modal.hide();

            // Open Print Preview Modal (Reusing existing one for 100 limit support)
            filtered.sort((a,b) => a.last.localeCompare(b.last)); 
            printCatData = filtered; 
            printCatPage = 0; 
            printCatLabel = label; 
            renderPrintCatModal(); 
            new bootstrap.Modal(document.getElementById('modal-print-category')).show();
        }

        // --- FIXED: PRINT STATS (FORM C) ---
        function printStats() {
            // Calculate Data strictly according to Form C layout
            const living = db.filter(r => !r.isDead);
            
            // Age Brackets
            const brackets = [
                { lbl: "Under 5 years old", min:0, max:4 },
                { lbl: "5-9 years old", min:5, max:9 },
                { lbl: "10-14 years old", min:10, max:14 },
                { lbl: "15-19 years old", min:15, max:19 },
                { lbl: "20-24 years old", min:20, max:24 },
                { lbl: "25-29 years old", min:25, max:29 },
                { lbl: "30-34 years old", min:30, max:34 },
                { lbl: "35-39 years old", min:35, max:39 },
                { lbl: "40-44 years old", min:40, max:44 },
                { lbl: "45-49 years old", min:45, max:49 },
                { lbl: "50-54 years old", min:50, max:54 },
                { lbl: "55-59 years old", min:55, max:59 },
                { lbl: "60-64 years old", min:60, max:64 },
                { lbl: "65-69 years old", min:65, max:69 },
                { lbl: "70-74 years old", min:70, max:74 },
                { lbl: "75-79 years old", min:75, max:79 },
                { lbl: "80 years old and over", min:80, max:200 }
            ];

            let bracketData = brackets.map(b => ({ ...b, m:0, f:0 }));

            // Sectors and Status
            let sectors = {
                labor: {m:0, f:0}, // Unemployed (Labor Force logic usually implies 15+, but sticking to simple unemployed flag check for now or specific field)
                unemployed: {m:0, f:0},
                osc: {m:0, f:0},
                osy: {m:0, f:0},
                pwd: {m:0, f:0},
                ofw: {m:0, f:0},
                solo: {m:0, f:0},
                ip: {m:0, f:0},
                single: {m:0, f:0},
                married: {m:0, f:0},
                filipino: {m:0, f:0},
                foreigner: {m:0, f:0}
            };

            // Totals
            const totalInhabitants = living.length;
            const uniqueHH = new Set(living.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            const totalHH = uniqueHH.size;
            const totalFamilies = living.filter(r => r.hh_role === 'HEAD').length;

            living.forEach(r => {
                const age = calculateAgeDetailed(r.bdate).y;
                const isMale = r.sex === 'MALE';
                
                // Age Bracket
                for(let b of bracketData) {
                    if(age >= b.min && age <= b.max) {
                        if(isMale) b.m++; else b.f++;
                        break;
                    }
                }

                // Sectors
                if(r.isUnemployed) { if(isMale) sectors.unemployed.m++; else sectors.unemployed.f++; }
                // Labor force typically defined as employed + unemployed (usually 15+). 
                // For this form, if user marks "Unemployed", they are counted. If they have a profession, they are labor force.
                if(r.isUnemployed || (r.prof && r.prof.length > 1)) { if(isMale) sectors.labor.m++; else sectors.labor.f++; }
                
                if(r.isOsc) { if(isMale) sectors.osc.m++; else sectors.osc.f++; }
                if(r.isOSY) { if(isMale) sectors.osy.m++; else sectors.osy.f++; }
                if(r.isPwd) { if(isMale) sectors.pwd.m++; else sectors.pwd.f++; }
                if(r.isOfw) { if(isMale) sectors.ofw.m++; else sectors.ofw.f++; }
                if(r.isSoloParent) { if(isMale) sectors.solo.m++; else sectors.solo.f++; }
                if(r.isIp) { if(isMale) sectors.ip.m++; else sectors.ip.f++; }

                // Civil
                if(r.civil === 'SINGLE') { if(isMale) sectors.single.m++; else sectors.single.f++; }
                if(r.civil === 'MARRIED') { if(isMale) sectors.married.m++; else sectors.married.f++; }

                // Citizenship
                if(!r.citizen || r.citizen === 'FILIPINO') { if(isMale) sectors.filipino.m++; else sectors.filipino.f++; }
                else { if(isMale) sectors.foreigner.m++; else sectors.foreigner.f++; }
            });

            // GENERATE HTML ROWS
            let ageRows = bracketData.map(b => `<tr><td style="padding-left:20px;">${b.lbl}</td><td>${b.m}</td><td>${b.f}</td><td>${b.m+b.f}</td><td></td></tr>`).join('');

            const sectorRow = (lbl, data) => `<tr><td style="padding-left:0px; font-weight:normal;">${lbl}</td><td>${data.m}</td><td>${data.f}</td><td>${data.m+data.f}</td><td></td></tr>`;
            const sectorRowIndent = (lbl, data) => `<tr><td style="padding-left:20px; font-weight:normal;">${lbl}</td><td>${data.m}</td><td>${data.f}</td><td>${data.m+data.f}</td><td></td></tr>`;

            // HTML Construction matches layout
            const html = `
            <style>
                @media print { @page { size: portrait; margin: 10mm; } body { -webkit-print-color-adjust: exact; } }
                .rbi-c-container { font-family: Arial, sans-serif; font-size: 10pt; width: 100%; color: black; }
                .rbi-c-header { text-align: center; font-weight: bold; margin-bottom: 20px; }
                .rbi-info-table { width: 100%; margin-bottom: 15px; }
                .rbi-info-table td { padding: 2px; }
                .rbi-main-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                .rbi-main-table th { border: 1px solid black; background: #e0e0e0; padding: 5px; text-align: center; font-weight: bold; }
                .rbi-main-table td { border: 1px solid black; padding: 4px; text-align: center; }
                .rbi-main-table td:first-child { text-align: left; }
                .sig-box { margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid; }
                .sig-line { border-bottom: 1px solid black; width: 200px; margin: 0 auto; margin-top: 30px; }
            </style>
            <div class="rbi-c-container">
                <div class="rbi-c-header">
                    <div style="font-size: 11pt;">RBI FORM C (Revised 2024)</div>
                    <div style="font-size: 12pt; margin-top:5px;">MONITORING REPORT</div>
                    <div style="font-weight: normal; margin-top: 5px;">for ___ Semester of CY ________</div>
                </div>

                <table class="rbi-info-table">
                    <tr><td width="15%">REGION</td><td width="2%">:</td><td style="border-bottom: 1px solid black;">${settings.region}</td></tr>
                    <tr><td>PROVINCE</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.province}</td></tr>
                    <tr><td>CITY/MUNICIPALITY</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.municipality}</td></tr>
                    <tr><td>BARANGAY</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.barangay}</td></tr>
                </table>

                <table class="rbi-info-table" style="margin-top: 10px;">
                    <tr><td width="30%">Total No. of Barangay Inhabitants:</td><td style="border-bottom: 1px solid black; font-weight:bold;">${totalInhabitants}</td></tr>
                    <tr><td>Total No. of Households:</td><td style="border-bottom: 1px solid black; font-weight:bold;">${totalHH}</td></tr>
                    <tr><td>Total No. of Families:</td><td style="border-bottom: 1px solid black; font-weight:bold;">${totalFamilies}</td></tr>
                </table>

                <table class="rbi-main-table">
                    <thead>
                        <tr>
                            <th width="40%">INDICATORS</th>
                            <th width="15%">MALE</th>
                            <th width="15%">FEMALE</th>
                            <th width="15%">TOTAL</th>
                            <th width="15%">REMARKS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td style="font-weight:bold;">Population by Age Bracket:</td><td></td><td></td><td></td><td></td></tr>
                        ${ageRows}
                        
                        <tr><td style="font-weight:bold; padding-top:10px;">Population by Sector:</td><td></td><td></td><td></td><td></td></tr>
                        ${sectorRow("Labor Force", sectors.labor)}
                        ${sectorRow("Unemployed", sectors.unemployed)}
                        ${sectorRow("Out of School Children (OSC)<br><span style='font-size:8pt; margin-left:10px;'>(6-14 years old)</span>", sectors.osc)}
                        ${sectorRow("Out of School Youth (OSY)<br><span style='font-size:8pt; margin-left:10px;'>(15-24 years old)</span>", sectors.osy)}
                        ${sectorRow("Person with Disabilities (PWDs)", sectors.pwd)}
                        ${sectorRow("Overseas Filipino Workers (OFWs)", sectors.ofw)}
                        ${sectorRow("Solo Parents", sectors.solo)}
                        ${sectorRow("Indigenous Peoples (IPs)", sectors.ip)}

                        <tr><td style="font-weight:bold; padding-top:10px; border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td></tr>

                        ${sectorRow("Civil Status : Single", sectors.single)}
                        ${sectorRowIndent(": Married", sectors.married)}

                        <tr><td style="font-weight:bold; padding-top:10px; border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td><td style="border:none; border-left:1px solid black; border-right:1px solid black;"></td></tr>

                        ${sectorRow("Citizenship : Filipino", sectors.filipino)}
                        ${sectorRowIndent(": Foreigner", sectors.foreigner)}
                    </tbody>
                </table>

                <div class="sig-box">
                    <div style="text-align: center; width: 40%;">
                        <div style="margin-bottom: 40px; text-align:left;">Prepared by:</div>
                        <div class="sig-line" style="text-transform:uppercase; font-weight:bold;">${settings.secretary}</div>
                        <div>Barangay Secretary</div>
                        <div style="font-size: 8pt;">(Signature over Printed Name)</div>
                        <div style="text-align:left; margin-top:20px;">Date Accomplished: ____________________</div>
                    </div>
                    <div style="text-align: center; width: 40%;">
                        <div style="margin-bottom: 40px; text-align:left;">Submitted by:</div>
                        <div class="sig-line" style="text-transform:uppercase; font-weight:bold;">${settings.captain}</div>
                        <div>Punong Barangay</div>
                        <div style="font-size: 8pt;">(Signature over Printed Name)</div>
                    </div>
                </div>

                <div style="font-size: 8pt; margin-top: 20px;">
                    Note: This RBI Form C (Semestral Monitoring Report) is to be submitted to DILG C/MLGOO as a reference for encoding to BIS-BPS.
                </div>
            </div>
            `;

            document.getElementById('print-area').innerHTML = html;
            window.print();
        }

        // --- IMPORT / EXPORT ---
        function processExport() {
            const instrHeader = ["COLUMNS", "EXPECTED VALUES/ FORMAT", "REMARKS"];
            const instrData = [["INHABITANT TYPE", "NON-MIGRANT", "Required Field"], ["", "MIGRANT", ""], ["", "TRANSIENT", ""], ["LAST NAME", "", "Required Field"], ["FIRST NAME", "", "Required Field"], ["MIDDLE NAME", "", "Optional Field"], ["SUFFIX", "", "Optional Field"], ["BIRTH PLACE", "", "Optional Field"], ["BIRTHDATE (YYYY-MM-DD)", "2000-12-30", "Required Field"], ["SEX", "MALE", "Required Field"], ["", "FEMALE", "Required Field"], ["CIVIL STATUS", "SINGLE", "Required Field"], ["", "MARRIED", "Required Field"], ["", "WIDOWED", "Required Field"], ["", "DIVORCED", "Required Field"], ["", "SEPARATED", "Required Field"], ["", "COMMON LAW/ LIVE-IN", "Required Field"], ["", "UNKNOWN", "Required Field"], ["", "ANNULLED", "Required Field"], ["CITIZENSHIP", "FILIPINO", "Required Field"], ["", "FOREIGNER", "Required Field"], ["RELIGION", "", "Optional Field"], ["PROFESSION/ OCCUPATION", "", "Optional Field"], ["CONTACT NUMBER", "", "Optional Field"], ["EMAIL ADDRESS", "", "Optional Field"], ["HIGHEST EDUCATIONAL ATTAINMENT", "", "Optional Field"], ["MOTHER'S FIRST NAME", "", "Optional Field"], ["MOTHER'S MIDDLE NAME", "", "Optional Field"], ["MOTHER'S LAST NAME", "", "Optional Field"]];
            const dataHeader = ["INHABITANT TYPE", "LAST NAME", "FIRST NAME", "MIDDLE NAME", "SUFFIX", "BIRTH PLACE", "BIRTHDATE (YYYY-MM-DD)", "SEX", "CIVIL STATUS", "CITIZENSHIP", "PROFESSION/ OCCUPATION", "CONTACT NUMBER", "EMAIL ADDRESS", "HIGHEST EDUCATIONAL ATTAINMENT", "MOTHER'S FIRST NAME", "MOTHER'S MIDDLE NAME", "MOTHER'S LAST NAME", "PUROK/SITIO", "ADDITIONAL ADDRESS", "RELIGION", "IS OSY", "IS PWD", "IS 4Ps", "IS IPS", "IS SOLO PARENT", "LABOR STATUS", "IS OFW", "IS ISY"];
            const living = db.filter(r => !r.isDead);
            const dataRows = living.map(r => {
                let purok = '', addAdd = r.address || '';
                if(r.address && r.address.includes('Purok')) {
                    const parts = r.address.split('Purok');
                    addAdd = parts[0].trim();
                    purok = parts[1].trim();
                }
                return [
                    r.type || "NON-MIGRANT", r.last || "", r.first || "", r.middle || "", r.suffix || "", r.bplace || "", r.bdate || "", r.sex || "", r.civil || "", r.citizen || "FILIPINO", 
                    r.prof || "", 
                    r.contact || "", r.email || "", r.edu || "", r.mother_first || "", r.mother_middle || "", r.mother_last || "", 
                    purok, addAdd, 
                    r.religion || "", 
                    r.isOSY ? "YES" : "NO", r.isPwd ? "YES" : "NO", "NO", r.isIp ? "YES" : "NO", r.isSoloParent ? "YES" : "NO", r.isUnemployed ? "UNEMPLOYED" : "EMPLOYED", r.isOfw ? "YES" : "NO", "NO"
                ];
            });
            const wb = XLSX.utils.book_new(); const wsInstr = XLSX.utils.aoa_to_sheet([instrHeader, ...instrData]); XLSX.utils.book_append_sheet(wb, wsInstr, "INSTRUCTIONS"); const wsData = XLSX.utils.aoa_to_sheet([dataHeader, ...dataRows]); XLSX.utils.book_append_sheet(wb, wsData, "DATA"); XLSX.writeFile(wb, "RBI_Export_BIMS.xlsx");
        }

        function backupData() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({db, settings, household_db})); const a = document.createElement('a'); a.href = dataStr; a.download = "RBI_Backup.json"; a.click(); }

        function restoreData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) { try { 
                const imported = JSON.parse(e.target.result); 
                if(imported.db) { 
                    await iDB.residents.clear();
                    await iDB.residents.bulkPut(imported.db);
                    
                    if(imported.household_db) {
                        await iDB.households.clear();
                        await iDB.households.bulkPut(imported.household_db);
                    }
                    if(imported.settings) {
                        settings = imported.settings;
                        localStorage.setItem('rbi_settings', JSON.stringify(settings));
                    }
                    
                    await refreshData();
                    showSystemAlert("Restored!"); location.reload(); 
                } 
            } catch(err) { showSystemAlert("Error reading file: " + err); } };
            reader.readAsText(file);
        }

        function previewImport() {
            const file = document.getElementById('import-file').files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, {type: 'binary'}); let sheetName = "DATA"; if(!workbook.Sheets[sheetName]) sheetName = workbook.SheetNames[1] || workbook.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1}); stagingValid = []; stagingInvalid = []; stagingDup = [];
                const startRow = (json[0] && json[0][0] === "INHABITANT TYPE") ? 1 : 0;
                for(let i=startRow; i<json.length; i++) {
                    const row = json[i]; if(!row || row.length === 0) continue;
                    const tempRec = { type: row[0], last: row[1], first: row[2], middle: row[3] || '', suffix: row[4] || '', bplace: row[5] || '', bdate: row[6], sex: row[7], civil: row[8], citizen: row[9] || 'FILIPINO', 
                        prof: row[10] || '', 
                        contact: row[11] || '', email: row[12] || '', edu: row[13] || '', mother_first: row[14] || '', mother_middle: row[15] || '', mother_last: row[16] || '', 
                        address: (row[18] || '') + ' ' + (row[17] ? 'Purok ' + row[17] : ''), 
                        religion: row[19] || '', 
                        isOSY: (row[20] && row[20].toString().toUpperCase() === 'YES'),
                        isPwd: (row[21] && row[21].toString().toUpperCase() === 'YES'),
                        isIp: (row[23] && row[23].toString().toUpperCase() === 'YES'),
                        isSoloParent: (row[24] && row[24].toString().toUpperCase() === 'YES'),
                        isOfw: (row[26] && row[26].toString().toUpperCase() === 'YES'),
                        isVoter: false, isDead: false, hh_name: '', hh_role: 'MEMBER' };
                    
                    if(!tempRec.last || !tempRec.first || !tempRec.bdate) { stagingInvalid.push({ line: i+1, data: tempRec }); continue; }
                    const exists = db.some(x => x.last.toLowerCase() === tempRec.last.toLowerCase() && x.first.toLowerCase() === tempRec.first.toLowerCase() && x.bdate === tempRec.bdate);
                    if(exists) { stagingDup.push({ line: i+1, name: `${tempRec.last}, ${tempRec.first}` }); continue; }
                    tempRec.id = Date.now().toString() + i; stagingValid.push(tempRec);
                }
                document.getElementById('count-valid').innerText = stagingValid.length; document.getElementById('lbl-valid-count').innerText = stagingValid.length;
                document.getElementById('count-invalid').innerText = stagingInvalid.length; document.getElementById('count-dup').innerText = stagingDup.length;
                document.getElementById('btn-commit-import').disabled = (stagingValid.length === 0);
                document.getElementById('list-dup').innerHTML = stagingDup.map(x => `<div class="border-bottom p-1">Row ${x.line}: ${x.name}</div>`).join('');
                document.getElementById('list-invalid').innerHTML = stagingInvalid.map(x => `<div class="border-bottom p-1">Row ${x.line}: Missing Data</div>`).join('');
                document.getElementById('modal-import').style.display = 'block'; document.getElementById('modal-import').classList.add('show'); showImportTab('valid');
            };
            reader.readAsBinaryString(file);
        }

        function showImportTab(tab) { document.querySelectorAll('.import-view').forEach(el => el.classList.add('d-none')); document.getElementById('view-'+tab).classList.remove('d-none'); }
        function closeImportModal() { document.getElementById('modal-import').style.display = 'none'; document.getElementById('modal-import').classList.remove('show'); document.getElementById('import-file').value = ''; }
        
        async function commitImport() { 
            if(stagingValid.length === 0) return; 
            await iDB.residents.bulkPut(stagingValid);
            await refreshData();
            closeImportModal(); showSystemAlert(`Imported ${stagingValid.length} records.`); showHome(); 
        }

        function saveSettings() {
            const sec = document.getElementById('set-sec').value; const brgy = document.getElementById('set-brgy').value; const prov = document.getElementById('set-prov').value; const muni = document.getElementById('set-muni').value; const lguType = document.getElementById('set-lgu-type').value; const region = document.getElementById('set-region').value; const captain = document.getElementById('set-captain').value;
            if(!sec || !brgy) return showSystemAlert("Please fill in Barangay and Secretary name.");
            settings.secretary = sec.toUpperCase(); settings.barangay = brgy.toUpperCase(); settings.province = prov ? prov.toUpperCase() : ''; settings.municipality = muni ? muni.toUpperCase() : ''; settings.lguType = lguType; settings.region = region ? region.toUpperCase() : ''; settings.captain = captain ? captain.toUpperCase() : '';
            localStorage.setItem('rbi_settings', JSON.stringify(settings)); showSystemAlert('Configuration Saved!');
        }
    </script>
<script>
    // --- PATCH FIX FOR PRINTING HOUSEHOLDS ---

    // 1. Fix for "Print Household Heads" button
    function printHHHeads() {
        // This reuses the robust "Head of Families" print category we already built
        printStatCategory('families');
    }

    // 2. Fix for "Print Form A" (Household Card)
    function printFormA() {
        // Get current values directly from the active view
        const hhName = document.getElementById('manage-hh-name').value;
        const purok = document.getElementById('view-hh-purok').innerText;
        const houseNo = document.getElementById('view-hh-num').innerText;

        if (!hhName) {
            showSystemAlert("Error: No household selected.");
            return;
        }

        // Filter members for this specific household
        const members = db.filter(r => r.hh_name === hhName && !r.isDead);

        if (members.length === 0) {
            showSystemAlert("This household has no members.");
            return;
        }

        // Sort: Head -> Spouse -> Children -> Others -> Alphabetical
        members.sort((a, b) => {
            const roles = { 'HEAD': 1, 'SPOUSE': 2, 'SON': 3, 'DAUGHTER': 4, 'MEMBER': 5 };
            const ra = roles[a.hh_role] || 99;
            const rb = roles[b.hh_role] || 99;
            if (ra !== rb) return ra - rb;
            return a.last.localeCompare(b.last);
        });

        // Generate Rows
        let rowsHtml = '';
        members.forEach((m, i) => {
            let indicators = [];
            // Status Logic
            if (m.prof && !m.isUnemployed) indicators.push("Employed");
            if (m.isUnemployed) indicators.push("Unemployed");
            if (m.isVoter) indicators.push("VOTER");
            if (m.isPwd) indicators.push("PWD");
            if (m.isOfw) indicators.push("OFW");
            if (m.isSoloParent) indicators.push("Solo Parent");
            if (m.isOSY) indicators.push("OSY");
            if (m.isOsc) indicators.push("OSC");
            if (m.isIp) indicators.push("IP");

            const ageInfo = calculateAgeDetailed(m.bdate);
            
            rowsHtml += `
            <tr>
                <td style="text-align:center;">${i + 1}</td>
                <td>${m.last}</td>
                <td>${m.first}</td>
                <td>${m.middle || ''}</td>
                <td>${m.suffix || ''}</td>
                <td>${m.bplace || ''}</td>
                <td style="text-align:center;">${m.bdate}</td>
                <td style="text-align:center;">${ageInfo.y}</td>
                <td style="text-align:center;">${m.sex.substring(0,1)}</td>
                <td style="text-align:center;">${m.civil}</td>
                <td style="text-align:center;">${m.citizen || 'FIL'}</td>
                <td>${m.prof || ''}</td>
                <td style="font-size:8pt;">${indicators.join(', ')}</td>
            </tr>`;
        });

        // Fill empty rows to make the sheet look full (up to 15 rows)
        for (let i = members.length; i < 15; i++) {
            rowsHtml += `<tr><td>${i + 1}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
        }

        // Generate the Print Layout
        const html = `
        <div style="font-family: Arial, sans-serif; padding: 20px; color:black;">
            <div style="text-align:center; margin-bottom: 20px;">
                <h3 style="margin:0; font-weight:800;">RBI FORM A (Revised 2024)</h3>
                <h4 style="margin:5px 0; font-weight:bold;">RECORDS OF BARANGAY INHABITANTS BY HOUSEHOLD</h4>
            </div>

            <table style="width:100%; margin-bottom: 15px; font-size: 10pt; font-weight:bold;">
                <tr>
                    <td width="10%">REGION:</td>
                    <td width="30%" style="border-bottom: 1px solid black;">${settings.region}</td>
                    <td width="10%"></td>
                    <td width="15%">PROVINCE:</td>
                    <td width="35%" style="border-bottom: 1px solid black;">${settings.province}</td>
                </tr>
                <tr>
                    <td>MUNICIPALITY:</td>
                    <td style="border-bottom: 1px solid black;">${settings.municipality}</td>
                    <td></td>
                    <td>BARANGAY:</td>
                    <td style="border-bottom: 1px solid black;">${settings.barangay}</td>
                </tr>
                <tr>
                    <td>ADDRESS:</td>
                    <td style="border-bottom: 1px solid black;" colspan="4">PUROK ${purok}, HOUSE NO. ${houseNo}</td>
                </tr>
                 <tr>
                    <td>HOUSEHOLD:</td>
                    <td style="border-bottom: 1px solid black;" colspan="2">${hhName}</td>
                    <td style="text-align:right;">NO. OF MEMBERS:</td>
                    <td style="border-bottom: 1px solid black; padding-left:10px;">${members.length}</td>
                </tr>
            </table>

            <table style="width:100%; border-collapse: collapse; font-size: 9pt;">
                <thead>
                    <tr style="background:#f0f0f0;">
                        <th rowspan="2" style="border:1px solid black; width:3%;">NO.</th>
                        <th colspan="4" style="border:1px solid black;">NAME</th>
                        <th rowspan="2" style="border:1px solid black; width:10%;">BIRTH PLACE</th>
                        <th rowspan="2" style="border:1px solid black; width:8%;">BIRTH DATE</th>
                        <th rowspan="2" style="border:1px solid black; width:4%;">AGE</th>
                        <th rowspan="2" style="border:1px solid black; width:3%;">SEX</th>
                        <th rowspan="2" style="border:1px solid black; width:8%;">STATUS</th>
                        <th rowspan="2" style="border:1px solid black; width:5%;">CITIZEN</th>
                        <th rowspan="2" style="border:1px solid black; width:10%;">OCCUPATION</th>
                        <th rowspan="2" style="border:1px solid black; width:15%;">REMARKS</th>
                    </tr>
                    <tr style="background:#f0f0f0;">
                        <th style="border:1px solid black;">LAST</th>
                        <th style="border:1px solid black;">FIRST</th>
                        <th style="border:1px solid black;">MIDDLE</th>
                        <th style="border:1px solid black;">EXT</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>

            <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 50px; font-size: 10pt;">
                
                <div style="width: 30%; text-align: center;">
                    <p style="text-align: left; margin-bottom: 30px;">Prepared by:</p>
                    <div style="border-bottom: 1px solid black; margin-bottom: 5px; height: 1em;"></div>
                    <strong>Household Head / Member</strong><br>
                    <span style="font-size: 0.8em;">(Signature over Printed Name)</span>
                </div>

                <div style="width: 30%; text-align: center;">
                    <p style="text-align: left; margin-bottom: 30px;">Certified Correct:</p>
                    <div style="border-bottom: 1px solid black; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;">
                        ${settings.secretary}
                    </div>
                    <strong>Barangay Secretary</strong><br>
                    <span style="font-size: 0.8em;">(Signature over Printed Name)</span>
                </div>

                <div style="width: 30%; text-align: center;">
                    <p style="text-align: left; margin-bottom: 30px;">Validated by:</p>
                    <div style="border-bottom: 1px solid black; margin-bottom: 5px; font-weight: bold; text-transform: uppercase;">
                        ${settings.captain}
                    </div>
                    <strong>Punong Barangay</strong><br>
                    <span style="font-size: 0.8em;">(Signature over Printed Name)</span>
                </div>

            </div>
            
            <div style="margin-top: 20px; font-size: 8pt; font-style: italic; border-top: 1px dashed #999; padding-top: 10px;">
                Generated by RBI System 2026. Date Printed: ${new Date().toLocaleDateString()}
            </div>
        </div>
        `;

        const printArea = document.getElementById('print-area');
        printArea.innerHTML = html;
        
        // Force a small delay to ensure rendering before print dialog
        setTimeout(() => {
            window.print();
        }, 300);
    }
</script>
<script>
    // --- PATCH: CLEAR SEARCH ON MODAL OPEN ---
    
    // This overrides the existing function to ensure a fresh start every time
    function showAddMemberModal() {
        // 1. Clear the text input
        const inputField = document.getElementById('search-mem-hh');
        inputField.value = ''; 
        
        // 2. Clear the previous search results list
        document.getElementById('hh-search-results').innerHTML = '';

        // 3. Show the modal
        new bootstrap.Modal(document.getElementById('modal-add-mem')).show();

        // 4. (Optional) Auto-focus the input so you can type immediately
        setTimeout(() => {
            inputField.focus();
        }, 500);
    }
</script>
<script>
    // --- PATCH FIX FOR PRINTING HOUSEHOLDS (RBI FORM A REVISED 2024 STRICT COMPLIANCE) ---

    // 1. Fix for "Print Household Heads" button (unchanged, still valid)
    function printHHHeads() {
        printStatCategory('families');
    }

    // 2. Fix for "Print Form A" (Strict RBI Form A Revised 2024 Layout)
    function printFormA() {
        const hhName = document.getElementById('manage-hh-name').value;
        const purok = document.getElementById('view-hh-purok').innerText;
        const houseNo = document.getElementById('view-hh-num').innerText;

        if (!hhName) { showSystemAlert("Error: No household selected."); return; }

        const members = db.filter(r => r.hh_name === hhName && !r.isDead);
        if (members.length === 0) { showSystemAlert("This household has no members."); return; }

        // Sort: Head -> Spouse -> Children -> Others -> Alphabetical
        members.sort((a, b) => {
            const roles = { 'HEAD': 1, 'SPOUSE': 2, 'SON': 3, 'DAUGHTER': 4, 'MEMBER': 5 };
            const ra = roles[a.hh_role] || 99;
            const rb = roles[b.hh_role] || 99;
            if (ra !== rb) return ra - rb;
            return a.last.localeCompare(b.last);
        });

        // Generate Rows matching the CSV columns:
        // NO. | LAST NAME | FIRST NAME | MIDDLE NAME | EXT | PLACE OF BIRTH | DATE OF BIRTH | AGE | SEX | CIVIL STATUS | CITIZENSHIP | OCCUPATION | REMARKS/STATUS
        let rowsHtml = '';
        members.forEach((m, i) => {
            let indicators = [];
            if (m.prof && !m.isUnemployed) indicators.push("Employed");
            if (m.isUnemployed) indicators.push("Unemployed");
            if (m.isVoter) indicators.push("Voter");
            if (m.isPwd) indicators.push("PWD");
            if (m.isOfw) indicators.push("OFW");
            if (m.isSoloParent) indicators.push("Solo Parent");
            if (m.isOSY) indicators.push("OSY");
            if (m.isOsc) indicators.push("OSC");
            if (m.isIp) indicators.push("IP");

            const ageInfo = calculateAgeDetailed(m.bdate);
            
            rowsHtml += `
            <tr>
                <td style="text-align:center;">${i + 1}</td>
                <td>${m.last}</td>
                <td>${m.first}</td>
                <td>${m.middle || ''}</td>
                <td>${m.suffix || ''}</td>
                <td>${m.bplace || ''}</td>
                <td style="text-align:center;">${m.bdate}</td>
                <td style="text-align:center;">${ageInfo.y}</td>
                <td style="text-align:center;">${m.sex ? m.sex.substring(0,1) : ''}</td>
                <td style="text-align:center;">${m.civil || ''}</td>
                <td style="text-align:center;">${m.citizen || 'FILIPINO'}</td>
                <td>${m.prof || ''}</td>
                <td style="font-size:8pt;">${indicators.join(', ')}</td>
            </tr>`;
        });

        // Fill empty rows to make the sheet look full (up to 15 rows)
        for (let i = members.length; i < 15; i++) {
            rowsHtml += `<tr><td>${i + 1}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
        }

        const html = `
        <style>
            @media print { 
                @page { size: landscape; margin: 10mm; } 
                body { -webkit-print-color-adjust: exact; } 
                .no-print { display: none !important; }
            }
            .form-a-container { font-family: Arial, sans-serif; width: 100%; color: black; font-size: 10pt; }
            .form-header { text-align: center; margin-bottom: 10px; }
            .form-header h3 { margin: 0; font-weight: 800; font-size: 14pt; }
            .form-header h4 { margin: 2px 0; font-weight: bold; font-size: 11pt; }
            .info-table { width: 100%; border-collapse: collapse; margin-bottom: 5px; font-weight: bold; font-size: 10pt; }
            .info-table td { padding: 2px 5px; border: none; }
            .info-val { border-bottom: 1px solid black !important; }
            
            .main-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9pt; }
            .main-table th { border: 1px solid black; padding: 4px; text-align: center; font-weight: bold; background: #e0e0e0; vertical-align: middle; }
            .main-table td { border: 1px solid black; padding: 4px; vertical-align: middle; }
            
            .footer-section { display: flex; justify-content: space-between; margin-top: 40px; page-break-inside: avoid; }
            .sig-block { width: 30%; text-align: center; }
            .sig-line { border-bottom: 1px solid black; margin-top: 30px; margin-bottom: 2px; font-weight: bold; text-transform: uppercase; }
            .legal-text { margin-top: 15px; font-size: 7pt; font-style: italic; text-align: justify; }
        </style>

        <div class="form-a-container">
            <div class="form-header">
                <h3>RBI FORM A (Revised 2024)</h3>
                <h4>RECORDS OF BARANGAY INHABITANTS BY HOUSEHOLD</h4>
            </div>

            <table class="info-table">
                <tr>
                    <td width="8%">REGION:</td>
                    <td width="20%" class="info-val">${settings.region}</td>
                    <td width="2%"></td>
                    <td width="10%">PROVINCE:</td>
                    <td width="25%" class="info-val">${settings.province}</td>
                    <td width="2%"></td>
                    <td width="15%">CITY/MUNICIPALITY:</td>
                    <td width="18%" class="info-val">${settings.municipality}</td>
                </tr>
                <tr>
                    <td>BARANGAY:</td>
                    <td class="info-val">${settings.barangay}</td>
                    <td></td>
                    <td>HOUSEHOLD NO:</td>
                    <td class="info-val" colspan="4"></td>
                </tr>
                <tr>
                    <td colspan="2">HOUSEHOLD ADDRESS:</td>
                    <td class="info-val" colspan="6">PUROK ${purok}, HOUSE NO. ${houseNo}</td>
                </tr>
            </table>

            <table class="main-table">
                <thead>
                    <tr>
                        <th rowspan="2" width="3%">NO.</th>
                        <th colspan="4">NAME</th>
                        <th rowspan="2" width="10%">PLACE OF BIRTH</th>
                        <th rowspan="2" width="8%">DATE OF BIRTH<br>(mm/dd/yyyy)</th>
                        <th rowspan="2" width="4%">AGE</th>
                        <th rowspan="2" width="4%">SEX</th>
                        <th rowspan="2" width="8%">CIVIL STATUS</th>
                        <th rowspan="2" width="8%">CITIZENSHIP</th>
                        <th rowspan="2" width="10%">OCCUPATION</th>
                        <th rowspan="2" width="12%">REMARKS / STATUS</th>
                    </tr>
                    <tr>
                        <th width="12%">LAST NAME</th>
                        <th width="12%">FIRST NAME</th>
                        <th width="12%">MIDDLE NAME</th>
                        <th width="5%">EXT</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>
            
            <div class="footer-section">
                <div class="sig-block">
                    <div style="text-align:left;">Prepared by:</div>
                    <div class="sig-line"></div>
                    <div>Name of Household Head/Member</div>
                    <div style="font-size:8pt;">(Signature over Printed Name)</div>
                </div>

                <div class="sig-block">
                    <div style="text-align:left;">Certified Correct:</div>
                    <div class="sig-line">${settings.secretary}</div>
                    <div>Barangay Secretary</div>
                    <div style="font-size:8pt;">(Signature over Printed Name)</div>
                </div>

                <div class="sig-block">
                    <div style="text-align:left;">Validated by:</div>
                    <div class="sig-line">${settings.captain}</div>
                    <div>Punong Barangay</div>
                    <div style="font-size:8pt;">(Signature over Printed Name)</div>
                </div>
            </div>

            <div class="legal-text">
                "I hereby certify that the above information are true and correct to the best of my knowledge. I understand that for the Barangay to carry out its mandate pursuant to Section 394 (d)(6) of the Local Government Code of 1991, they must necessarily process my personal information for easy identification of inhabitants, as a tool in planning, and as an updated reference in the number of inhabitants of the Barangay. Therefore, I grant my consent and recognize the authority of the Barangay to process my personal information, subject to the provision of the Philippine Data Privacy Act of 2012."
            </div>
        </div>
        `;

        document.getElementById('print-area').innerHTML = html;
        setTimeout(() => { window.print(); }, 500);
    }
</script>

</body>
</html>
