<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<link rel="apple-touch-icon" href="icon.png">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('PWA Active: ', reg.scope))
        .catch(err => console.error('PWA Error: ', err));
    });
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBI Management System 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    /* Force Uppercase in Inputs */
    input[type="text"], input[type="email"], textarea { text-transform: uppercase; }
    
    /* Desktop Sidebar */
    .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #343a40; padding-top: 20px; color: white; transition: all 0.3s; z-index: 1000; }
    .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: #d1d1d1; display: block; transition: 0.2s; border-left: 4px solid transparent; }
    .sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; border-left: 4px solid #0d6efd; }
    .sidebar-header { padding: 0 25px 20px 25px; border-bottom: 1px solid #4b545c; margin-bottom: 10px; }
    
    .content { margin-left: 250px; padding: 20px; transition: all 0.3s; }
    
    /* Mobile Responsive Styles */
    .mobile-toggle { display: none; position: fixed; top: 15px; right: 15px; z-index: 1001; background: #343a40; color: white; border: none; padding: 10px 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; }

    @media (max-width: 768px) {
        .sidebar { left: -250px; } /* Hide sidebar */
        .sidebar.active { left: 0; } /* Show sidebar */
        .content { margin-left: 0; padding-top: 60px; } /* Reset margin, add top padding for toggle */
        .mobile-toggle { display: block; } /* Show toggle button */
        .sidebar-overlay.active { display: block; } /* Show overlay when menu open */
        
        /* Adjust Stats Cards */
        .stat-card { margin-bottom: 15px; }
        
        /* Adjust Search Bar */
        #search-input { width: 100% !important; margin-bottom: 10px; }
        
        /* Adjust Tables */
        .table-responsive { overflow-x: auto; }
        
        /* Login Box */
        .login-box { width: 90%; }
        
        /* Modals */
        .modal-dialog { margin: 10px; }
    }

    .card-custom { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .card-custom:hover { transform: translateY(-2px); }
    .stat-card { border-left: 4px solid; }
    .stat-primary { border-color: #0d6efd; }
    .stat-success { border-color: #198754; }
    .stat-warning { border-color: #ffc107; }
    .stat-danger { border-color: #dc3545; }
    .stat-info { border-color: #0dcaf0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .login-box { background: #212529; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.1); width: 400px; text-align: center; }
    .d-none { display: none !important; }
    
    /* Search Results Dropdown Fix */
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        z-index: 2000;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .search-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #333; }
    .search-item:hover { background-color: #e9ecef; color: #0d6efd; }

    /* Custom Alert/Confirm Styles */
    .alert-modal-body { text-align: center; padding: 20px; }
    .alert-icon { font-size: 3rem; margin-bottom: 15px; }

    /* Import Correction Table */
    .correction-table input { min-width: 100px; font-size: 0.85rem; padding: 4px; text-transform: uppercase; }
    .correction-table td { vertical-align: middle; }
    
    /* --- PRINT AREA CONTROL --- */
    #print-area { display: none; } 

    @media print {
        body > * { display: none !important; }
        .sidebar, .content, #security-overlay, .modal, .modal-backdrop, .mobile-toggle { display: none !important; }
        #print-area { 
            display: block !important; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            background: white;
            z-index: 99999;
        }
        @page { margin: 10mm; }
        .page-break { page-break-after: always; }
        
        .print-table { width: 100%; border-collapse: collapse; font-family: 'Times New Roman', serif; font-size: 10pt; }
        .print-table th, .print-table td { border: 1px solid black; padding: 4px; vertical-align: middle; }
        .print-header { text-align: left; font-family: 'Arial', sans-serif; margin-bottom: 10px; }
        .sig-box { margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid; }
        .sig-line { border-top: 1px solid black; width: 200px; margin: 40px auto 5px auto; }
        .landscape-page { width: 100%; orientation: landscape; }
    }
</style>
</head>
<body>

    <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="modal fade" id="modal-custom-alert" tabindex="-1" style="z-index: 10000;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="alert-modal-body">
                    <div id="alert-icon-container"></div>
                    <h5 id="alert-title" class="fw-bold mb-3">Notification</h5>
                    <p id="alert-message" class="text-muted mb-4">Message goes here.</p>
                    <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-custom-confirm" tabindex="-1" data-bs-backdrop="static" style="z-index: 10001;">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="alert-modal-body">
                    <div class="text-warning mb-3"><i class="fas fa-question-circle" style="font-size: 3rem;"></i></div>
                    <h5 id="confirm-title" class="fw-bold mb-2">Are you sure?</h5>
                    <p id="confirm-message" class="text-muted mb-4">This action cannot be undone.</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary w-50" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="btn-confirm-yes" class="btn btn-danger w-50">Yes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="security-overlay" class="overlay">
        <div class="login-box">
            <h3 class="mb-4"><i class="fas fa-shield-alt"></i> RBI SECURE</h3>
            
            <div id="login-phase-1">
                <p class="text-muted small mb-3">System requires Dynamic Authentication.</p>
                <input type="password" id="dynamic-code" class="form-control mb-3 text-center" placeholder="Enter Dynamic Access Code">
                <button onclick="checkDynamic()" class="btn btn-primary w-100">Authenticate</button>
                <div class="mt-3 text-white-50" style="font-size: 0.8rem;" id="server-time-display"></div>
            </div>

            <div id="login-phase-2" class="d-none">
                <p class="text-success small mb-3">Authentication Verified.</p>
                <p class="text-muted small">Please set your personal password.</p>
                <input type="password" id="new-custom-pass" class="form-control mb-2" placeholder="New Password">
                <input type="password" id="confirm-custom-pass" class="form-control mb-3" placeholder="Confirm Password">
                <button onclick="setCustomPassword()" class="btn btn-success w-100">Set Password & Login</button>
            </div>

            <div id="login-phase-3" class="d-none">
                <p class="text-white small mb-3">Welcome Back</p>
                <input type="password" id="input-custom-pass" class="form-control mb-3 text-center" placeholder="Enter Password">
                <button onclick="verifyCustomPassword()" class="btn btn-primary w-100">Login</button>
                <button onclick="forgotPassword()" class="btn btn-link text-lighted btn-sm mt-2">Forgot Password?</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-users-cog"></i> RBI System</h4>
            <small class="text-muted">Brgy. Data Management</small>
        </div>
        <a href="#" onclick="showHome(); toggleSidebar(true);" class="nav-link active"><i class="fas fa-home me-2"></i> Dashboard</a>
        <a href="#" onclick="showAdd(); toggleSidebar(true);" class="nav-link"><i class="fas fa-user-plus me-2"></i> Add Resident</a>
        <a href="#" onclick="showHouseholds(); toggleSidebar(true);" class="nav-link"><i class="fas fa-house-user me-2"></i> Households</a>
        <a href="#" onclick="showDeaths(); toggleSidebar(true);" class="nav-link"><i class="fas fa-book-dead me-2"></i> Death Registry</a>
        <a href="#" onclick="showImport(); toggleSidebar(true);" class="nav-link"><i class="fas fa-file-import me-2"></i> Import/Export</a>
        <a href="#" onclick="showSettings(); toggleSidebar(true);" class="nav-link"><i class="fas fa-cogs me-2"></i> Settings</a>
        <a href="#" onclick="logout()" class="nav-link mt-5"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <div class="content" id="main-container">
        
        <div id="section-home">
            <h2 class="mb-4"> Dashboard Overview</h2>
            <div class="row mb-4">
                <div class="col-md-3 col-6">
                    <div class="card card-custom stat-card stat-primary p-3">
                        <h6 class="text-muted">Total Residents</h6>
                        <h2 id="rep-total">0</h2>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-custom stat-card stat-info p-3">
                        <h6 class="text-muted">Total Households</h6>
                        <h2 id="rep-hh-total">0</h2>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-custom stat-card stat-success p-3">
                        <h6 class="text-muted">Total Families</h6>
                        <h2 id="rep-family-total">0</h2>
                        <small class="text-muted" style="font-size: 10px;">(Head of Families)</small>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="card card-custom stat-card stat-warning p-3">
                        <h6 class="text-muted">Seniors (60+)</h6>
                        <h2 id="rep-senior">0</h2>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3 g-2">
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>Male</small><strong id="rep-male">0</strong></div></div>
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>Female</small><strong id="rep-female">0</strong></div></div>
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>Children</small><strong id="rep-child">0</strong></div></div>
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>Adults</small><strong id="rep-adult">0</strong></div></div>
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>PWD</small><strong id="rep-pwd">0</strong></div></div>
                 <div class="col-md-2 col-4"><div class="card p-2 text-center bg-white"><small>Solo Parent</small><strong id="rep-solo">0</strong></div></div>
                 <div class="col-md-2 col-4 mt-2"><div class="card p-2 text-center bg-white"><small>OSY (15-24)</small><strong id="rep-osy">0</strong></div></div>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                <input type="text" id="search-input" class="form-control w-50" placeholder="Search resident name..." onkeyup="handleSearch()" oninput="this.value = this.value.toUpperCase()">
                <div class="mt-2 mt-md-0">
                    <button class="btn btn-outline-primary me-2 w-100 w-md-auto mb-2 mb-md-0" onclick="printAllFormB()"><i class="fas fa-print"></i> Print All Form B</button>
                    <button class="btn btn-dark w-100 w-md-auto" onclick="printStats()"><i class="fas fa-chart-bar"></i> Print Demographics</button>
                </div>
            </div>
            
            <div id="record-list"></div>
        </div>

        <div id="section-add" class="d-none">
            <h3 class="mb-3">Resident Information Sheet</h3>
            <div class="card card-custom p-4">
                <input type="hidden" id="rec-id">
                <div class="row g-3">
                    <div class="col-md-12"><h5 class="text-primary border-bottom pb-2">I. Personal Profile</h5></div>
                    <div class="col-md-3">
                        <label>Last Name <span class="text-danger">*</span></label>
                        <input type="text" id="f-last" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-3">
                        <label>First Name <span class="text-danger">*</span></label>
                        <input type="text" id="f-first" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-3">
                        <label>Middle Name</label>
                        <input type="text" id="f-middle" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-3">
                        <label>Suffix</label>
                        <input type="text" id="f-suffix" class="form-control text-uppercase" placeholder="e.g. JR, III" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    
                    <div class="col-md-3">
                        <label>Birth Date <span class="text-danger">*</span></label>
                        <input type="date" id="f-bdate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Sex <span class="text-danger">*</span></label>
                        <select id="f-sex" class="form-select">
                            <option value="MALE">MALE</option>
                            <option value="FEMALE">FEMALE</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label>Civil Status</label>
                        <select id="f-civil" class="form-select">
                            <option value="SINGLE">SINGLE</option>
                            <option value="MARRIED">MARRIED</option>
                            <option value="WIDOWED">WIDOWED</option>
                            <option value="SEPARATED">SEPARATED</option>
                            <option value="LIVE-IN">LIVE-IN / COMMON LAW</option>
                            <option value="ANNULLED">ANNULLED</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Religion</label>
                        <input type="text" id="f-religion" class="form-control text-uppercase" placeholder="e.g. ROMAN CATHOLIC" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-3">
                        <label>Citizenship</label>
                        <select id="f-citizen" class="form-select">
                            <option value="FILIPINO">FILIPINO</option>
                            <option value="FOREIGNER">FOREIGNER</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label>Birth Place</label>
                        <input type="text" id="f-bplace" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-4">
                        <label>Occupation</label>
                        <input type="text" id="f-prof" class="form-control text-uppercase" placeholder="Student/Unemployed" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-4">
                        <label>PhilSys ID</label>
                        <input type="text" id="f-philsys" class="form-control" oninput="this.value = this.value.toUpperCase()">
                    </div>

                    <div class="col-md-12 position-relative">
                        <label class="fw-bold">Mother's Maiden Name</label>
                        <input type="text" class="form-control mb-1" id="mother-search-input" placeholder="Type to search mother from DB..." onkeyup="searchMother(this.value)" oninput="this.value = this.value.toUpperCase()" autocomplete="off">
                        <div id="mother-search-results" class="search-results d-none"></div>
                        <div class="row g-2 mt-1">
                            <div class="col-4"><input type="text" id="f-m-last" class="form-control form-control-sm text-uppercase" placeholder="Mother's Last Name" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-4"><input type="text" id="f-m-first" class="form-control form-control-sm text-uppercase" placeholder="Mother's First Name" oninput="this.value = this.value.toUpperCase()"></div>
                            <div class="col-4"><input type="text" id="f-m-middle" class="form-control form-control-sm text-uppercase" placeholder="Mother's Middle Name" oninput="this.value = this.value.toUpperCase()"></div>
                        </div>
                    </div>

                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2">II. Special Categories & Status</h5></div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-solo">
                            <label class="form-check-label">Solo Parent</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-pwd">
                            <label class="form-check-label">Person with Disability (PWD)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-4ps">
                            <label class="form-check-label text-success fw-bold">4Ps Beneficiary</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-ofw">
                            <label class="form-check-label">OFW</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-ip">
                            <label class="form-check-label">Indigenous People (IP)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-osc">
                            <label class="form-check-label">Out of School Child (6-14 y/o)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-osy">
                            <label class="form-check-label">Out of School Youth (15-24 y/o)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-unemployed">
                            <label class="form-check-label text-warning">Unemployed (Labor Force)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-dead" onchange="toggleDeathInput()">
                            <label class="form-check-label text-danger">Deceased</label>
                        </div>
                    </div>
                    <div class="col-md-4 d-none" id="death-date-container">
                        <label class="text-danger">Date of Death</label>
                        <input type="date" id="f-death-date" class="form-control border-danger">
                    </div>

                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2">III. Contact & Residence</h5></div>
                    <div class="col-md-6">
                        <label>Inhabitant Type</label>
                        <select id="f-type" class="form-select">
                            <option value="NON-MIGRANT">NON-MIGRANT (Permanent)</option>
                            <option value="MIGRANT">MIGRANT</option>
                            <option value="TRANSIENT">TRANSIENT</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Contact Number</label>
                        <input type="text" id="f-contact" class="form-control" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-6">
                        <label>Email Address</label>
                        <input type="email" id="f-email" class="form-control" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="col-md-6">
                        <label>Educational Attainment</label>
                        <select id="f-edu" class="form-select">
                            <option value="">Select...</option>
                            <option value="ELEMENTARY">ELEMENTARY</option>
                            <option value="HIGH SCHOOL">HIGH SCHOOL</option>
                            <option value="COLLEGE UNDERGRAD">COLLEGE UNDERGRAD</option>
                            <option value="COLLEGE GRADUATE">COLLEGE GRADUATE</option>
                            <option value="POST GRAD">POST GRAD</option>
                            <option value="VOCATIONAL">VOCATIONAL</option>
                            <option value="NONE">NONE</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label>Current Address (Street/Sitio)</label>
                        <input type="text" id="f-address" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    
                    <div class="col-md-12 mt-3 p-2 bg-light border rounded">
                        <strong>Current Household: </strong> 
                        <span id="f-hh-display" class="text-primary fw-bold">No Household Assigned</span>
                    </div>

                    <div class="col-md-12 mt-4 text-end">
                        <button class="btn btn-secondary me-2" onclick="showHome()">Cancel</button>
                        <button class="btn btn-danger me-2" id="btn-del" style="display:none;" onclick="deleteRecord()">Delete</button>
                        <button class="btn btn-primary px-4" onclick="saveRecord()">Save Record</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-hh" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Household Management</h2>
                <div>
                     <button class="btn btn-dark me-2" onclick="printHHHeads()"><i class="fas fa-print"></i> Print Household Heads</button>
                     <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-new-hh"><i class="fas fa-plus"></i> New Household</button>
                </div>
            </div>
            
            <div class="row" id="hh-view" style="display:none;">
                <div class="col-md-12 mb-3">
                     <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('hh-view').style.display='none'; document.getElementById('hh-list-container').style.display='block';">Back to List</button>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h4 id="view-hh-title" class="text-primary mb-3"></h4>
                        <p class="mb-1"><strong>Purok:</strong> <span id="view-hh-purok">-</span></p>
                        <p class="mb-3"><strong>House No:</strong> <span id="view-hh-num">-</span></p>
                        <input type="hidden" id="manage-hh-name">
                        <button class="btn btn-primary w-100 mb-2" onclick="showAddMemberModal()"><i class="fas fa-user-plus"></i> Add Member</button>
                        
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn btn-outline-dark" onclick="printFormA()"><i class="fas fa-print"></i> Print Form A (Household)</button>
                        </div>
                        
                        <div class="border-top pt-3">
                            <label class="small text-muted mb-2">Manage Household</label>
                            <button class="btn btn-warning w-100 mb-2 btn-sm" onclick="showEditHHModal()"><i class="fas fa-edit"></i> Edit Details</button>
                            <button class="btn btn-danger w-100 btn-sm" onclick="deleteHH()"><i class="fas fa-trash"></i> Delete Household</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-3">
                        <h5>Members</h5>
                        <table class="table table-bordered table-hover">
                            <thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead>
                            <tbody id="hh-members-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="hh-list-container">
                <input type="text" class="form-control mb-3" placeholder="Search Household..." onkeyup="filterHHList(this.value)" oninput="this.value = this.value.toUpperCase()">
                <ul class="list-group" id="hh-list"></ul>
            </div>
        </div>

        <div id="section-deaths" class="d-none">
             <h2 class="text-danger mb-4">Death Registry <span class="badge bg-danger rounded-pill" id="death-total">0</span></h2>
             <div class="row" id="death-list"></div>
        </div>

        <div id="section-import" class="d-none">
            <h2>Data Import / Export</h2>
            <div class="row g-4 mt-2">
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4><i class="fas fa-file-excel text-success"></i> Export Data</h4>
                        <p>Download database compatible with DILG BIMS (Excel format).</p>
                        <button class="btn btn-success" onclick="processExport()">Download BIMS Excel</button>
                        <hr>
                        <h4><i class="fas fa-database text-primary"></i> System Backup</h4>
                        <p>Full system backup (JSON) including settings and logs.</p>
                        <button class="btn btn-primary" onclick="backupData()">Download Backup</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4><i class="fas fa-upload text-warning"></i> Import Data</h4>
                        <p>Restore from Backup or Import New Excel Format.</p>
                        <input type="file" id="import-file" class="form-control mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning" onclick="previewImport()">Process Excel</button>
                            <input type="file" id="restore-file" class="d-none" onchange="restoreData(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()">Restore JSON Backup</button>
                        </div>
                        <small class="text-muted mt-2">Note: Supports new Excel format.</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-settings" class="d-none">
            <h2>System Configuration</h2>
            <div class="card card-custom p-4 mt-3" style="max-width: 600px;">
                <div class="mb-3">
                    <label>LGU Type</label>
                    <select id="set-lgu-type" class="form-select">
                        <option value="MUNICIPALITY">MUNICIPALITY</option>
                        <option value="CITY">CITY</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Region</label>
                    <input type="text" id="set-region" class="form-control text-uppercase" placeholder="e.g. REGION II" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="mb-3">
                    <label>Province</label>
                    <input type="text" id="set-prov" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="mb-3">
                    <label>Municipality/City</label>
                    <input type="text" id="set-muni" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="mb-3">
                    <label>Barangay</label>
                    <input type="text" id="set-brgy" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="mb-3">
                    <label>Punong Barangay (Signatory)</label>
                    <input type="text" id="set-captain" class="form-control text-uppercase" placeholder="Full Name of Captain" oninput="this.value = this.value.toUpperCase()">
                </div>
                <div class="mb-3">
                    <label>Barangay Secretary (Signatory)</label>
                    <input type="text" id="set-sec" class="form-control text-uppercase" placeholder="Full Name of Secretary" oninput="this.value = this.value.toUpperCase()">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modal-new-hh" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Create New Household</h5></div><div class="modal-body"><label>Household Name (Family Name)</label><input type="text" id="new-hh-name" class="form-control text-uppercase mb-2" oninput="this.value = this.value.toUpperCase()"><label>Purok</label><input type="text" id="new-hh-purok" class="form-control text-uppercase mb-2" oninput="this.value = this.value.toUpperCase()"><label>House Number</label><input type="text" id="new-hh-num" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary" onclick="createHH()">Create</button></div></div></div></div>
    
    <div class="modal fade" id="modal-edit-hh" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Edit Household Details</h5></div><div class="modal-body"><input type="hidden" id="edit-hh-old-name"><label>Household Name (Family Name)</label><input type="text" id="edit-hh-name" class="form-control text-uppercase mb-2" oninput="this.value = this.value.toUpperCase()"><label>Purok</label><input type="text" id="edit-hh-purok" class="form-control text-uppercase mb-2" oninput="this.value = this.value.toUpperCase()"><label>House Number</label><input type="text" id="edit-hh-num" class="form-control text-uppercase" oninput="this.value = this.value.toUpperCase()"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-success" onclick="saveEditedHH()">Save Changes</button></div></div></div></div>

    <div class="modal fade" id="modal-add-mem" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5>Add Member to Household</h5></div><div class="modal-body"><input type="text" id="search-mem-hh" class="form-control mb-2" placeholder="Search Resident..." onkeyup="searchMemForHH()" oninput="this.value = this.value.toUpperCase()"><div class="list-group" id="hh-search-results" style="max-height: 300px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('modal-add-mem')">Close</button></div></div></div></div>
    
    <div class="modal fade" id="modal-select-role" tabindex="-1"><div class="modal-dialog modal-sm"><div class="modal-content"><div class="modal-header"><h5>Select Role</h5></div><div class="modal-body"><input type="hidden" id="temp-mem-id"><select id="select-role-input" class="form-select"><option value="HEAD">HEAD OF FAMILY</option><option value="SPOUSE">SPOUSE</option><option value="SON">SON</option><option value="DAUGHTER">DAUGHTER</option><option value="MEMBER">MEMBER (Other)</option></select></div><div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="confirmAddToHH()">Add</button></div></div></div></div>

    <div class="modal" id="modal-import" tabindex="-1" style="background:rgba(0,0,0,0.5);"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5>Import Preview</h5></div><div class="modal-body">
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><a class="nav-link active" onclick="showImportTab('valid')" href="#">Valid (<span id="count-valid">0</span>)</a></li>
            <li class="nav-item"><a class="nav-link text-warning" onclick="showImportTab('dup')" href="#">Duplicates (<span id="count-dup">0</span>)</a></li>
            <li class="nav-item"><a class="nav-link text-danger" onclick="showImportTab('invalid')" href="#">Incomplete (<span id="count-invalid">0</span>)</a></li>
        </ul>
        
        <div id="view-valid" class="import-view" style="max-height:400px; overflow-y:auto;">
            <p class="text-success">Ready to import <span id="lbl-valid-count">0</span> records.</p>
        </div>
        
        <div id="view-dup" class="import-view d-none" style="max-height:400px; overflow-y:auto;">
            <div class="alert alert-warning small">Records already exist in the system. They are excluded from this import.</div>
            <div id="list-dup" class="text-warning small"></div>
        </div>
        
        <div id="view-invalid" class="import-view d-none" style="max-height:400px; overflow-y:auto;">
             <p class="text-muted small">Please fill in the missing required fields (Last, First, Birthdate, Sex) to move them to Valid list.</p>
             <div class="table-responsive">
                 <table class="table table-sm table-bordered correction-table">
                     <thead><tr><th>Row</th><th>Last Name</th><th>First Name</th><th>Birthdate</th><th>Sex</th><th>Action</th></tr></thead>
                     <tbody id="list-invalid-body"></tbody>
                 </table>
             </div>
        </div>

    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button><button class="btn btn-success" id="btn-commit-import" onclick="commitImport()" disabled>Import Valid Records</button></div></div></div></div>

    <div id="print-area"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
        // --- GLOBAL STATE ---
        let db = JSON.parse(localStorage.getItem('rbi_db')) || [];
        let household_db = JSON.parse(localStorage.getItem('rbi_hh_db')) || []; 
        let settings = JSON.parse(localStorage.getItem('rbi_settings')) || {
            user_password: null,
            barangay: '', province: '', municipality: '', secretary: '', region: '', captain: '', lguType: 'MUNICIPALITY'
        };

        // Pagination & Search
        let currentPage = 1;
        const itemsPerPage = 10;
        let searchTimeout = null;

        // Import Staging
        let stagingValid = [], stagingInvalid = [], stagingDup = [];
        let confirmCallback = null;

        document.addEventListener("DOMContentLoaded", () => {
            // Login Logic
            if(settings.user_password) {
                document.getElementById('login-phase-1').classList.add('d-none');
                document.getElementById('login-phase-2').classList.add('d-none');
                document.getElementById('login-phase-3').classList.remove('d-none');
            } else {
                document.getElementById('login-phase-1').classList.remove('d-none');
                document.getElementById('login-phase-2').classList.add('d-none');
                document.getElementById('login-phase-3').classList.add('d-none');
            }
            
            // Confirm Modal Listener
            document.getElementById('btn-confirm-yes').addEventListener('click', () => {
                if(confirmCallback) confirmCallback();
                const el = document.getElementById('modal-custom-confirm');
                const modal = bootstrap.Modal.getInstance(el);
                if(modal) modal.hide();
            });

            updateServerTime();
            renderList();
        });

        // --- MOBILE SIDEBAR TOGGLE ---
        function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (forceClose) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

        // --- HELPER: CUSTOM ALERTS & CONFIRM ---
        function showAlert(title, message, iconClass = 'text-primary') {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-message').innerText = message;
            const iconContainer = document.getElementById('alert-icon-container');
            let iconHtml = '';
            if(title.toLowerCase().includes('error') || title.toLowerCase().includes('delete') || title.toLowerCase().includes('duplicate')) 
                iconHtml = '<i class="fas fa-exclamation-circle text-danger alert-icon"></i>';
            else if(title.toLowerCase().includes('success') || title.toLowerCase().includes('restored')) 
                iconHtml = '<i class="fas fa-check-circle text-success alert-icon"></i>';
            else 
                iconHtml = `<i class="fas fa-info-circle ${iconClass} alert-icon"></i>`;
            iconContainer.innerHTML = iconHtml;
            new bootstrap.Modal(document.getElementById('modal-custom-alert')).show();
        }

        function showConfirm(title, message, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;
            confirmCallback = callback;
            new bootstrap.Modal(document.getElementById('modal-custom-confirm')).show();
        }

        // --- SEARCH DELAY ---
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                renderList();
            }, 300);
        }

        // --- SECURITY ---
        function updateServerTime() {
            const now = new Date();
            document.getElementById('server-time-display').innerText = `System Time: ${now.toLocaleString()}`;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        }

        function numToLetter(num) {
            let s = '';
            while(num > 0) {
                let t = (num - 1) % 26;
                s = String.fromCharCode(97 + t) + s;
                num = Math.floor((num - 1) / 26);
            }
            return s;
        }

        function checkDynamic() {
            const input = document.getElementById('dynamic-code').value;
            const now = new Date();
            const month = now.getMonth(); 
            const day = now.getDate();
            const year = now.getFullYear();
            const week = getWeekNumber(now) * 2;
            const dayLetter = numToLetter(day);
            const hours = now.getHours(); 
            const ampm = hours >= 12 ? 'mp' : 'ma'; 
            const hourLetter = String.fromCharCode(97 + hours);
            const code = `RBI-${month}${day}${year}${week}${dayLetter}${ampm}${hourLetter}`;
            
            if(input === code) {
                if(settings.user_password) {
                    document.getElementById('login-phase-1').classList.add('d-none');
                    document.getElementById('login-phase-2').classList.remove('d-none');
                } else {
                    document.getElementById('login-phase-1').classList.add('d-none');
                    document.getElementById('login-phase-2').classList.remove('d-none');
                }
            } else {
                showAlert("Access Denied", "Incorrect Access Code.", "text-danger");
            }
        }

        function setCustomPassword() {
            const p1 = document.getElementById('new-custom-pass').value;
            const p2 = document.getElementById('confirm-custom-pass').value;
            if(!p1 || p1 !== p2) return showAlert("Error", "Passwords do not match or are empty.");
            settings.user_password = p1;
            localStorage.setItem('rbi_settings', JSON.stringify(settings));
            showAlert("Success", "Password set successfully!");
            document.getElementById('security-overlay').classList.add('d-none');
        }

        function verifyCustomPassword() {
            const input = document.getElementById('input-custom-pass').value;
            if(input === settings.user_password) {
                document.getElementById('security-overlay').classList.add('d-none');
                document.getElementById('main-container').classList.remove('d-none');
                document.querySelector('.sidebar').style.display = 'block';
            } else {
                showAlert("Access Denied", "Incorrect Password.");
            }
        }

        function forgotPassword() {
            document.getElementById('login-phase-2').classList.add('d-none');
            document.getElementById('login-phase-3').classList.add('d-none');
            document.getElementById('login-phase-1').classList.remove('d-none');
            showAlert("Reset", "Please enter the Dynamic Access Code to reset your password.");
        }
        
        function logout() { 
            document.getElementById('main-container').classList.add('d-none');
            document.querySelector('.sidebar').style.display = 'none';
            document.getElementById('security-overlay').classList.remove('d-none');
            document.getElementById('login-phase-1').classList.add('d-none');
            document.getElementById('login-phase-2').classList.add('d-none');
            document.getElementById('login-phase-3').classList.remove('d-none');
            document.getElementById('input-custom-pass').value = '';
        }
        
        // --- CORE FUNCTIONS ---
        function saveDB() {
            localStorage.setItem('rbi_db', JSON.stringify(db));
            localStorage.setItem('rbi_hh_db', JSON.stringify(household_db));
            updateReportUI();
        }

        function hideAll() {
            ['section-home','section-add','section-hh','section-import','section-settings','section-deaths'].forEach(id => {
                document.getElementById(id).classList.add('d-none');
            });
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        }

        function showHome() { hideAll(); document.getElementById('section-home').classList.remove('d-none'); renderList(); }
        function showAdd() { hideAll(); document.getElementById('section-add').classList.remove('d-none'); clearForm(); }
        function showHouseholds() { hideAll(); document.getElementById('section-hh').classList.remove('d-none'); renderHHList(); }
        function showImport() { hideAll(); document.getElementById('section-import').classList.remove('d-none'); }
        
        function showSettings() { 
            hideAll(); 
            document.getElementById('section-settings').classList.remove('d-none');
            document.getElementById('set-lgu-type').value = settings.lguType || 'MUNICIPALITY';
            document.getElementById('set-region').value = settings.region || '';
            document.getElementById('set-prov').value = settings.province || '';
            document.getElementById('set-muni').value = settings.municipality || '';
            document.getElementById('set-brgy').value = settings.barangay || '';
            document.getElementById('set-captain').value = settings.captain || '';
            document.getElementById('set-sec').value = settings.secretary || '';
        }
        
        function showDeaths() { hideAll(); document.getElementById('section-deaths').classList.remove('d-none'); renderDeathList(); }

        function calculateAgeDetailed(bdate) {
            if(!bdate) return { y: 0, m: 0, d: 0, totalMonths: 0 };
            const birth = new Date(bdate);
            const now = new Date();
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            let days = now.getDate() - birth.getDate();
            if (days < 0) { months--; days += 30; }
            if (months < 0) { years--; months += 12; }
            return { y: years, m: months, d: days, totalMonths: (years * 12) + months };
        }

        // --- MOTHER'S NAME SEARCH FIX ---
        function searchMother(val) {
            const list = document.getElementById('mother-search-results');
            if(!val || val.length < 2) { list.classList.add('d-none'); return; }
            
            // Case-Insensitive Search
            const matches = db.filter(r => 
                r.sex === 'FEMALE' && 
                !r.isDead && 
                (r.last + ' ' + r.first).toUpperCase().includes(val.toUpperCase())
            );
            
            list.innerHTML = '';
            if(matches.length > 0) {
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `<strong>${m.last}, ${m.first}</strong> <small>(${m.middle||'-'})</small>`;
                    div.onclick = () => {
                        document.getElementById('f-m-last').value = m.last;
                        document.getElementById('f-m-first').value = m.first;
                        document.getElementById('f-m-middle').value = m.middle;
                        document.getElementById('mother-search-input').value = '';
                        list.classList.add('d-none');
                    };
                    list.appendChild(div);
                });
                list.classList.remove('d-none');
            } else {
                list.classList.add('d-none');
            }
        }

        // --- CRUD OPERATIONS ---
        function saveRecord() {
            const id = document.getElementById('rec-id').value;
            const last = document.getElementById('f-last').value.toUpperCase();
            const first = document.getElementById('f-first').value.toUpperCase();
            const bdate = document.getElementById('f-bdate').value;

            if(!last || !first || !bdate) return showAlert("Validation Error", "Last Name, First Name, and Birthdate are required.");
            if(!id) {
                const exists = db.some(x => x.last === last && x.first === first && x.bdate === bdate);
                if(exists) return showAlert("Duplicate", "Resident already exists!");
            }
            
            // Handle College Level Mapping
            let eduVal = document.getElementById('f-edu').value;
            if(eduVal === 'COLLEGE LEVEL') eduVal = 'COLLEGE UNDERGRAD';

            const currentRec = id ? db.find(x=>x.id===id) : null;
            const record = {
                id: id || Date.now().toString(),
                type: document.getElementById('f-type').value,
                last: last,
                first: first,
                middle: document.getElementById('f-middle').value.toUpperCase(),
                suffix: document.getElementById('f-suffix').value.toUpperCase(),
                bdate: bdate,
                sex: document.getElementById('f-sex').value,
                civil: document.getElementById('f-civil').value,
                religion: document.getElementById('f-religion').value.toUpperCase(),
                citizen: document.getElementById('f-citizen').value,
                philsys: document.getElementById('f-philsys').value.toUpperCase(),
                bplace: document.getElementById('f-bplace').value.toUpperCase(),
                prof: document.getElementById('f-prof').value.toUpperCase(),
                mother_last: document.getElementById('f-m-last').value.toUpperCase(),
                mother_first: document.getElementById('f-m-first').value.toUpperCase(),
                mother_middle: document.getElementById('f-m-middle').value.toUpperCase(),
                isSoloParent: document.getElementById('f-solo').checked,
                isPwd: document.getElementById('f-pwd').checked,
                is4Ps: document.getElementById('f-4ps').checked, 
                isOfw: document.getElementById('f-ofw').checked,
                isIp: document.getElementById('f-ip').checked,
                isOsc: document.getElementById('f-osc').checked,
                isOSY: document.getElementById('f-osy').checked,
                isUnemployed: document.getElementById('f-unemployed').checked,
                isDead: document.getElementById('f-dead').checked,
                deathDate: document.getElementById('f-death-date').value,
                contact: document.getElementById('f-contact').value.toUpperCase(),
                email: document.getElementById('f-email').value.toUpperCase(),
                edu: eduVal,
                address: document.getElementById('f-address').value.toUpperCase(),
                hh_name: currentRec ? currentRec.hh_name : '',
                hh_role: currentRec ? currentRec.hh_role : 'MEMBER'
            };

            if(id) { const index = db.findIndex(x => x.id === id); db[index] = record; } else { db.push(record); }
            saveDB();
            showAlert("Success", "Record Saved Successfully!");
            if(record.isDead) showDeaths();
            else showHome(); 
        }

        function loadRecord(id) {
            const r = db.find(x => x.id === id);
            if(!r) return;
            showAdd();
            document.getElementById('rec-id').value = r.id;
            document.getElementById('f-type').value = r.type;
            document.getElementById('f-last').value = r.last;
            document.getElementById('f-first').value = r.first;
            document.getElementById('f-middle').value = r.middle;
            document.getElementById('f-suffix').value = r.suffix;
            document.getElementById('f-bdate').value = r.bdate;
            document.getElementById('f-sex').value = r.sex;
            document.getElementById('f-civil').value = r.civil;
            document.getElementById('f-religion').value = r.religion || '';
            document.getElementById('f-citizen').value = r.citizen || 'FILIPINO';
            document.getElementById('f-philsys').value = r.philsys || '';
            document.getElementById('f-bplace').value = r.bplace || '';
            document.getElementById('f-prof').value = r.prof || '';
            document.getElementById('f-m-last').value = r.mother_last || '';
            document.getElementById('f-m-first').value = r.mother_first || '';
            document.getElementById('f-m-middle').value = r.mother_middle || '';
            document.getElementById('f-solo').checked = r.isSoloParent || false;
            document.getElementById('f-pwd').checked = r.isPwd || false;
            document.getElementById('f-4ps').checked = r.is4Ps || false; 
            document.getElementById('f-ofw').checked = r.isOfw || false;
            document.getElementById('f-ip').checked = r.isIp || false;
            document.getElementById('f-osc').checked = r.isOsc || false;
            document.getElementById('f-osy').checked = r.isOSY || false;
            document.getElementById('f-unemployed').checked = r.isUnemployed || false;
            document.getElementById('f-dead').checked = r.isDead || false;
            document.getElementById('f-death-date').value = r.deathDate || '';
            toggleDeathInput(); 
            document.getElementById('f-contact').value = r.contact || '';
            document.getElementById('f-email').value = r.email || '';
            document.getElementById('f-edu').value = r.edu || '';
            document.getElementById('f-address').value = r.address || '';
            let hhTxt = r.hh_name ? r.hh_name : 'No Household Assigned';
            if(r.hh_name && r.hh_role) hhTxt += ` (${r.hh_role})`;
            document.getElementById('f-hh-display').value = hhTxt;
            document.getElementById('btn-del').style.display = 'inline-block';
        }

        function deleteRecord() {
            const id = document.getElementById('rec-id').value;
            showConfirm("Delete Record", "Are you sure you want to delete this resident?", () => {
                db = db.filter(x => x.id !== id);
                saveDB();
                showAlert("Deleted", "Record deleted.");
                showHome();
            });
        }

        function clearForm() {
            document.querySelectorAll('#section-add input').forEach(i => i.value = '');
            document.querySelectorAll('#section-add select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('#section-add input[type=checkbox]').forEach(c => c.checked = false);
            document.getElementById('f-citizen').value = 'FILIPINO';
            document.getElementById('f-religion').value = ''; 
            document.getElementById('btn-del').style.display = 'none';
            document.getElementById('mother-search-results').classList.add('d-none');
            toggleDeathInput();
        }

        function toggleDeathInput() {
            const isDead = document.getElementById('f-dead').checked;
            const container = document.getElementById('death-date-container');
            if(isDead) container.classList.remove('d-none');
            else {
                container.classList.add('d-none');
                document.getElementById('f-death-date').value = '';
            }
        }

        // --- DASHBOARD LIST ---
        function renderList() {
            const q = document.getElementById('search-input').value.toUpperCase();
            const list = document.getElementById('record-list');
            list.innerHTML = '';
            
            const filtered = db.filter(r => {
                const fullName = (r.last + ' ' + r.first + ' ' + (r.middle||'')).toUpperCase();
                const hh = (r.hh_name || '').toUpperCase();
                return (fullName.includes(q) || hh.includes(q)) && !r.isDead;
            });
            
            if(filtered.length === 0) {
                list.innerHTML = '<div class="text-center p-4 text-muted">No residents found.</div>';
                updateReportUI();
                return;
            }

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            if(currentPage > totalPages) currentPage = totalPages || 1;
            
            const start = (currentPage - 1) * itemsPerPage;
            const paginatedItems = filtered.slice(start, start + itemsPerPage);
            
            paginatedItems.forEach(r => {
                const age = calculateAgeDetailed(r.bdate).y;
                const item = document.createElement('div');
                item.className = 'card card-custom p-3 mb-2';
                item.style.cursor = 'pointer';
                item.onclick = () => loadRecord(r.id);
                
                let badges = '';
                if(r.isPwd) badges += '<span class="badge bg-danger me-1">PWD</span>';
                if(r.isSoloParent) badges += '<span class="badge bg-info text-dark me-1">SOLO</span>';
                if(r.is4Ps) badges += '<span class="badge bg-success me-1">4Ps</span>';
                if(r.isOSY) badges += '<span class="badge bg-secondary me-1">OSY</span>';
                if(r.isOfw) badges += '<span class="badge bg-primary me-1">OFW</span>';

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0">${r.last}, ${r.first} ${r.suffix || ''}</h6>
                            <small class="text-muted">${r.sex} | ${age} y/o | ${r.civil}</small><br>
                            ${r.hh_name ? `<span class="badge bg-primary"><i class="fas fa-home"></i> ${r.hh_name}</span>` : '<span class="badge bg-light text-dark border">No HH</span>'}
                            ${badges}
                        </div>
                        <div class="no-print">
                            <button class="btn btn-sm btn-outline-dark" onclick="event.stopPropagation(); printFormB('${r.id}')"><i class="fas fa-print"></i> Form B</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });

            if (filtered.length > 0) {
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'd-flex justify-content-center align-items-center mt-3 gap-3';
                paginationDiv.innerHTML = `
                    <button class="btn btn-secondary btn-sm" onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                    <span class="fw-bold">Page ${currentPage} of ${totalPages}</span>
                    <button class="btn btn-secondary btn-sm" onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                `;
                list.appendChild(paginationDiv);
            }
            updateReportUI();
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderList(); } }
        function nextPage() {
            const q = document.getElementById('search-input').value.toUpperCase();
            const filtered = db.filter(r => ((r.last + ' ' + r.first).toUpperCase().includes(q)) && !r.isDead);
            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            if (currentPage < totalPages) { currentPage++; renderList(); }
        }

        // --- DEATH REGISTRY ---
        function renderDeathList() {
            const list = document.getElementById('death-list');
            list.innerHTML = '';
            const dead = db.filter(r => r.isDead);
            document.getElementById('death-total').innerText = dead.length;
            if(dead.length === 0) list.innerHTML = '<div class="col-12 text-center text-muted p-4">No records found.</div>';
            dead.forEach(r => {
                list.innerHTML += `
                    <div class="col-md-4 mb-3">
                    <div class="card p-3 border-danger" style="background:#fff0f0; cursor:pointer;" onclick="loadRecord('${r.id}')">
                         <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-0 text-danger">${r.last}, ${r.first}</h6>
                                <small>Died: ${r.deathDate || 'N/A'}</small>
                            </div>
                            <i class="fas fa-edit text-secondary"></i>
                        </div>
                    </div></div>`;
            });
        }

        // --- HOUSEHOLD LOGIC ---
        function renderHHList() {
            const list = document.getElementById('hh-list');
            list.innerHTML = '';
            let existingNames = new Set(db.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            let hhObjects = household_db.filter(h => h && h.name);
            let hhMap = {};
            hhObjects.forEach(h => hhMap[h.name] = h);
            let allNames = new Set([...existingNames, ...hhObjects.map(h => h.name)]);
            let sortedNames = [...allNames].sort();

            sortedNames.forEach(hName => {
                const meta = hhMap[hName] || { purok: '', houseNo: '' };
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action d-flex justify-content-between';
                li.innerHTML = `<div><strong>${hName}</strong><br><small class="text-muted">Purok: ${meta.purok || 'N/A'} | #: ${meta.houseNo || 'N/A'}</small></div><button class="btn btn-sm btn-primary align-self-center">Manage</button>`;
                li.onclick = () => loadHH(hName, meta.purok, meta.houseNo);
                list.appendChild(li);
            });
        }
        
        function filterHHList(q) {
             const items = document.querySelectorAll('#hh-list li');
             items.forEach(item => {
                 if(item.innerText.toUpperCase().includes(q.toUpperCase())) item.style.display = 'flex';
                 else item.style.display = 'none';
             });
        }

        function createHH() {
            const name = document.getElementById('new-hh-name').value.toUpperCase();
            const purok = document.getElementById('new-hh-purok').value.toUpperCase();
            const num = document.getElementById('new-hh-num').value.toUpperCase();
            if(!name) return showAlert("Error", 'Enter Name');
            const exists = household_db.some(h => h.name === name);
            if(!exists) { household_db.push({ name: name, purok: purok, houseNo: num }); saveDB(); }
            else { showAlert("Error", "Household Name already exists in registry."); return; }
            
            // FIX: Uses getOrCreateInstance for reliable closing
            const modalEl = document.getElementById('modal-new-hh');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.hide();
            
            loadHH(name, purok, num);
            renderHHList();
        }

        function loadHH(name, purok, num) {
            if(!purok || !num) { const meta = household_db.find(h => h.name === name); if(meta) { purok = meta.purok; num = meta.houseNo; } }
            document.getElementById('manage-hh-name').value = name;
            document.getElementById('view-hh-title').innerText = name;
            document.getElementById('view-hh-purok').innerText = purok || 'N/A';
            document.getElementById('view-hh-num').innerText = num || 'N/A';
            document.getElementById('hh-list-container').style.display = 'none';
            document.getElementById('hh-view').style.display = 'flex'; 
            renderHHMembers(name);
        }

        function showEditHHModal() {
            const name = document.getElementById('manage-hh-name').value;
            const meta = household_db.find(h => h.name === name) || { purok: '', houseNo: '' };
            
            document.getElementById('edit-hh-old-name').value = name;
            document.getElementById('edit-hh-name').value = name;
            document.getElementById('edit-hh-purok').value = meta.purok;
            document.getElementById('edit-hh-num').value = meta.houseNo;
            
            new bootstrap.Modal(document.getElementById('modal-edit-hh')).show();
        }

        function saveEditedHH() {
            const oldName = document.getElementById('edit-hh-old-name').value;
            const newName = document.getElementById('edit-hh-name').value.toUpperCase();
            const newPurok = document.getElementById('edit-hh-purok').value.toUpperCase();
            const newNum = document.getElementById('edit-hh-num').value.toUpperCase();

            if(!newName) return showAlert("Error", "Household Name cannot be empty");

            if(oldName !== newName && household_db.some(h => h.name === newName)) {
                return showAlert("Error", "Household Name already exists. Please choose another.");
            }

            let hh = household_db.find(h => h.name === oldName);
            if(hh) {
                hh.name = newName;
                hh.purok = newPurok;
                hh.houseNo = newNum;
            } else {
                household_db.push({ name: newName, purok: newPurok, houseNo: newNum });
            }

            if(oldName !== newName) {
                db.forEach(r => {
                    if(r.hh_name === oldName) {
                        r.hh_name = newName;
                    }
                });
            }

            saveDB();
            
            const el = document.getElementById('modal-edit-hh');
            const modal = bootstrap.Modal.getInstance(el);
            if(modal) modal.hide();

            loadHH(newName, newPurok, newNum);
            renderHHList();
            showAlert("Success", "Household details updated successfully.");
        }

        function deleteHH() {
            const name = document.getElementById('manage-hh-name').value;
            if(!confirm(`Are you sure you want to delete the household "${name}"?`)) return;

            db.forEach(r => {
                if(r.hh_name === name) {
                    r.hh_name = '';
                    r.hh_role = '';
                }
            });

            household_db = household_db.filter(h => h.name !== name);

            saveDB();
            showAlert("Deleted", "Household deleted.");
            document.getElementById('hh-view').style.display='none';
            document.getElementById('hh-list-container').style.display='block';
            renderHHList();
        }

        function renderHHMembers(hhName) {
            const tbody = document.getElementById('hh-members-body');
            tbody.innerHTML = '';
            const mems = db.filter(r => r.hh_name === hhName);
            mems.forEach(m => {
                tbody.innerHTML += `
                    <tr>
                        <td>${m.last}, ${m.first}</td>
                        <td>
                            <select onchange="updateRole('${m.id}', this.value)" class="form-select form-select-sm">
                                <option value="HEAD" ${m.hh_role==='HEAD'?'selected':''}>HEAD OF FAMILY</option>
                                <option value="SPOUSE" ${m.hh_role==='SPOUSE'?'selected':''}>SPOUSE</option>
                                <option value="SON" ${m.hh_role==='SON'?'selected':''}>SON</option>
                                <option value="DAUGHTER" ${m.hh_role==='DAUGHTER'?'selected':''}>DAUGHTER</option>
                                <option value="MEMBER" ${m.hh_role==='MEMBER'?'selected':''}>MEMBER (Other)</option>
                            </select>
                        </td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeFromHH('${m.id}')">Remove</button></td>
                    </tr>`;
            });
        }

        function updateRole(id, role) { const r = db.find(x => x.id === id); if(r) { r.hh_role = role; saveDB(); } }
        function removeFromHH(id) { const r = db.find(x => x.id === id); if(r) { r.hh_name = ''; r.hh_role = ''; saveDB(); renderHHMembers(document.getElementById('manage-hh-name').value); } }
        function showAddMemberModal() { new bootstrap.Modal(document.getElementById('modal-add-mem')).show(); }
        function closeModal(id) { const el = document.getElementById(id); const modal = bootstrap.Modal.getInstance(el); if(modal) modal.hide(); }

        function searchMemForHH() {
            const q = document.getElementById('search-mem-hh').value.toUpperCase();
            const res = document.getElementById('hh-search-results');
            res.innerHTML = '';
            db.filter(r => !r.hh_name && !r.isDead && (r.last+' '+r.first).toUpperCase().includes(q)).slice(0,10).forEach(r => {
                res.innerHTML += `<button class="list-group-item list-group-item-action" onclick="promptRole('${r.id}')">${r.last}, ${r.first}</button>`;
            });
        }

        function promptRole(id) {
            document.getElementById('temp-mem-id').value = id;
            closeModal('modal-add-mem');
            new bootstrap.Modal(document.getElementById('modal-select-role')).show();
        }

        function confirmAddToHH() {
            const id = document.getElementById('temp-mem-id').value;
            const role = document.getElementById('select-role-input').value;
            const hh = document.getElementById('manage-hh-name').value;
            const r = db.find(x => x.id === id);
            if(r) { r.hh_name = hh; r.hh_role = role; saveDB(); renderHHMembers(hh); closeModal('modal-select-role'); }
        }

        // --- UPDATED IMPORT LOGIC ---
        function previewImport() {
            const file = document.getElementById('import-file').files[0]; if(!file) return;
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, {type: 'binary'});
                    const isNewFormat = workbook.SheetNames.some(n => n.toUpperCase().includes("INSTRUCTION"));
                    let sheetName = "";
                    
                    if (isNewFormat) {
                        sheetName = workbook.SheetNames.find(n => n.toUpperCase().includes("DATA"));
                        if(!sheetName) sheetName = workbook.SheetNames[1]; 
                    } else {
                        sheetName = "DATA"; 
                        if(!workbook.Sheets[sheetName]) sheetName = workbook.SheetNames[1] || workbook.SheetNames[0];
                    }

                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                    
                    stagingValid = []; stagingInvalid = []; stagingDup = [];
                    
                    const startRow = (json[0] && json[0][0] && json[0][0].toString().includes("INHABITANT")) ? 1 : 0;
                    
                    for(let i=startRow; i<json.length; i++) {
                        const row = json[i]; if(!row || row.length === 0) continue;
                        
                        let tempRec = {};
                        
                        if(isNewFormat) {
                            // NEW FORMAT MAPPING
                            let purok = row[17] ? row[17].toString().toUpperCase() : '';
                            let addAddr = row[18] ? row[18].toString().toUpperCase() : '';
                            let fullAddr = "";
                            if(purok && purok !== 'NONE') fullAddr += "PUROK " + purok;
                            if(addAddr) fullAddr += (fullAddr ? (fullAddr ? " - " : "") + addAddr : "");
                            
                            const isYes = (val) => val && val.toString().toUpperCase() === 'YES';
                            
                            // Map Edu
                            let edu = row[13] || '';
                            if(edu.toString().toUpperCase() === 'COLLEGE LEVEL') edu = 'COLLEGE UNDERGRAD';

                            tempRec = {
                                type: row[0], last: row[1], first: row[2], middle: row[3] || '', suffix: row[4] || '', 
                                bplace: row[5] || '', bdate: row[6], sex: row[7], civil: row[8], citizen: row[9] || 'FILIPINO',
                                prof: row[10] || '', contact: row[11] || '', email: row[12] || '', edu: edu,
                                mother_first: row[14] || '', mother_middle: row[15] || '', mother_last: row[16] || '',
                                address: fullAddr,
                                religion: row[19] || '',
                                isOSY: isYes(row[20]),
                                isPwd: isYes(row[21]),
                                is4Ps: isYes(row[22]),
                                isIp: isYes(row[23]),
                                isSoloParent: isYes(row[24]),
                                isOfw: isYes(row[26]),
                                isOsc: false, isUnemployed: false, isDead: false, hh_name: '', hh_role: 'MEMBER'
                            };

                        } else {
                            // OLD FORMAT
                            let edu = row[14] || '';
                            if(edu.toString().toUpperCase() === 'COLLEGE LEVEL') edu = 'COLLEGE UNDERGRAD';
                            
                            tempRec = {
                                type: row[0], last: row[1], first: row[2], middle: row[3] || '', suffix: row[4] || '', bplace: row[5] || '', bdate: row[6], sex: row[7], civil: row[8], citizen: row[9] || 'FILIPINO', religion: row[10] || '',
                                prof: row[11] || '', contact: row[12] || '', email: row[13] || '', edu: edu, mother_first: row[15] || '', mother_middle: row[16] || '', mother_last: row[17] || '',
                                isPwd: false, isSoloParent: false, isOSY: false, isDead: false, is4Ps: false, address: '', hh_name: '', hh_role: 'MEMBER'
                            };
                        }

                        // Uppercase Enforcement
                        if(tempRec.last) tempRec.last = tempRec.last.toString().toUpperCase();
                        if(tempRec.first) tempRec.first = tempRec.first.toString().toUpperCase();
                        if(tempRec.middle) tempRec.middle = tempRec.middle.toString().toUpperCase();
                        if(tempRec.religion) tempRec.religion = tempRec.religion.toString().toUpperCase();

                        // VALIDATION
                        if(!tempRec.last || !tempRec.first || !tempRec.bdate || !tempRec.sex) { 
                            tempRec.tempId = Date.now() + Math.random().toString();
                            stagingInvalid.push({ line: i+1, data: tempRec }); 
                            continue; 
                        }

                        // DUPLICATE CHECK
                        const existsInDB = db.find(x => x.last === tempRec.last && x.first === tempRec.first && x.bdate === tempRec.bdate);
                        
                        // FIX: If duplicate, allow in Staging Dup ONLY. Do NOT add to Valid.
                        if(existsInDB) { 
                             tempRec.id = existsInDB.id;
                             stagingDup.push({ line: i+1, name: `${tempRec.last}, ${tempRec.first}`, data: tempRec, isOverwrite: false }); 
                             continue; // SKIP pushing to stagingValid
                        }
                        
                        // New Record
                        tempRec.id = (Date.now() + i).toString();
                        stagingValid.push(tempRec);
                    }

                    renderImportModal();
                    
                } catch(err) { console.error(err); showAlert("Import Error", "Failed to read file."); }
            }; reader.readAsBinaryString(file);
        }

        function renderImportModal() {
            document.getElementById('count-valid').innerText = stagingValid.length; 
            document.getElementById('lbl-valid-count').innerText = stagingValid.length;
            document.getElementById('count-invalid').innerText = stagingInvalid.length; 
            document.getElementById('count-dup').innerText = stagingDup.length;
            
            document.getElementById('btn-commit-import').disabled = (stagingValid.length === 0);
            
            document.getElementById('list-dup').innerHTML = stagingDup.map(x => `
                <div class="border-bottom p-1 d-flex justify-content-between">
                    <span>Row ${x.line}: ${x.name}</span>
                    <span class="badge bg-secondary text-white">Ignored (Exists)</span>
                </div>`).join('');
            
            const invBody = document.getElementById('list-invalid-body');
            invBody.innerHTML = '';
            stagingInvalid.forEach(item => {
                const d = item.data;
                invBody.innerHTML += `
                    <tr id="inv-row-${d.tempId}">
                        <td>${item.line}</td>
                        <td><input type="text" value="${d.last||''}" onchange="updateInvalidRow('${d.tempId}', 'last', this.value)" placeholder="Required"></td>
                        <td><input type="text" value="${d.first||''}" onchange="updateInvalidRow('${d.tempId}', 'first', this.value)" placeholder="Required"></td>
                        <td><input type="date" value="${d.bdate||''}" onchange="updateInvalidRow('${d.tempId}', 'bdate', this.value)"></td>
                        <td>
                            <select onchange="updateInvalidRow('${d.tempId}', 'sex', this.value)">
                                <option value="">Select</option>
                                <option value="MALE" ${d.sex==='MALE'?'selected':''}>MALE</option>
                                <option value="FEMALE" ${d.sex==='FEMALE'?'selected':''}>FEMALE</option>
                            </select>
                        </td>
                        <td><button class="btn btn-sm btn-success" onclick="checkInvalidRow('${d.tempId}')"><i class="fas fa-check"></i></button></td>
                    </tr>
                `;
            });

            document.getElementById('modal-import').style.display = 'block'; 
            document.getElementById('modal-import').classList.add('show'); 
            showImportTab(stagingInvalid.length > 0 ? 'invalid' : 'valid');
        }

        function updateInvalidRow(tempId, field, value) {
            const item = stagingInvalid.find(x => x.data.tempId === tempId);
            if(item) {
                if(field !== 'bdate') value = value.toUpperCase();
                item.data[field] = value;
            }
        }

        function checkInvalidRow(tempId) {
            const index = stagingInvalid.findIndex(x => x.data.tempId === tempId);
            if(index === -1) return;
            const item = stagingInvalid[index];
            const d = item.data;

            if(d.last && d.first && d.bdate && d.sex) {
                d.id = Date.now().toString() + Math.random();
                stagingValid.push(d);
                stagingInvalid.splice(index, 1);
                renderImportModal(); 
            } else {
                showAlert("Missing Info", "Please fill all required columns (Last, First, Bdate, Sex)");
            }
        }

        function showImportTab(tab) { document.querySelectorAll('.import-view').forEach(el => el.classList.add('d-none')); document.getElementById('view-'+tab).classList.remove('d-none'); }
        function closeImportModal() { document.getElementById('modal-import').style.display = 'none'; document.getElementById('modal-import').classList.remove('show'); document.getElementById('import-file').value = ''; }
        
        function commitImport() { 
            if(stagingValid.length === 0) return; 
            
            // Just concat since duplicates are already excluded in preview
            db = db.concat(stagingValid);

            saveDB(); 
            closeImportModal(); 
            showAlert("Import Success", `Imported successfully!\nAdded: ${stagingValid.length}`); 
            showHome(); 
        }

        function saveSettings() {
            const sec = document.getElementById('set-sec').value; 
            const brgy = document.getElementById('set-brgy').value; 
            const prov = document.getElementById('set-prov').value; 
            const muni = document.getElementById('set-muni').value; 
            const lguType = document.getElementById('set-lgu-type').value;
            const region = document.getElementById('set-region').value;
            const captain = document.getElementById('set-captain').value;

            if(!sec || !brgy) return showAlert("Error", "Please fill in Barangay and Secretary name.");
            
            settings.secretary = sec.toUpperCase(); 
            settings.barangay = brgy.toUpperCase(); 
            settings.province = prov ? prov.toUpperCase() : ''; 
            settings.municipality = muni ? muni.toUpperCase() : ''; 
            settings.lguType = lguType;
            settings.region = region ? region.toUpperCase() : '';
            settings.captain = captain ? captain.toUpperCase() : '';

            localStorage.setItem('rbi_settings', JSON.stringify(settings)); 
            showAlert("Success", 'Configuration Saved!');
        }

        // --- BULK PRINT FORM B ---
        function printAllFormB() {
            const living = db.filter(r => !r.isDead);
            if(living.length === 0) return showAlert("Info", "No records to print.");
            
            let allHtml = "";
            living.forEach(r => {
                allHtml += generateFormBHTML(r) + '<div class="page-break"></div>';
            });
            
            const area = document.getElementById('print-area');
            area.innerHTML = allHtml;
            window.print();
        }

        function printFormB(id) {
            const r = db.find(x => x.id === id); if (!r) return;
            const html = generateFormBHTML(r);
            const area = document.getElementById('print-area'); area.innerHTML = html; window.print();
        }

        function generateFormBHTML(r) {
            const chk = (val, target) => (val === target) ? '&#9745;' : '&#9744;';
            const edu = r.edu || '';
            let isElem = edu === 'ELEMENTARY'; let isHS = edu === 'HIGH SCHOOL'; let isCol = edu.includes('COLLEGE'); let isPost = edu === 'POST GRAD'; let isVoc = edu === 'VOCATIONAL'; let isGrad = edu.includes('GRADUATE') && !edu.includes('UNDER'); let isUnder = edu.includes('UNDER');
            let hhNum = ''; if (r.hh_name) { const hhObj = household_db.find(h => h.name === r.hh_name); if (hhObj) hhNum = hhObj.houseNo; }
            
            return `<style>.form-b-container { font-family: Arial, sans-serif; width: 100%; max-width: 800px; margin: 0 auto; color: black; } .form-header { text-align: center; margin-bottom: 20px; text-transform: uppercase; line-height: 1.2; } .form-title { font-weight: 800; font-size: 13pt; margin-top: 15px; } .main-box { border: 2px solid black; padding: 2px; } .box-title { text-align: center; font-weight: bold; padding: 5px; font-size: 11pt; margin-bottom: 10px; } .input-box { border: 1px solid black; height: 25px; display: flex; align-items: center; padding-left: 5px; font-weight: bold; font-size: 10pt; background: #fff; } .label-under { text-align: center; font-size: 8pt; margin-top: 2px; margin-bottom: 5px; } .layout-table { width: 100%; border-collapse: separate; border-spacing: 5px 0; } .layout-table td { vertical-align: bottom; } .chk-group { display: flex; gap: 10px; font-size: 9pt; align-items: center; margin-left: 10px; } .chk-box { font-size: 14pt; line-height: 10pt; } .legal-text { text-align: justify; font-size: 8pt; margin: 15px 5px; line-height: 1.1; } .thumb-box { border: 1px solid black; width: 80px; height: 80px; margin: 0 auto; } .sig-line { border-bottom: 1px solid black; margin-top: 30px; } </style><div class="form-b-container"><div class="form-header"><div style="font-size: 9pt;">RBI Form B (Revised 2024)</div><div class="form-title">INDIVIDUAL RECORDS OF BARANGAY INHABITANT</div></div><table style="width:100%; font-size: 9pt; font-weight: bold; margin-bottom: 10px;"><tr><td width="10%">REGION</td><td width="2%">:</td><td style="border-bottom: 1px solid black;">${settings.region}</td><td width="5%"></td><td width="15%">CITY/MUN</td><td width="2%">:</td><td style="border-bottom: 1px solid black;">${settings.municipality}</td></tr><tr><td>PROVINCE</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.province}</td><td></td><td>BARANGAY</td><td>:</td><td style="border-bottom: 1px solid black;">${settings.barangay}</td></tr></table><div class="main-box"><div class="box-title">PERSONAL INFORMATION</div><table class="layout-table"><tr><td width="30%"><div class="input-box">${r.philsys || ''}</div><div class="label-under">(PhilSys Card No.)</div></td><td width="70%"></td></tr></table><table class="layout-table"><tr><td width="25%"><div class="input-box">${r.last}</div><div class="label-under">(Last Name)</div></td><td width="10%"><div class="input-box">${r.suffix || ''}</div><div class="label-under">(Suffix)</div></td><td width="35%"><div class="input-box">${r.first}</div><div class="label-under">(First Name)</div></td><td width="30%"><div class="input-box">${r.middle || ''}</div><div class="label-under">(Middle Name)</div></td></tr></table><table class="layout-table"><tr><td width="20%"><div class="input-box">${r.bdate}</div><div class="label-under">(Birth Date: mm/dd/yyyy)</div></td><td width="30%"><div class="input-box">${r.bplace || ''}</div><div class="label-under">(Birth Place)</div></td><td width="10%"><div class="input-box">${r.sex}</div><div class="label-under">(Sex)</div></td><td width="15%"><div class="input-box">${r.civil}</div><div class="label-under">(Civil Status)</div></td><td width="25%"><div class="input-box">${r.religion || ''}</div><div class="label-under">(Religion)</div></td></tr></table><table class="layout-table"><tr><td width="65%"><div class="input-box">${r.address}</div><div class="label-under">(Residence Address)</div></td><td width="35%"><div class="input-box">${r.citizen || 'FILIPINO'}</div><div class="label-under">(Citizenship)</div></td></tr></table><table class="layout-table"><tr><td width="35%"><div class="input-box">${r.prof || ''}</div><div class="label-under">(Profession / Occupation)</div></td><td width="30%"><div class="input-box">${r.contact || ''}</div><div class="label-under">(Contact Number)</div></td><td width="35%"><div class="input-box">${r.email || ''}</div><div class="label-under">(E-mail Address)</div></td></tr></table><hr style="border-top: 1px dashed #ccc; margin: 5px 0;"><div style="font-size: 9pt; padding: 5px;"><strong>HIGHEST EDUCATIONAL ATTAINMENT:</strong><span class="chk-group" style="display:inline-flex;"><span><span class="chk-box">${chk(isElem, true)}</span> ELEMENTARY</span><span><span class="chk-box">${chk(isHS, true)}</span> HIGH SCHOOL</span><span><span class="chk-box">${chk(isCol, true)}</span> COLLEGE</span><span><span class="chk-box">${chk(isPost, true)}</span> POST GRAD</span><span><span class="chk-box">${chk(isVoc, true)}</span> VOCATIONAL</span></span><div style="margin-top:5px; margin-left: 200px;"><em>Please specify:</em> <span class="chk-box" style="margin-left: 10px;">${chk(isGrad, true)}</span> Graduate <span class="chk-box" style="margin-left: 20px;">${chk(isUnder, true)}</span> Under Graduate</div></div><div class="legal-text">I hereby certify that the above information is true and correct to the best of my knowledge. I understand that for the Barangay to carry out its mandate pursuant to Section 394 (d)(6) of the Local Government Code of 1991, they must necessarily process my personal information for easy identification of inhabitants, as a tool in planning, and as an updated reference in the number of inhabitants of the Barangay. Therefore, I grant my consent and recognize the authority of the Barangay to process my personal information, subject to the provision of the Philippine Data Privacy Act of 2012.</div><table style="width:100%; margin-top: 30px; font-size: 9pt;"><tr><td width="40%" style="text-align:center;"><div class="sig-line"></div><div>Date Accomplished</div></td><td width="20%"></td><td width="40%" style="text-align:center;"><div class="sig-line"></div><div>Name/Signature of Person Accomplishing the Form</div></td></tr></table><div style="margin-top: 20px; font-size: 9pt;">Attested By:</div><table style="width:100%; margin-top: 10px; font-size: 9pt;"><tr><td width="40%" style="text-align:center; vertical-align: bottom;"><div class="sig-line" style="font-weight:bold; text-transform:uppercase;">${settings.secretary}</div><div style="font-weight:bold;">Barangay Secretary</div></td><td width="30%" style="text-align:center;"><div class="thumb-box"></div><div style="font-size:8pt;">Left Thumbmark</div></td><td width="30%" style="text-align:center;"><div class="thumb-box"></div><div style="font-size:8pt;">Right Thumbmark</div></td></tr></table><div style="margin-top: 20px; display: flex; align-items: center;"><span style="font-weight:bold; font-size: 9pt; margin-right: 10px;">Household Number:</span><div style="border: 2px solid black; width: 200px; height: 30px; display:flex; align-items:center; justify-content:center; font-weight:bold;">${hhNum}</div></div></div>`;
        }

        function printFormA() {
            /* Same as previous, ensured compatibility */
            const hhName = document.getElementById('manage-hh-name').value;
            const purok = document.getElementById('view-hh-purok').innerText;
            const houseNo = document.getElementById('view-hh-num').innerText;
            const members = db.filter(r => r.hh_name === hhName && !r.isDead);
            members.sort((a,b) => { 
                const roles = {'HEAD': 1, 'SPOUSE': 2, 'SON': 3, 'DAUGHTER': 4, 'MEMBER': 5};
                const ra = roles[a.hh_role] || 99; const rb = roles[b.hh_role] || 99;
                if(ra !== rb) return ra - rb; return a.last.localeCompare(b.last); 
            });
            let rowsHtml = '';
            members.forEach((m, i) => {
                let indicators = [];
                if(m.prof && !m.isUnemployed) indicators.push("Employed");
                if(m.isUnemployed) indicators.push("Unemployed");
                if(m.isPwd) indicators.push("PWD");
                if(m.isOfw) indicators.push("OFW");
                if(m.isSoloParent) indicators.push("Solo Parent");
                if(m.is4Ps) indicators.push("4Ps");
                if(m.isOSY) indicators.push("OSY");
                if(m.isOsc) indicators.push("OSC");
                if(m.isIp) indicators.push("IP");

                rowsHtml += `<tr><td>${i+1}</td><td>${m.last}</td><td>${m.first}</td><td>${m.middle}</td><td>${m.suffix || ''}</td><td>${m.bplace}</td><td>${m.bdate}</td><td>${calculateAgeDetailed(m.bdate).y}</td><td>${m.sex}</td><td>${m.civil}</td><td>${m.citizen || 'FILIPINO'}</td><td>${m.prof || ''}</td><td>${indicators.join(', ')}</td></tr>`;
            });
            for(let i=members.length; i<15; i++) { rowsHtml += `<tr><td>${i+1}</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`; }
            const html = `<div class="landscape-page"><div class="print-header"><strong>RBI FORM A (Revised 2024)</strong><br><strong>RECORDS OF BARANGAY INHABITANTS BY HOUSEHOLD</strong></div><table style="width:100%; margin-bottom: 10px; font-family: Arial; font-size: 10pt;"><tr><td style="border:none; width: 100px;">REGION:</td><td style="border:none; border-bottom: 1px solid black;">${settings.region}</td><td style="border:none; width: 50px;"></td><td style="border:none; width: 150px;">PROVINCE:</td><td style="border:none; border-bottom: 1px solid black;">${settings.province}</td></tr><tr><td style="border:none;">CITY/MUNICIPALITY:</td><td style="border:none; border-bottom: 1px solid black;">${settings.municipality}</td><td style="border:none;"></td><td style="border:none;">BARANGAY:</td><td style="border:none; border-bottom: 1px solid black;">${settings.barangay}</td></tr><tr><td style="border:none;">HOUSEHOLD ADDRESS:</td><td style="border:none; border-bottom: 1px solid black;" colspan="4">PUROK ${purok}, HOUSE NO. ${houseNo}</td></tr><tr><td style="border:none;">NO. OF MEMBERS:</td><td style="border:none; border-bottom: 1px solid black;">${members.length}</td></tr></table><table class="print-table"><thead><tr><th rowspan="2" width="3%">NO.</th><th colspan="4" width="25%">NAME</th><th rowspan="2" width="10%">PLACE OF BIRTH</th><th rowspan="2" width="8%">DATE OF BIRTH</th><th rowspan="2" width="4%">AGE</th><th rowspan="2" width="5%">SEX</th><th rowspan="2" width="8%">CIVIL STATUS</th><th rowspan="2" width="8%">CITIZENSHIP</th><th rowspan="2" width="10%">OCCUPATION</th><th rowspan="2" width="15%">REMARKS / STATUS</th></tr><tr><th>LAST NAME</th><th>FIRST NAME</th><th>MIDDLE NAME</th><th>EXT</th></tr></thead><tbody>${rowsHtml}</tbody></table><div class="sig-box"><div style="text-align:center;"><p>Prepared by:</p><div class="sig-line"></div><strong>Name of Household/Head Member</strong><br>(Signature over Printed Name)</div><div style="text-align:center;"><p>Certified Correct:</p><div class="sig-line"><b>${settings.secretary}</b></div><strong>Barangay Secretary</strong><br>(Signature over Printed Name)</div><div style="text-align:center;"><p>Validated by:</p><div class="sig-line"><b>${settings.captain}</b></div><strong>Punong Barangay</strong><br>(Signature over Printed Name)</div></div></div>`;
            const area = document.getElementById('print-area'); area.innerHTML = html; window.print();
        }

        function getFormCBracket(bdate) {
            const age = calculateAgeDetailed(bdate);
            const y = age.y;
            if (y < 5) return 'Under 5 years old';
            if (y >= 5 && y <= 9) return '5-9 years old';
            if (y >= 10 && y <= 14) return '10-14 years old';
            if (y >= 15 && y <= 19) return '15-19 years old';
            if (y >= 20 && y <= 24) return '20-24 years old';
            if (y >= 25 && y <= 29) return '25-29 years old';
            if (y >= 30 && y <= 34) return '30-34 years old';
            if (y >= 35 && y <= 39) return '35-39 years old';
            if (y >= 40 && y <= 44) return '40-44 years old';
            if (y >= 45 && y <= 49) return '45-49 years old';
            if (y >= 50 && y <= 54) return '50-54 years old';
            if (y >= 55 && y <= 59) return '55-59 years old';
            if (y >= 60 && y <= 64) return '60-64 years old';
            if (y >= 65 && y <= 69) return '65-69 years old';
            if (y >= 70 && y <= 74) return '70-74 years old';
            if (y >= 75 && y <= 79) return '75-79 years old';
            if (y >= 80) return '80 years old and over';
            return 'UNKNOWN';
        }

        function updateReportUI() {
            const living = db.filter(r => !r.isDead);
            const stats = { male: 0, female: 0, adults: 0, children: 0, solo: 0, pwd: 0, senior: 0, osy: 0, total: living.length };
            const totalFamilies = living.filter(r => r.hh_role === 'HEAD').length;
            const uniqueHH = new Set(living.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            living.forEach(r => {
                if(r.sex === 'MALE') stats.male++; else if(r.sex === 'FEMALE') stats.female++;
                const age = calculateAgeDetailed(r.bdate).y;
                if(age < 18) stats.children++; else if(age >= 60) stats.senior++; else stats.adults++;
                if(r.isPwd) stats.pwd++; if(r.isSoloParent) stats.solo++; if(r.isOSY) stats.osy++;
            });
            document.getElementById('rep-male').innerText = stats.male; document.getElementById('rep-female').innerText = stats.female; document.getElementById('rep-total').innerText = stats.total; document.getElementById('rep-child').innerText = stats.children; document.getElementById('rep-adult').innerText = stats.adults; document.getElementById('rep-senior').innerText = stats.senior; document.getElementById('rep-pwd').innerText = stats.pwd; document.getElementById('rep-solo').innerText = stats.solo; document.getElementById('rep-osy').innerText = stats.osy; document.getElementById('rep-hh-total').innerText = uniqueHH.size; document.getElementById('rep-family-total').innerText = totalFamilies;
        }

        function printStats() {
            const living = db.filter(r => !r.isDead);
            const ageData = {'Under 5 years old': {m:0, f:0}, '5-9 years old': {m:0, f:0}, '10-14 years old': {m:0, f:0}, '15-19 years old': {m:0, f:0}, '20-24 years old': {m:0, f:0}, '25-29 years old': {m:0, f:0}, '30-34 years old': {m:0, f:0}, '35-39 years old': {m:0, f:0}, '40-44 years old': {m:0, f:0}, '45-49 years old': {m:0, f:0}, '50-54 years old': {m:0, f:0}, '55-59 years old': {m:0, f:0}, '60-64 years old': {m:0, f:0}, '65-69 years old': {m:0, f:0}, '70-74 years old': {m:0, f:0}, '75-79 years old': {m:0, f:0}, '80 years old and over': {m:0, f:0}};
            const sectorData = {'Labor Force': {m:0, f:0}, 'Unemployed': {m:0, f:0}, 'Out of School Children (OSC) (6-14 years old)': {m:0, f:0}, 'Out of School Youth (OSY) (15-24 years old)': {m:0, f:0}, 'Person with Disabilities (PWDs)': {m:0, f:0}, 'Overseas Filipino Workers (OFWs)': {m:0, f:0}, 'Solo Parents': {m:0, f:0}, 'Indigenous Peoples (IPs)': {m:0, f:0}, '4Ps Beneficiaries': {m:0, f:0}};
            const civilData = { 'Single': {m:0, f:0}, 'Married': {m:0, f:0}, 'Widowed': {m:0, f:0}, 'Separated': {m:0, f:0}, 'Live-in/Common Law': {m:0, f:0} };
            const citizenData = { 'Filipino': {m:0, f:0}, 'Foreigner': {m:0, f:0} };
            const totalFamilies = living.filter(r => r.hh_role === 'HEAD').length;
            const uniqueHH = new Set(living.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            
            living.forEach(r => {
                const sexKey = (r.sex === 'MALE') ? 'm' : 'f';
                const bracket = getFormCBracket(r.bdate); if(ageData[bracket]) ageData[bracket][sexKey]++;
                if(r.isOsc) sectorData['Out of School Children (OSC) (6-14 years old)'][sexKey]++;
                if(r.isOSY) sectorData['Out of School Youth (OSY) (15-24 years old)'][sexKey]++;
                if(r.isPwd) sectorData['Person with Disabilities (PWDs)'][sexKey]++;
                if(r.isOfw) sectorData['Overseas Filipino Workers (OFWs)'][sexKey]++;
                if(r.isSoloParent) sectorData['Solo Parents'][sexKey]++;
                if(r.isIp) sectorData['Indigenous Peoples (IPs)'][sexKey]++;
                if(r.is4Ps) sectorData['4Ps Beneficiaries'][sexKey]++;
                if(r.isUnemployed) sectorData['Unemployed'][sexKey]++;
                const age = calculateAgeDetailed(r.bdate).y; if(age >= 15 && (r.prof || r.isUnemployed)) sectorData['Labor Force'][sexKey]++;
                let cStatus = r.civil ? r.civil.charAt(0).toUpperCase() + r.civil.slice(1).toLowerCase() : 'Single'; if(cStatus === 'Live-in') cStatus = 'Live-in/Common Law'; if(civilData[cStatus]) civilData[cStatus][sexKey]++;
                let cit = r.citizen ? r.citizen.charAt(0).toUpperCase() + r.citizen.slice(1).toLowerCase() : 'Filipino'; if(citizenData[cit]) citizenData[cit][sexKey]++;
            });
            
            const buildRows = (obj) => { let html = ''; for (const [key, val] of Object.entries(obj)) { html += `<tr><td style="text-align:left; padding-left:20px;">${key}</td><td>${val.m}</td><td>${val.f}</td><td>${val.m + val.f}</td><td></td></tr>`; } return html; };
            const html = `<style>.form-c { font-family: Arial, sans-serif; width: 100%; border-collapse: collapse; font-size: 10pt; } .form-c th, .form-c td { border: 1px solid black; padding: 4px; text-align: center; } .form-c .left { text-align: left; font-weight: bold; background: #f0f0f0; } .header-sec { text-align: center; margin-bottom: 20px; } .header-sec h3, .header-sec h4 { margin: 2px; } </style><div class="header-sec"><h3>RBI FORM C (Revised 2024)</h3><h2>MONITORING REPORT</h2></div><div style="margin-bottom: 15px;"><div>REGION : ${settings.region}</div><div>PROVINCE: ${settings.province}</div><div>CITY/MUNICIPALITY: ${settings.municipality}</div><div>BARANGAY: ${settings.barangay}</div></div><div style="margin-bottom: 15px;"><div>Total Inhabitants: <b>${living.length}</b></div><div>Total Households: <b>${uniqueHH.size}</b></div><div>Total Families: <b>${totalFamilies}</b></div></div><table class="form-c"><thead><tr><th style="width:40%">INDICATORS</th><th>MALE</th><th>FEMALE</th><th>TOTAL</th><th>REMARKS</th></tr></thead><tbody><tr><td colspan="5" class="left">Population by Age Bracket:</td></tr>${buildRows(ageData)}<tr><td colspan="5" class="left">Population by Sector:</td></tr>${buildRows(sectorData)}<tr><td colspan="5" class="left">Civil Status:</td></tr>${buildRows(civilData)}<tr><td colspan="5" class="left">Citizenship:</td></tr>${buildRows(citizenData)}</tbody></table><div style="margin-top: 50px; display: flex; justify-content: space-between; text-align: center;"><div style="width: 40%;"><p>Prepared by:</p><br><br><div style="border-bottom: 1px solid black; font-weight: bold;">${settings.secretary}</div><div>Barangay Secretary</div></div><div style="width: 40%;"><p>Submitted by:</p><br><br><div style="border-bottom: 1px solid black; font-weight: bold;">${settings.captain}</div><div>Punong Barangay</div></div></div>`;
            const area = document.getElementById('print-area'); area.innerHTML = html; window.print();
        }

        function printHHHeads() {
            const heads = db.filter(r => r.hh_role === 'HEAD' && !r.isDead);
            heads.sort((a,b) => a.last.localeCompare(b.last));
            let rows = heads.map((m, i) => `<tr><td>${i+1}</td><td>${m.last}, ${m.first}</td><td>${m.hh_name}</td><td>${m.contact || '-'}</td></tr>`).join('');
            const html = `<style>.rbi-page { margin: 20px; font-family: sans-serif; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 5px; }</style><div class="rbi-page"><h2 style="text-align:center;">LIST OF HEAD OF FAMILIES</h2><p style="text-align:center;">Barangay ${settings.barangay}</p><table><thead><tr><th>#</th><th>Name of Head</th><th>Household/Family Name</th><th>Contact</th></tr></thead><tbody>${rows}</tbody></table><br><br><p>Certified Correct: <u>${settings.secretary}</u></p></div>`;
            const area = document.getElementById('print-area'); area.innerHTML = html; window.print();
        }

        function processExport() {
            const living = db.filter(r => !r.isDead);
            const dataRows = living.map(r => [r.type || "", r.last || "", r.first || "", r.middle || "", r.suffix || "", r.bplace || "", r.bdate || "", r.sex || "", r.civil || "", r.citizen || "FILIPINO", r.religion || "", r.prof || "", r.contact || "", r.email || "", r.edu || "", r.mother_first || "", r.mother_middle || "", r.mother_last || ""]);
            const wb = XLSX.utils.book_new();
            const wsData = XLSX.utils.aoa_to_sheet([["INHABITANT TYPE", "LAST NAME", "FIRST NAME", "MIDDLE NAME", "SUFFIX", "BIRTH PLACE", "BIRTHDATE (YYYY-MM-DD)", "SEX", "CIVIL STATUS", "CITIZENSHIP", "RELIGION", "PROFESSION/ OCCUPATION", "CONTACT NUMBER", "EMAIL ADDRESS", "HIGHEST EDUCATIONAL ATTAINMENT", "MOTHER'S FIRST NAME", "MOTHER'S MIDDLE NAME", "MOTHER'S LAST NAME"], ...dataRows]);
            XLSX.utils.book_append_sheet(wb, wsData, "DATA");
            XLSX.writeFile(wb, "RBI_Export_BIMS.xlsx");
        }

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({db, settings, household_db}));
            const a = document.createElement('a'); a.href = dataStr; a.download = "RBI_Backup.json"; a.click();
        }

        function restoreData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(imported.db) { db = imported.db; if(imported.settings) settings = imported.settings; if(imported.household_db) household_db = imported.household_db; saveDB(); localStorage.setItem('rbi_settings', JSON.stringify(settings)); showAlert("Restored", "Restored!"); location.reload(); }
                } catch(err) { showAlert("Error", "Error reading file"); }
            }; reader.readAsText(file);
        }
    </script>
</body>
</html>
