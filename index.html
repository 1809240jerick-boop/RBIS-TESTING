<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">
<link rel="apple-touch-icon" href="icon.png">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('PWA Active: ', reg.scope))
        .catch(err => console.error('PWA Error: ', err));
    });
  }
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBI Management System 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #343a40; padding-top: 20px; color: white; transition: all 0.3s; z-index: 1000; }
    .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: #d1d1d1; display: block; transition: 0.2s; border-left: 4px solid transparent; }
    .sidebar a:hover, .sidebar a.active { background-color: #495057; color: #fff; border-left: 4px solid #0d6efd; }
    .sidebar-header { padding: 0 25px 20px 25px; border-bottom: 1px solid #4b545c; margin-bottom: 10px; }
    .content { margin-left: 250px; padding: 20px; }
    .card-custom { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .card-custom:hover { transform: translateY(-2px); }
    .stat-card { border-left: 4px solid; }
    .stat-primary { border-color: #0d6efd; }
    .stat-success { border-color: #198754; }
    .stat-warning { border-color: #ffc107; }
    .stat-danger { border-color: #dc3545; }
    .stat-info { border-color: #0dcaf0; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
    .login-box { background: #212529; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.1); width: 400px; text-align: center; }
    .d-none { display: none !important; }
    
    /* --- PRINT AREA CONTROL --- */
    #print-area { display: none; } 

    @media print {
        body > * { display: none !important; }
        #print-area { 
            display: block !important; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            background: white;
        }
        @page { size: auto; margin: 10mm; }
    }
</style>
</head>
<body>

    <div id="security-overlay" class="overlay">
        <div class="login-box">
            <h3 class="mb-4"><i class="fas fa-shield-alt"></i> RBI SECURE</h3>
            
            <div id="login-phase-1">
                <p class="text-muted small mb-3">System requires Dynamic Authentication.</p>
                <input type="password" id="dynamic-code" class="form-control mb-3 text-center" placeholder="Enter Dynamic Access Code">
                <button onclick="checkDynamic()" class="btn btn-primary w-100">Authenticate</button>
                <div class="mt-3 text-white-50" style="font-size: 0.8rem;" id="server-time-display"></div>
            </div>

            <div id="login-phase-2" class="d-none">
                <p class="text-success small mb-3">Authentication Verified.</p>
                <p class="text-muted small">Please set your personal password.</p>
                <input type="password" id="new-custom-pass" class="form-control mb-2" placeholder="New Password">
                <input type="password" id="confirm-custom-pass" class="form-control mb-3" placeholder="Confirm Password">
                <button onclick="setCustomPassword()" class="btn btn-success w-100">Set Password & Login</button>
            </div>

            <div id="login-phase-3" class="d-none">
                <p class="text-white small mb-3">Welcome Back</p>
                <input type="password" id="input-custom-pass" class="form-control mb-3 text-center" placeholder="Enter Password">
                <button onclick="verifyCustomPassword()" class="btn btn-primary w-100">Login</button>
                <button onclick="forgotPassword()" class="btn btn-link text-muted btn-sm mt-2">Forgot Password?</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-users-cog"></i> RBI System</h4>
            <small class="text-muted">Brgy. Data Management</small>
        </div>
        <a href="#" onclick="showHome()" class="nav-link active"><i class="fas fa-home me-2"></i> Dashboard</a>
        <a href="#" onclick="showAdd()" class="nav-link"><i class="fas fa-user-plus me-2"></i> Add Resident</a>
        <a href="#" onclick="showHouseholds()" class="nav-link"><i class="fas fa-house-user me-2"></i> Households</a>
        <a href="#" onclick="showDeaths()" class="nav-link"><i class="fas fa-book-dead me-2"></i> Death Registry</a>
        <a href="#" onclick="showImport()" class="nav-link"><i class="fas fa-file-import me-2"></i> Import/Export</a>
        <a href="#" onclick="showSettings()" class="nav-link"><i class="fas fa-cogs me-2"></i> Settings</a>
        <a href="#" onclick="logout()" class="nav-link mt-5"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>

    <div class="content" id="main-container">
        
        <div id="section-home">
            <h2 class="mb-4"> Dashboard Overview</h2>
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card card-custom stat-card stat-primary p-3">
                        <h6 class="text-muted">Total Residents</h6>
                        <h2 id="rep-total">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom stat-card stat-info p-3">
                        <h6 class="text-muted">Total Households</h6>
                        <h2 id="rep-hh-total">0</h2>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom stat-card stat-success p-3">
                        <h6 class="text-muted">Total Families</h6>
                        <h2 id="rep-family-total">0</h2>
                        <small class="text-muted" style="font-size: 10px;">(Head of Families)</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-custom stat-card stat-warning p-3">
                        <h6 class="text-muted">Seniors (60+)</h6>
                        <h2 id="rep-senior">0</h2>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>Male</small><strong id="rep-male">0</strong></div></div>
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>Female</small><strong id="rep-female">0</strong></div></div>
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>Children</small><strong id="rep-child">0</strong></div></div>
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>Adults</small><strong id="rep-adult">0</strong></div></div>
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>PWD</small><strong id="rep-pwd">0</strong></div></div>
                 <div class="col-md-2"><div class="card p-2 text-center bg-white"><small>Solo Parent</small><strong id="rep-solo">0</strong></div></div>
                 <div class="col-md-2 mt-2"><div class="card p-2 text-center bg-white"><small>OSY</small><strong id="rep-osy">0</strong></div></div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <input type="text" id="search-input" class="form-control w-50" placeholder="Search resident name..." onkeyup="renderList()">
                <button class="btn btn-dark" onclick="printStats()"><i class="fas fa-print"></i> Print Demographics</button>
            </div>
            
            <div id="record-list"></div>
        </div>

        <div id="section-add" class="d-none">
            <h3 class="mb-3">Resident Information Sheet</h3>
            <div class="card card-custom p-4">
                <input type="hidden" id="rec-id">
                <div class="row g-3">
                    <div class="col-md-12"><h5 class="text-primary border-bottom pb-2">I. Personal Profile</h5></div>
                    <div class="col-md-3">
                        <label>Last Name <span class="text-danger">*</span></label>
                        <input type="text" id="f-last" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-3">
                        <label>First Name <span class="text-danger">*</span></label>
                        <input type="text" id="f-first" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-3">
                        <label>Middle Name</label>
                        <input type="text" id="f-middle" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-3">
                        <label>Suffix</label>
                        <input type="text" id="f-suffix" class="form-control text-uppercase" placeholder="e.g. JR, III">
                    </div>
                    
                    <div class="col-md-3">
                        <label>Birth Date <span class="text-danger">*</span></label>
                        <input type="date" id="f-bdate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label>Sex <span class="text-danger">*</span></label>
                        <select id="f-sex" class="form-select">
                            <option value="MALE">MALE</option>
                            <option value="FEMALE">FEMALE</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Civil Status</label>
                        <select id="f-civil" class="form-select">
                            <option value="SINGLE">SINGLE</option>
                            <option value="MARRIED">MARRIED</option>
                            <option value="WIDOWED">WIDOWED</option>
                            <option value="SEPARATED">SEPARATED</option>
                            <option value="LIVE-IN">LIVE-IN</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Citizenship</label>
                        <input type="text" id="f-citizen" class="form-control text-uppercase" value="FILIPINO">
                    </div>

                    <div class="col-md-4">
                        <label>Birth Place</label>
                        <input type="text" id="f-bplace" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-4">
                        <label>Occupation</label>
                        <input type="text" id="f-prof" class="form-control text-uppercase">
                    </div>
                    <div class="col-md-4">
                        <label>PhilSys ID</label>
                        <input type="text" id="f-philsys" class="form-control">
                    </div>

                    <div class="col-md-12 position-relative">
                        <label class="fw-bold">Mother's Maiden Name</label>
                        <input type="text" class="form-control mb-1" id="mother-search-input" placeholder="Type to search mother from DB..." onkeyup="searchMother(this.value)">
                        <div id="mother-search-results" class="search-results d-none"></div>
                        <div class="row g-2 mt-1">
                            <div class="col-4"><input type="text" id="f-m-last" class="form-control form-control-sm text-uppercase" placeholder="Mother's Last Name"></div>
                            <div class="col-4"><input type="text" id="f-m-first" class="form-control form-control-sm text-uppercase" placeholder="Mother's First Name"></div>
                            <div class="col-4"><input type="text" id="f-m-middle" class="form-control form-control-sm text-uppercase" placeholder="Mother's Middle Name"></div>
                        </div>
                    </div>

                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2">II. Special Categories & Status</h5></div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-solo">
                            <label class="form-check-label">Solo Parent</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-osy">
                            <label class="form-check-label">Out of School Youth (OSY)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-pwd">
                            <label class="form-check-label">Person with Disability (PWD)</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="f-dead" onchange="toggleDeathInput()">
                            <label class="form-check-label text-danger">Deceased</label>
                        </div>
                    </div>
                    <div class="col-md-4 d-none" id="death-date-container">
                        <label class="text-danger">Date of Death</label>
                        <input type="date" id="f-death-date" class="form-control border-danger">
                    </div>

                    <div class="col-md-12 mt-4"><h5 class="text-primary border-bottom pb-2">III. Contact & Residence</h5></div>
                    <div class="col-md-6">
                        <label>Inhabitant Type</label>
                        <select id="f-type" class="form-select">
                            <option value="NON-MIGRANT">NON-MIGRANT (Permanent)</option>
                            <option value="MIGRANT">MIGRANT</option>
                            <option value="TRANSIENT">TRANSIENT</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Contact Number</label>
                        <input type="text" id="f-contact" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Email Address</label>
                        <input type="email" id="f-email" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label>Educational Attainment</label>
                        <select id="f-edu" class="form-select">
                            <option value="">Select...</option>
                            <option value="ELEMENTARY">ELEMENTARY</option>
                            <option value="HIGH SCHOOL">HIGH SCHOOL</option>
                            <option value="COLLEGE UNDERGRAD">COLLEGE UNDERGRAD</option>
                            <option value="COLLEGE GRADUATE">COLLEGE GRADUATE</option>
                            <option value="VOCATIONAL">VOCATIONAL</option>
                            <option value="NONE">NONE</option>
                        </select>
                    </div>
                    <div class="col-md-12">
                        <label>Current Address (Street/Sitio)</label>
                        <input type="text" id="f-address" class="form-control text-uppercase">
                    </div>
                    
                    <div class="col-md-12 mt-3 p-2 bg-light border rounded">
                        <strong>Current Household: </strong> 
                        <span id="f-hh-display" class="text-primary fw-bold">No Household Assigned</span>
                    </div>

                    <div class="col-md-12 mt-4 text-end">
                        <button class="btn btn-secondary me-2" onclick="showHome()">Cancel</button>
                        <button class="btn btn-danger me-2" id="btn-del" style="display:none;" onclick="deleteRecord()">Delete</button>
                        <button class="btn btn-primary px-4" onclick="saveRecord()">Save Record</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-hh" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Household Management</h2>
                <div>
                     <button class="btn btn-dark me-2" onclick="printHHHeads()"><i class="fas fa-print"></i> Print Household Heads</button>
                     <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modal-new-hh"><i class="fas fa-plus"></i> New Household</button>
                </div>
            </div>
            
            <div class="row" id="hh-view" style="display:none;">
                <div class="col-md-12 mb-3">
                     <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('hh-view').style.display='none'; document.getElementById('hh-list-container').style.display='block';">Back to List</button>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h4 id="view-hh-title" class="text-primary mb-3"></h4>
                        <p class="mb-1"><strong>Purok:</strong> <span id="view-hh-purok">-</span></p>
                        <p class="mb-3"><strong>House No:</strong> <span id="view-hh-num">-</span></p>
                        <input type="hidden" id="manage-hh-name">
                        <button class="btn btn-primary w-100 mb-2" onclick="showAddMemberModal()"><i class="fas fa-user-plus"></i> Add Member</button>
                        <button class="btn btn-outline-dark w-100 mb-3" onclick="printHousehold()"><i class="fas fa-print"></i> Print Household</button>
                        
                        <div class="border-top pt-3">
                            <label class="small text-muted mb-2">Manage Household</label>
                            <button class="btn btn-warning w-100 mb-2 btn-sm" onclick="showEditHHModal()"><i class="fas fa-edit"></i> Edit Details</button>
                            <button class="btn btn-danger w-100 btn-sm" onclick="deleteHH()"><i class="fas fa-trash"></i> Delete Household</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card p-3">
                        <h5>Members</h5>
                        <table class="table table-bordered table-hover">
                            <thead><tr><th>Name</th><th>Role</th><th>Action</th></tr></thead>
                            <tbody id="hh-members-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="hh-list-container">
                <input type="text" class="form-control mb-3" placeholder="Search Household..." onkeyup="filterHHList(this.value)">
                <ul class="list-group" id="hh-list"></ul>
            </div>
        </div>

        <div id="section-deaths" class="d-none">
             <h2 class="text-danger mb-4">Death Registry <span class="badge bg-danger rounded-pill" id="death-total">0</span></h2>
             <div class="row" id="death-list"></div>
        </div>

        <div id="section-import" class="d-none">
            <h2>Data Import / Export</h2>
            <div class="row g-4 mt-2">
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4><i class="fas fa-file-excel text-success"></i> Export Data</h4>
                        <p>Download database compatible with DILG BIMS (Excel format).</p>
                        <button class="btn btn-success" onclick="processExport()">Download BIMS Excel</button>
                        <hr>
                        <h4><i class="fas fa-database text-primary"></i> System Backup</h4>
                        <p>Full system backup (JSON) including settings and logs.</p>
                        <button class="btn btn-primary" onclick="backupData()">Download Backup</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h4><i class="fas fa-upload text-warning"></i> Import Data</h4>
                        <p>Restore from Backup or Import BIMS Excel.</p>
                        <input type="file" id="import-file" class="form-control mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning" onclick="previewImport()">Process BIMS Excel</button>
                            <input type="file" id="restore-file" class="d-none" onchange="restoreData(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('restore-file').click()">Restore JSON Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-settings" class="d-none">
            <h2>System Configuration</h2>
            <div class="card card-custom p-4 mt-3" style="max-width: 600px;">
                <div class="mb-3">
                    <label>LGU Type</label>
                    <select id="set-lgu-type" class="form-select">
                        <option value="MUNICIPALITY">MUNICIPALITY</option>
                        <option value="CITY">CITY</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Province</label>
                    <input type="text" id="set-prov" class="form-control text-uppercase">
                </div>
                <div class="mb-3">
                    <label>Municipality/City</label>
                    <input type="text" id="set-muni" class="form-control text-uppercase">
                </div>
                <div class="mb-3">
                    <label>Barangay</label>
                    <input type="text" id="set-brgy" class="form-control text-uppercase">
                </div>
                <div class="mb-3">
                    <label>Barangay Secretary (Signatory)</label>
                    <input type="text" id="set-sec" class="form-control text-uppercase">
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
            </div>
        </div>

    </div>

    <div class="modal fade" id="modal-new-hh" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Create New Household</h5></div>
                <div class="modal-body">
                    <label>Household Name (Family Name)</label>
                    <input type="text" id="new-hh-name" class="form-control text-uppercase mb-2">
                    <label>Purok</label>
                    <input type="text" id="new-hh-purok" class="form-control text-uppercase mb-2">
                    <label>House Number</label>
                    <input type="text" id="new-hh-num" class="form-control text-uppercase">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="createHH()">Create</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-edit-hh" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Edit Household Details</h5></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-hh-old-name">
                    <label>Household Name (Family Name)</label>
                    <input type="text" id="edit-hh-name" class="form-control text-uppercase mb-2">
                    <label>Purok</label>
                    <input type="text" id="edit-hh-purok" class="form-control text-uppercase mb-2">
                    <label>House Number</label>
                    <input type="text" id="edit-hh-num" class="form-control text-uppercase">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="saveEditedHH()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-add-mem" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Member to Household</h5></div>
                <div class="modal-body">
                    <input type="text" id="search-mem-hh" class="form-control mb-2" placeholder="Search Resident..." onkeyup="searchMemForHH()">
                    <div class="list-group" id="hh-search-results" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-add-mem')">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modal-select-role" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header"><h5>Select Role</h5></div>
                <div class="modal-body">
                    <input type="hidden" id="temp-mem-id">
                    <select id="select-role-input" class="form-select">
                        <option value="HEAD">HEAD OF FAMILY</option>
                        <option value="SPOUSE">SPOUSE</option>
                        <option value="SON">SON</option>
                        <option value="DAUGHTER">DAUGHTER</option>
                        <option value="MEMBER">MEMBER (Other)</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="confirmAddToHH()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-import" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5>Import Preview</h5></div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item"><a class="nav-link active" onclick="showImportTab('valid')" href="#">Valid (<span id="count-valid">0</span>)</a></li>
                        <li class="nav-item"><a class="nav-link text-warning" onclick="showImportTab('dup')" href="#">Duplicates (<span id="count-dup">0</span>)</a></li>
                        <li class="nav-item"><a class="nav-link text-danger" onclick="showImportTab('invalid')" href="#">Invalid (<span id="count-invalid">0</span>)</a></li>
                    </ul>
                    <div id="view-valid" class="import-view" style="max-height:300px; overflow-y:auto;">
                        <p class="text-success">Ready to import <span id="lbl-valid-count">0</span> records.</p>
                    </div>
                    <div id="view-dup" class="import-view d-none" style="max-height:300px; overflow-y:auto;">
                        <div id="list-dup" class="text-warning small"></div>
                    </div>
                    <div id="view-invalid" class="import-view d-none" style="max-height:300px; overflow-y:auto;">
                        <div id="list-invalid" class="text-danger small"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
                    <button class="btn btn-success" id="btn-commit-import" onclick="commitImport()" disabled>Import Valid Records</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- GLOBAL STATE ---
        let db = JSON.parse(localStorage.getItem('rbi_db')) || [];
        let household_db = JSON.parse(localStorage.getItem('rbi_hh_db')) || []; 
        let settings = JSON.parse(localStorage.getItem('rbi_settings')) || {
            user_password: null,
            barangay: '', province: '', municipality: '', secretary: '', lguType: 'MUNICIPALITY'
        };

        // Temporary Import Staging
        let stagingValid = [], stagingInvalid = [], stagingDup = [];

        document.addEventListener("DOMContentLoaded", () => {
            // SECURITY CHECK: If password exists, skip Dynamic Code
            if(settings.user_password) {
                document.getElementById('login-phase-1').classList.add('d-none'); // Hide Dynamic Code
                document.getElementById('login-phase-2').classList.add('d-none'); // Hide Set Pass
                document.getElementById('login-phase-3').classList.remove('d-none'); // Show Login
            } else {
                // Ensure Dynamic Code is shown if no password
                document.getElementById('login-phase-1').classList.remove('d-none');
                document.getElementById('login-phase-2').classList.add('d-none');
                document.getElementById('login-phase-3').classList.add('d-none');
            }
            updateServerTime();
            renderList();
        });

        // --- SECURITY FUNCTIONS ---
        function updateServerTime() {
            const now = new Date();
            document.getElementById('server-time-display').innerText = `System Time: ${now.toLocaleString()}`;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function numToLetter(num) {
            let s = '';
            while(num > 0) {
                let t = (num - 1) % 26;
                s = String.fromCharCode(97 + t) + s;
                num = Math.floor((num - 1) / 26);
            }
            return s;
        }

        function checkDynamic() {
            const input = document.getElementById('dynamic-code').value;
            const now = new Date();
            const month = now.getMonth(); 
            const day = now.getDate();
            const year = now.getFullYear();
            const week = getWeekNumber(now) * 2;
            const dayLetter = numToLetter(day);
            const hours = now.getHours(); 
            const ampm = hours >= 12 ? 'mp' : 'ma'; 
            const hourLetter = String.fromCharCode(97 + hours);
            const code = `RBI-${month}${day}${year}${week}${dayLetter}${ampm}${hourLetter}`;
            
            console.log("Expected:", code);

            if(input === code) {
                if(settings.user_password) {
                    document.getElementById('login-phase-1').classList.add('d-none');
                    document.getElementById('login-phase-2').classList.remove('d-none');
                } else {
                    document.getElementById('login-phase-1').classList.add('d-none');
                    document.getElementById('login-phase-2').classList.remove('d-none');
                }
            } else {
                alert("Incorrect Access Code.");
            }
        }

        function setCustomPassword() {
            const p1 = document.getElementById('new-custom-pass').value;
            const p2 = document.getElementById('confirm-custom-pass').value;
            if(!p1 || p1 !== p2) return alert("Passwords do not match or are empty.");
            settings.user_password = p1;
            localStorage.setItem('rbi_settings', JSON.stringify(settings));
            alert("Password set successfully!");
            document.getElementById('security-overlay').classList.add('d-none');
        }

        function verifyCustomPassword() {
            const input = document.getElementById('input-custom-pass').value;
            if(input === settings.user_password) {
                document.getElementById('security-overlay').classList.add('d-none');
            } else {
                alert("Incorrect Password.");
            }
        }

        function forgotPassword() {
            document.getElementById('login-phase-2').classList.add('d-none');
            document.getElementById('login-phase-3').classList.add('d-none');
            document.getElementById('login-phase-1').classList.remove('d-none');
            alert("Please enter the Dynamic Access Code to reset your password.");
        }
        
        // --- LOGOUT (Updated: No Reload) ---
        function logout() { 
            // Hide Content
            document.getElementById('main-container').classList.add('d-none');
            document.querySelector('.sidebar').style.display = 'none'; // Optional visual tweak
            
            // Show Overlay & Login Phase 3
            document.getElementById('security-overlay').classList.remove('d-none');
            document.getElementById('login-phase-1').classList.add('d-none');
            document.getElementById('login-phase-2').classList.add('d-none');
            document.getElementById('login-phase-3').classList.remove('d-none');
            
            // Clear input for security
            document.getElementById('input-custom-pass').value = '';
            
            // Note: If you want full reload, use location.reload(), 
            // but this keeps state 'loaded' but locked.
            // To ensure Sidebar re-appears on login, we add this small fix to verifyCustomPassword:
        }
        
        // Patch verifyCustomPassword to show sidebar if hidden by logout
        const originalVerify = verifyCustomPassword;
        verifyCustomPassword = function() {
            const input = document.getElementById('input-custom-pass').value;
            if(input === settings.user_password) {
                document.getElementById('security-overlay').classList.add('d-none');
                document.getElementById('main-container').classList.remove('d-none'); // Ensure content visible
                document.querySelector('.sidebar').style.display = 'block'; // Restore sidebar
            } else {
                alert("Incorrect Password.");
            }
        }

        // --- CORE FUNCTIONS ---
        function saveDB() {
            localStorage.setItem('rbi_db', JSON.stringify(db));
            localStorage.setItem('rbi_hh_db', JSON.stringify(household_db));
            updateReportUI();
        }

        function hideAll() {
            ['section-home','section-add','section-hh','section-import','section-settings','section-deaths'].forEach(id => {
                document.getElementById(id).classList.add('d-none');
            });
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        }

        function showHome() { hideAll(); document.getElementById('section-home').classList.remove('d-none'); renderList(); }
        function showAdd() { hideAll(); document.getElementById('section-add').classList.remove('d-none'); clearForm(); }
        function showHouseholds() { hideAll(); document.getElementById('section-hh').classList.remove('d-none'); renderHHList(); }
        function showImport() { hideAll(); document.getElementById('section-import').classList.remove('d-none'); }
        
        // --- FIXED SETTINGS DISPLAY ---
        function showSettings() { 
            hideAll(); 
            document.getElementById('section-settings').classList.remove('d-none');
            // FILL INPUTS FROM SAVED DATA
            document.getElementById('set-lgu-type').value = settings.lguType || 'MUNICIPALITY';
            document.getElementById('set-prov').value = settings.province || '';
            document.getElementById('set-muni').value = settings.municipality || '';
            document.getElementById('set-brgy').value = settings.barangay || '';
            document.getElementById('set-sec').value = settings.secretary || '';
        }
        
        function showDeaths() { hideAll(); document.getElementById('section-deaths').classList.remove('d-none'); renderDeathList(); }

        function calculateAgeDetailed(bdate) {
            if(!bdate) return { y: 0, m: 0, d: 0, totalMonths: 0 };
            const birth = new Date(bdate);
            const now = new Date();
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            let days = now.getDate() - birth.getDate();
            if (days < 0) { months--; days += 30; }
            if (months < 0) { years--; months += 12; }
            return { y: years, m: months, d: days, totalMonths: (years * 12) + months };
        }

        function getAgeBracket(bdate) {
            const age = calculateAgeDetailed(bdate);
            const tm = age.totalMonths;
            const y = age.y;
            if (tm <= 6) return '0-6 MOS';
            if (tm > 6 && y < 1) return '6 MOS - 1 YR';
            if (y >= 1 && y < 5) return '1 - 5 YRS';
            if (y >= 5 && y < 12) return '5 - 12 YRS';
            if (y >= 12 && y < 17) return '12 - 17 YRS';
            if (y >= 17 && y < 18) return '17 - 18 YRS';
            if (y >= 18 && y < 60) return '18 - 59 YRS';
            if (y >= 60) return '60+ SENIOR';
            return 'UNKNOWN';
        }

        function searchMother(val) {
            const list = document.getElementById('mother-search-results');
            if(!val || val.length < 2) { list.classList.add('d-none'); return; }
            const matches = db.filter(r => r.sex === 'FEMALE' && !r.isDead && (r.last + ' ' + r.first).toLowerCase().includes(val.toLowerCase()));
            list.innerHTML = '';
            if(matches.length > 0) {
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `<strong>${m.last}, ${m.first}</strong> <small>(${m.middle||'-'})</small>`;
                    div.onclick = () => {
                        document.getElementById('f-m-last').value = m.last;
                        document.getElementById('f-m-first').value = m.first;
                        document.getElementById('f-m-middle').value = m.middle;
                        document.getElementById('mother-search-input').value = '';
                        list.classList.add('d-none');
                    };
                    list.appendChild(div);
                });
                list.classList.remove('d-none');
            } else {
                list.classList.add('d-none');
            }
        }

        function saveRecord() {
            const id = document.getElementById('rec-id').value;
            const last = document.getElementById('f-last').value;
            const first = document.getElementById('f-first').value;
            const bdate = document.getElementById('f-bdate').value;

            if(!last || !first || !bdate) return alert('Last Name, First Name, and Birthdate are required.');
            if(!id) {
                const exists = db.some(x => x.last.toLowerCase() === last.toLowerCase() && x.first.toLowerCase() === first.toLowerCase() && x.bdate === bdate);
                if(exists) return alert('Resident already exists!');
            }
            const currentRec = id ? db.find(x=>x.id===id) : null;
            const record = {
                id: id || Date.now().toString(),
                type: document.getElementById('f-type').value,
                last: last,
                first: first,
                middle: document.getElementById('f-middle').value,
                suffix: document.getElementById('f-suffix').value,
                bdate: bdate,
                sex: document.getElementById('f-sex').value,
                civil: document.getElementById('f-civil').value,
                citizen: document.getElementById('f-citizen').value,
                philsys: document.getElementById('f-philsys').value,
                bplace: document.getElementById('f-bplace').value,
                prof: document.getElementById('f-prof').value,
                mother_last: document.getElementById('f-m-last').value,
                mother_first: document.getElementById('f-m-first').value,
                mother_middle: document.getElementById('f-m-middle').value,
                isSoloParent: document.getElementById('f-solo').checked,
                isOSY: document.getElementById('f-osy').checked,
                isDead: document.getElementById('f-dead').checked,
                deathDate: document.getElementById('f-death-date').value,
                isPwd: document.getElementById('f-pwd').checked, 
                contact: document.getElementById('f-contact').value,
                email: document.getElementById('f-email').value,
                edu: document.getElementById('f-edu').value,
                address: document.getElementById('f-address').value,
                hh_name: currentRec ? currentRec.hh_name : '',
                hh_role: currentRec ? currentRec.hh_role : 'MEMBER'
            };

            if(id) { const index = db.findIndex(x => x.id === id); db[index] = record; } else { db.push(record); }
            saveDB();
            alert('Saved');
            if(record.isDead) showDeaths();
            else showHome(); // This triggers renderList
        }

        function loadRecord(id) {
            const r = db.find(x => x.id === id);
            if(!r) return;
            showAdd();
            document.getElementById('rec-id').value = r.id;
            document.getElementById('f-type').value = r.type;
            document.getElementById('f-last').value = r.last;
            document.getElementById('f-first').value = r.first;
            document.getElementById('f-middle').value = r.middle;
            document.getElementById('f-suffix').value = r.suffix;
            document.getElementById('f-bdate').value = r.bdate;
            document.getElementById('f-sex').value = r.sex;
            document.getElementById('f-civil').value = r.civil;
            document.getElementById('f-citizen').value = r.citizen;
            document.getElementById('f-philsys').value = r.philsys || '';
            document.getElementById('f-bplace').value = r.bplace || '';
            document.getElementById('f-prof').value = r.prof || '';
            document.getElementById('f-m-last').value = r.mother_last || '';
            document.getElementById('f-m-first').value = r.mother_first || '';
            document.getElementById('f-m-middle').value = r.mother_middle || '';
            document.getElementById('f-solo').checked = r.isSoloParent || false;
            document.getElementById('f-osy').checked = r.isOSY || false;
            document.getElementById('f-dead').checked = r.isDead || false;
            document.getElementById('f-death-date').value = r.deathDate || '';
            toggleDeathInput(); 
            document.getElementById('f-pwd').checked = r.isPwd || false;
            document.getElementById('f-contact').value = r.contact || '';
            document.getElementById('f-email').value = r.email || '';
            document.getElementById('f-edu').value = r.edu || '';
            document.getElementById('f-address').value = r.address || '';
            let hhTxt = r.hh_name ? r.hh_name : 'No Household Assigned';
            if(r.hh_name && r.hh_role) hhTxt += ` (${r.hh_role})`;
            document.getElementById('f-hh-display').value = hhTxt;
            document.getElementById('btn-del').style.display = 'inline-block';
        }

        function deleteRecord() {
            if(!confirm("Are you sure?")) return;
            const id = document.getElementById('rec-id').value;
            db = db.filter(x => x.id !== id);
            saveDB();
            showHome();
        }

        function clearForm() {
            document.querySelectorAll('#section-add input').forEach(i => i.value = '');
            document.querySelectorAll('#section-add select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('#section-add input[type=checkbox]').forEach(c => c.checked = false);
            document.getElementById('f-citizen').value = 'FILIPINO';
            document.getElementById('btn-del').style.display = 'none';
            document.getElementById('mother-search-results').classList.add('d-none');
            toggleDeathInput();
        }

        function toggleDeathInput() {
            const isDead = document.getElementById('f-dead').checked;
            const container = document.getElementById('death-date-container');
            if(isDead) container.classList.remove('d-none');
            else {
                container.classList.add('d-none');
                document.getElementById('f-death-date').value = '';
            }
        }

        // --- DASHBOARD LIST ---
        function renderList() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const list = document.getElementById('record-list');
            list.innerHTML = '';
            
            const filtered = db.filter(r => {
                const fullName = (r.last + ' ' + r.first + ' ' + (r.middle||'')).toLowerCase();
                const hh = (r.hh_name || '').toLowerCase();
                return (fullName.includes(q) || hh.includes(q)) && !r.isDead;
            });
            
            if(filtered.length === 0) {
                list.innerHTML = '<div class="text-center p-4 text-muted">No residents found.</div>';
            }
            
            filtered.slice(0, 50).forEach(r => {
                const age = calculateAgeDetailed(r.bdate).y;
                const item = document.createElement('div');
                item.className = 'card card-custom p-3 mb-2';
                item.style.cursor = 'pointer';
                item.onclick = () => loadRecord(r.id);
                
                let badges = '';
                if(r.isPwd) badges += '<span class="badge bg-danger me-1">PWD</span>';
                if(r.isSoloParent) badges += '<span class="badge bg-info text-dark me-1">SOLO</span>';
                if(r.isOSY) badges += '<span class="badge bg-secondary me-1">OSY</span>';

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-0">${r.last}, ${r.first} ${r.suffix || ''}</h6>
                            <small class="text-muted">${r.sex} | ${age} y/o | ${r.civil}</small><br>
                            ${r.hh_name ? `<span class="badge bg-primary"><i class="fas fa-home"></i> ${r.hh_name}</span>` : '<span class="badge bg-light text-dark border">No HH</span>'}
                            ${badges}
                        </div>
                        <div class="no-print">
                            <button class="btn btn-sm btn-outline-dark" onclick="event.stopPropagation(); printRBI('${r.id}')"><i class="fas fa-print"></i></button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
            updateReportUI();
        }

        function renderDeathList() {
            const list = document.getElementById('death-list');
            list.innerHTML = '';
            const dead = db.filter(r => r.isDead);
            document.getElementById('death-total').innerText = dead.length;
            if(dead.length === 0) list.innerHTML = '<div class="col-12 text-center text-muted p-4">No records found.</div>';
            dead.forEach(r => {
                list.innerHTML += `
                    <div class="col-md-4 mb-3">
                    <div class="card p-3 border-danger" style="background:#fff0f0; cursor:pointer;" onclick="loadRecord('${r.id}')">
                         <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="fw-bold mb-0 text-danger">${r.last}, ${r.first}</h6>
                                <small>Died: ${r.deathDate || 'N/A'}</small>
                            </div>
                            <i class="fas fa-edit text-secondary"></i>
                        </div>
                    </div></div>`;
            });
        }

        // --- HOUSEHOLD LOGIC ---
        function renderHHList() {
            const list = document.getElementById('hh-list');
            list.innerHTML = '';
            let existingNames = new Set(db.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            let hhObjects = household_db.filter(h => h && h.name);
            let hhMap = {};
            hhObjects.forEach(h => hhMap[h.name] = h);
            let allNames = new Set([...existingNames, ...hhObjects.map(h => h.name)]);
            let sortedNames = [...allNames].sort();

            sortedNames.forEach(hName => {
                const meta = hhMap[hName] || { purok: '', houseNo: '' };
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action d-flex justify-content-between';
                li.innerHTML = `<div><strong>${hName}</strong><br><small class="text-muted">Purok: ${meta.purok || 'N/A'} | #: ${meta.houseNo || 'N/A'}</small></div><button class="btn btn-sm btn-primary align-self-center">Manage</button>`;
                li.onclick = () => loadHH(hName, meta.purok, meta.houseNo);
                list.appendChild(li);
            });
        }
        
        function filterHHList(q) {
             const items = document.querySelectorAll('#hh-list li');
             items.forEach(item => {
                 if(item.innerText.toLowerCase().includes(q.toLowerCase())) item.style.display = 'flex';
                 else item.style.display = 'none';
             });
        }

        function createHH() {
            const name = document.getElementById('new-hh-name').value.toUpperCase();
            const purok = document.getElementById('new-hh-purok').value.toUpperCase();
            const num = document.getElementById('new-hh-num').value.toUpperCase();
            if(!name) return alert('Enter Name');
            const exists = household_db.some(h => h.name === name);
            if(!exists) { household_db.push({ name: name, purok: purok, houseNo: num }); saveDB(); }
            else { alert("Household Name already exists in registry."); return; }
            const modalEl = document.getElementById('modal-new-hh');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            loadHH(name, purok, num);
            renderHHList();
        }

        function loadHH(name, purok, num) {
            if(!purok || !num) { const meta = household_db.find(h => h.name === name); if(meta) { purok = meta.purok; num = meta.houseNo; } }
            document.getElementById('manage-hh-name').value = name;
            document.getElementById('view-hh-title').innerText = name;
            document.getElementById('view-hh-purok').innerText = purok || 'N/A';
            document.getElementById('view-hh-num').innerText = num || 'N/A';
            document.getElementById('hh-list-container').style.display = 'none';
            document.getElementById('hh-view').style.display = 'flex'; 
            renderHHMembers(name);
        }

        function showEditHHModal() {
            const name = document.getElementById('manage-hh-name').value;
            const meta = household_db.find(h => h.name === name) || { purok: '', houseNo: '' };
            
            document.getElementById('edit-hh-old-name').value = name;
            document.getElementById('edit-hh-name').value = name;
            document.getElementById('edit-hh-purok').value = meta.purok;
            document.getElementById('edit-hh-num').value = meta.houseNo;
            
            new bootstrap.Modal(document.getElementById('modal-edit-hh')).show();
        }

        function saveEditedHH() {
            const oldName = document.getElementById('edit-hh-old-name').value;
            const newName = document.getElementById('edit-hh-name').value.toUpperCase();
            const newPurok = document.getElementById('edit-hh-purok').value.toUpperCase();
            const newNum = document.getElementById('edit-hh-num').value.toUpperCase();

            if(!newName) return alert("Household Name cannot be empty");

            if(oldName !== newName && household_db.some(h => h.name === newName)) {
                return alert("Household Name already exists. Please choose another.");
            }

            let hh = household_db.find(h => h.name === oldName);
            if(hh) {
                hh.name = newName;
                hh.purok = newPurok;
                hh.houseNo = newNum;
            } else {
                household_db.push({ name: newName, purok: newPurok, houseNo: newNum });
            }

            if(oldName !== newName) {
                db.forEach(r => {
                    if(r.hh_name === oldName) {
                        r.hh_name = newName;
                    }
                });
            }

            saveDB();
            
            const el = document.getElementById('modal-edit-hh');
            const modal = bootstrap.Modal.getInstance(el);
            if(modal) modal.hide();

            loadHH(newName, newPurok, newNum);
            renderHHList();
            alert("Household details updated successfully.");
        }

        function deleteHH() {
            const name = document.getElementById('manage-hh-name').value;
            if(!confirm(`Are you sure you want to delete the household "${name}"? \n\nNote: Members will NOT be deleted, but they will be unassigned from this household.`)) return;

            db.forEach(r => {
                if(r.hh_name === name) {
                    r.hh_name = '';
                    r.hh_role = '';
                }
            });

            household_db = household_db.filter(h => h.name !== name);

            saveDB();
            alert("Household deleted.");
            document.getElementById('hh-view').style.display='none';
            document.getElementById('hh-list-container').style.display='block';
            renderHHList();
        }

        function renderHHMembers(hhName) {
            const tbody = document.getElementById('hh-members-body');
            tbody.innerHTML = '';
            const mems = db.filter(r => r.hh_name === hhName);
            mems.forEach(m => {
                tbody.innerHTML += `
                    <tr>
                        <td>${m.last}, ${m.first}</td>
                        <td>
                            <select onchange="updateRole('${m.id}', this.value)" class="form-select form-select-sm">
                                <option value="HEAD" ${m.hh_role==='HEAD'?'selected':''}>HEAD OF FAMILY</option>
                                <option value="SPOUSE" ${m.hh_role==='SPOUSE'?'selected':''}>SPOUSE</option>
                                <option value="SON" ${m.hh_role==='SON'?'selected':''}>SON</option>
                                <option value="DAUGHTER" ${m.hh_role==='DAUGHTER'?'selected':''}>DAUGHTER</option>
                                <option value="MEMBER" ${m.hh_role==='MEMBER'?'selected':''}>MEMBER (Other)</option>
                            </select>
                        </td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeFromHH('${m.id}')">Remove</button></td>
                    </tr>`;
            });
        }

        function updateRole(id, role) { const r = db.find(x => x.id === id); if(r) { r.hh_role = role; saveDB(); } }
        function removeFromHH(id) { const r = db.find(x => x.id === id); if(r) { r.hh_name = ''; r.hh_role = ''; saveDB(); renderHHMembers(document.getElementById('manage-hh-name').value); } }
        function showAddMemberModal() { new bootstrap.Modal(document.getElementById('modal-add-mem')).show(); }
        function closeModal(id) { const el = document.getElementById(id); const modal = bootstrap.Modal.getInstance(el); if(modal) modal.hide(); }

        function searchMemForHH() {
            const q = document.getElementById('search-mem-hh').value.toLowerCase();
            const res = document.getElementById('hh-search-results');
            res.innerHTML = '';
            db.filter(r => !r.hh_name && !r.isDead && (r.last+' '+r.first).toLowerCase().includes(q)).slice(0,10).forEach(r => {
                res.innerHTML += `<button class="list-group-item list-group-item-action" onclick="promptRole('${r.id}')">${r.last}, ${r.first}</button>`;
            });
        }

        function promptRole(id) {
            document.getElementById('temp-mem-id').value = id;
            closeModal('modal-add-mem');
            new bootstrap.Modal(document.getElementById('modal-select-role')).show();
        }

        function confirmAddToHH() {
            const id = document.getElementById('temp-mem-id').value;
            const role = document.getElementById('select-role-input').value;
            const hh = document.getElementById('manage-hh-name').value;
            const r = db.find(x => x.id === id);
            if(r) { r.hh_name = hh; r.hh_role = role; saveDB(); renderHHMembers(hh); closeModal('modal-select-role'); }
        }

        // --- REPORTING ---
        function updateReportUI() {
            const living = db.filter(r => !r.isDead);
            const stats = { male: 0, female: 0, adults: 0, children: 0, solo: 0, pwd: 0, senior: 0, osy: 0, total: living.length };
            const totalFamilies = living.filter(r => r.hh_role === 'HEAD').length;
            const uniqueHH = new Set(living.map(r => r.hh_name).filter(n => n && n.trim() !== ''));
            const totalHH = uniqueHH.size;

            living.forEach(r => {
                if(r.sex === 'MALE') stats.male++; else if(r.sex === 'FEMALE') stats.female++;
                const age = calculateAgeDetailed(r.bdate).y;
                if(age < 18) stats.children++; else if(age >= 60) stats.senior++; else stats.adults++;
                if(r.isPwd) stats.pwd++; if(r.isSoloParent) stats.solo++; if(r.isOSY) stats.osy++;
            });
            
            document.getElementById('rep-male').innerText = stats.male;
            document.getElementById('rep-female').innerText = stats.female;
            document.getElementById('rep-total').innerText = stats.total;
            document.getElementById('rep-child').innerText = stats.children;
            document.getElementById('rep-adult').innerText = stats.adults;
            document.getElementById('rep-senior').innerText = stats.senior;
            document.getElementById('rep-pwd').innerText = stats.pwd;
            document.getElementById('rep-solo').innerText = stats.solo;
            document.getElementById('rep-osy').innerText = stats.osy;
            document.getElementById('rep-hh-total').innerText = totalHH;
            document.getElementById('rep-family-total').innerText = totalFamilies;
        }

        // --- PRINTING FUNCTIONS ---
        function printStats() {
            const living = db.filter(r => !r.isDead);
            const ageBrackets = { '0-6 MOS': {m:0, f:0}, '6 MOS - 1 YR': {m:0, f:0}, '1 - 5 YRS': {m:0, f:0}, '5 - 12 YRS': {m:0, f:0}, '12 - 17 YRS': {m:0, f:0}, '17 - 18 YRS': {m:0, f:0}, '18 - 59 YRS': {m:0, f:0}, '60+ SENIOR': {m:0, f:0}, 'UNKNOWN': {m:0, f:0} };
            let solo = 0, osy = 0, pwd = 0;
            living.forEach(r => {
                const cat = getAgeBracket(r.bdate);
                if(r.sex === 'MALE') ageBrackets[cat].m++; else ageBrackets[cat].f++;
                if(r.isSoloParent) solo++; if(r.isOSY) osy++; if(r.isPwd) pwd++;
            });
            let tableRows = '';
            let totalM = 0, totalF = 0;
            for (const [bracket, counts] of Object.entries(ageBrackets)) {
                if(bracket === 'UNKNOWN' && (counts.m + counts.f) === 0) continue;
                const sub = counts.m + counts.f;
                totalM += counts.m; totalF += counts.f;
                tableRows += `<tr><td style="text-align:left; padding-left:10px;">${bracket}</td><td>${counts.m}</td><td>${counts.f}</td><td>${sub}</td></tr>`;
            }
            const html = `
                <style>.stat-table { width: 100%; border-collapse: collapse; text-align: center; font-family: Arial, sans-serif; } .stat-table th, .stat-table td { border: 1px solid black; padding: 5px; } .stat-header { background-color: #ddd; font-weight: bold; }</style>
                <div style="text-align:center; margin-bottom:20px; font-family: sans-serif;"><h3>DEMOGRAPHIC SUMMARY</h3><p>Barangay: ${settings.barangay} | Municipality/City: ${settings.municipality || '___________'}</p></div>
                <table class="stat-table"><thead><tr class="stat-header"><th>AGE BRACKET</th><th>MALE</th><th>FEMALE</th><th>TOTAL</th></tr></thead><tbody>${tableRows}<tr style="font-weight:bold; background:#eee;"><td>GRAND TOTAL</td><td>${totalM}</td><td>${totalF}</td><td>${totalM + totalF}</td></tr></tbody></table>
                <br><table class="stat-table" style="width:50%; margin: 0 auto;"><tr class="stat-header"><th colspan="2">SPECIAL CATEGORIES</th></tr><tr><td style="text-align:left; padding-left:20px;">Solo Parents</td><td>${solo}</td></tr><tr><td style="text-align:left; padding-left:20px;">Out of School Youth (OSY)</td><td>${osy}</td></tr><tr><td style="text-align:left; padding-left:20px;">PWD</td><td>${pwd}</td></tr><tr><td style="text-align:left; padding-left:20px;">Senior Citizens</td><td>${ageBrackets['60+ SENIOR'].m + ageBrackets['60+ SENIOR'].f}</td></tr></table>
                <br><br><p style="text-align:center; font-family:sans-serif;">Certified Correct:<br><br><u>${settings.secretary}</u><br>Barangay Secretary</p>`;
            
            const area = document.getElementById('print-area');
            area.innerHTML = html;
            window.print();
        }

    function printRBI(id) {
            const r = db.find(x => x.id === id); 
            if(!r) return;

            const brgy = settings.barangay || "BARANGAY"; 
            const prov = settings.province || "PROVINCE"; 
            const muni = settings.municipality || "___________";
            const lguLabel = settings.lguType === 'CITY' ? 'City' : 'Municipality';
            
            const provinceLine = settings.lguType === 'CITY' ? '' : `<h4>Province of ${prov}</h4>`;

            const html = `
                <style>
                    .rbi-modern { font-family: 'Arial', sans-serif; color: #000; max-width: 800px; margin: 0 auto; border: 2px solid #000; padding: 20px; position: relative; }
                    .header-mod { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
                    .header-mod h4 { margin: 0; font-size: 12pt; font-weight: normal; text-transform: uppercase; }
                    .header-mod h2 { margin: 5px 0; font-size: 18pt; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
                    .form-title { text-align: center; background: #000; color: #fff; font-weight: bold; padding: 5px; text-transform: uppercase; font-size: 14pt; margin-bottom: 20px; border-radius: 4px; }
                    .data-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
                    .data-box { border: 1px solid #666; padding: 5px; border-radius: 2px; }
                    .data-box.full { grid-column: span 3; } .data-box.two-thirds { grid-column: span 2; }
                    .lbl { display: block; font-size: 8pt; color: #555; text-transform: uppercase; font-weight: bold; margin-bottom: 2px; }
                    .val { display: block; font-size: 11pt; font-weight: 600; text-transform: uppercase; min-height: 18px; }
                    .legal-text { font-size: 9pt; text-align: justify; line-height: 1.4; margin: 20px 0; font-style: italic; color: #333; }
                    .sigs { display: flex; justify-content: space-between; margin-top: 40px; } .sig-block { text-align: center; width: 45%; }
                    .line { border-bottom: 1px solid #000; margin-bottom: 5px; height: 30px; }
                    .thumbs { display: flex; justify-content: center; gap: 10px; margin-top: 10px; } .thumb-box { width: 80px; height: 100px; border: 1px dashed #000; display: flex; align-items: flex-end; justify-content: center; font-size: 8pt; padding-bottom: 5px; color: #666; }
                    .watermark-footer { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 5px; display: flex; justify-content: space-between; font-size: 8pt; color: #888; font-family: 'Courier New', monospace; }
                </style>
                <div class="rbi-modern">
                    <div class="header-mod">
                        <h4>Republic of the Philippines</h4>
                        ${provinceLine} 
                        <h4>${lguLabel} of ${muni}</h4>
                        <h2>BARANGAY ${brgy}</h2>
                        <small>OFFICE OF THE PUNONG BARANGAY</small>
                    </div>
                    <div class="form-title">Individual Record of Barangay Inhabitant (RBI)</div>
                    <div class="data-grid"><div class="data-box full"><span class="lbl">Full Name</span><span class="val">${r.last}, ${r.first} ${r.middle} ${r.suffix || ''}</span></div></div>
                    <div class="data-grid"><div class="data-box"><span class="lbl">Date of Birth</span><span class="val">${r.bdate}</span></div><div class="data-box"><span class="lbl">Sex</span><span class="val">${r.sex}</span></div><div class="data-box"><span class="lbl">Civil Status</span><span class="val">${r.civil}</span></div></div>
                    <div class="data-grid"><div class="data-box two-thirds"><span class="lbl">Place of Birth</span><span class="val">${r.bplace}</span></div><div class="data-box"><span class="lbl">Citizenship</span><span class="val">${r.citizen}</span></div></div>
                    <div class="data-grid"><div class="data-box full"><span class="lbl">Mother's Maiden Name</span><span class="val">${r.mother_last || ''}, ${r.mother_first || ''} ${r.mother_middle || ''}</span></div></div>
                    <div class="data-grid"><div class="data-box"><span class="lbl">PhilSys ID No.</span><span class="val">${r.philsys || 'N/A'}</span></div><div class="data-box two-thirds"><span class="lbl">Profession / Occupation</span><span class="val">${r.prof || 'N/A'}</span></div></div>
                    <div class="data-grid"><div class="data-box full"><span class="lbl">Current Address</span><span class="val">${r.address}</span></div></div>
                    <div class="data-grid"><div class="data-box"><span class="lbl">Contact No.</span><span class="val">${r.contact}</span></div><div class="data-box two-thirds"><span class="lbl">Highest Educational Attainment</span><span class="val">${r.edu}</span></div></div>
                    <p class="legal-text"><strong>CERTIFICATION & CONSENT:</strong> I hereby certify that the above information is true and correct. I authorize the Barangay ${brgy} to process my personal data for the purpose of maintaining the Registry of Barangay Inhabitants (RBI).</p>
                    <div class="sigs"><div class="sig-block"><div class="line"></div><div>Signature of Inhabitant</div><div class="thumbs"><div class="thumb-box">L Thumb</div><div class="thumb-box">R Thumb</div></div></div><div class="sig-block"><br><br><div class="line" style="font-weight:bold;">${settings.secretary}</div><div>BARANGAY SECRETARY</div><small style="display:block; margin-top:5px; color:#555;">(Official Seal)</small></div></div>
                    <div class="watermark-footer"><span>RBI Form 101 - Rev 2026</span><span>System by: SEC JERICK</span></div>
                </div>
            `;
            const area = document.getElementById('print-area');
            area.innerHTML = html;
            window.print();
        }

        function printHousehold() {
            const hhName = document.getElementById('manage-hh-name').value;
            const members = db.filter(r => r.hh_name === hhName && !r.isDead);
            members.sort((a,b) => { 
                const roles = {'HEAD': 1, 'SPOUSE': 2, 'SON': 3, 'DAUGHTER': 4, 'MEMBER': 5};
                const ra = roles[a.hh_role] || 99; const rb = roles[b.hh_role] || 99;
                if(ra !== rb) return ra - rb; return a.last.localeCompare(b.last); 
            });
            let rows = members.map(m => `<tr><td>${m.last}, ${m.first}</td><td>${m.hh_role}</td><td>${m.sex}</td><td>${calculateAgeDetailed(m.bdate).y}</td><td>${m.civil}</td></tr>`).join('');
            const html = `<style>.rbi-page { margin: 20px; font-family: sans-serif; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 5px; }</style><div class="rbi-page"><h2>HOUSEHOLD: ${hhName}</h2><table><thead><tr><th>Name</th><th>Role</th><th>Sex</th><th>Age</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table><br><br><p>Certified Correct: <u>${settings.secretary}</u></p></div>`;
            const area = document.getElementById('print-area');
            area.innerHTML = html;
            window.print();
        }

        function printHHHeads() {
            const heads = db.filter(r => r.hh_role === 'HEAD' && !r.isDead);
            heads.sort((a,b) => a.last.localeCompare(b.last));
            let rows = heads.map((m, i) => `<tr><td>${i+1}</td><td>${m.last}, ${m.first}</td><td>${m.hh_name}</td><td>${m.contact || '-'}</td></tr>`).join('');
            const html = `<style>.rbi-page { margin: 20px; font-family: sans-serif; } table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid black; padding: 5px; }</style><div class="rbi-page"><h2 style="text-align:center;">LIST OF HEAD OF FAMILIES</h2><p style="text-align:center;">Barangay ${settings.barangay}</p><table><thead><tr><th>#</th><th>Name of Head</th><th>Household/Family Name</th><th>Contact</th></tr></thead><tbody>${rows}</tbody></table><br><br><p>Certified Correct: <u>${settings.secretary}</u></p></div>`;
            const area = document.getElementById('print-area');
            area.innerHTML = html;
            window.print();
        }

        // --- IMPORT EXPORT ---
        function processExport() {
            const instrHeader = ["COLUMNS", "EXPECTED VALUES/ FORMAT", "REMARKS"];
            const instrData = [
                ["INHABITANT TYPE", "NON-MIGRANT", "Required Field"], ["", "MIGRANT", ""], ["", "TRANSIENT", ""],
                ["LAST NAME", "", "Required Field"], ["FIRST NAME", "", "Required Field"], ["MIDDLE NAME", "", "Optional Field"],
                ["SUFFIX", "", "Optional Field"], ["BIRTH PLACE", "", "Optional Field"], ["BIRTHDATE (YYYY-MM-DD)", "2000-12-30", "Required Field"],
                ["SEX", "MALE", "Required Field"], ["", "FEMALE", "Required Field"], ["CIVIL STATUS", "SINGLE", "Required Field"],
                ["", "MARRIED", "Required Field"], ["", "WIDOWED", "Required Field"], ["", "DIVORCED", "Required Field"],
                ["", "SEPARATED", "Required Field"], ["", "COMMON LAW/ LIVE-IN", "Required Field"], ["", "UNKNOWN", "Required Field"],
                ["", "ANNULLED", "Required Field"], ["CITIZENSHIP", "FILIPINO", "Required Field"], ["", "FOREIGNER", "Required Field"],
                ["PROFESSION/ OCCUPATION", "", "Optional Field"], ["CONTACT NUMBER", "", "Optional Field"], ["EMAIL ADDRESS", "", "Optional Field"],
                ["HIGHEST EDUCATIONAL ATTAINMENT", "", "Optional Field"], ["MOTHER'S FIRST NAME", "", "Optional Field"],
                ["MOTHER'S MIDDLE NAME", "", "Optional Field"], ["MOTHER'S LAST NAME", "", "Optional Field"]
            ];
            const dataHeader = ["INHABITANT TYPE", "LAST NAME", "FIRST NAME", "MIDDLE NAME", "SUFFIX", "BIRTH PLACE", "BIRTHDATE (YYYY-MM-DD)", "SEX", "CIVIL STATUS", "CITIZENSHIP", "PROFESSION/ OCCUPATION", "CONTACT NUMBER", "EMAIL ADDRESS", "HIGHEST EDUCATIONAL ATTAINMENT", "MOTHER'S FIRST NAME", "MOTHER'S MIDDLE NAME", "MOTHER'S LAST NAME"];
            const living = db.filter(r => !r.isDead);
            const dataRows = living.map(r => [
                r.type || "", r.last || "", r.first || "", r.middle || "", r.suffix || "", r.bplace || "", r.bdate || "", r.sex || "", r.civil || "",
                r.citizen || "FILIPINO", r.prof || "", r.contact || "", r.email || "", r.edu || "", r.mother_first || "", r.mother_middle || "", r.mother_last || ""
            ]);
            const wb = XLSX.utils.book_new();
            const wsInstr = XLSX.utils.aoa_to_sheet([instrHeader, ...instrData]);
            XLSX.utils.book_append_sheet(wb, wsInstr, "INSTRUCTIONS");
            const wsData = XLSX.utils.aoa_to_sheet([dataHeader, ...dataRows]);
            XLSX.utils.book_append_sheet(wb, wsData, "DATA");
            XLSX.writeFile(wb, "RBI_Export_BIMS.xlsx");
        }

        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({db, settings, household_db}));
            const a = document.createElement('a'); a.href = dataStr; a.download = "RBI_Backup.json"; a.click();
        }

        function restoreData(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(imported.db) { db = imported.db; if(imported.settings) settings = imported.settings; if(imported.household_db) household_db = imported.household_db; saveDB(); localStorage.setItem('rbi_settings', JSON.stringify(settings)); alert("Restored!"); location.reload(); }
                } catch(err) { alert("Error reading file"); }
            }; reader.readAsText(file);
        }

        function previewImport() {
            const file = document.getElementById('import-file').files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(e.target.result, {type: 'binary'});
                let sheetName = "DATA"; if(!workbook.Sheets[sheetName]) sheetName = workbook.SheetNames[1] || workbook.SheetNames[0];
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                stagingValid = []; stagingInvalid = []; stagingDup = [];
                const startRow = (json[0] && json[0][0] === "INHABITANT TYPE") ? 1 : 0;
                for(let i=startRow; i<json.length; i++) {
                    const row = json[i]; if(!row || row.length === 0) continue;
                    const tempRec = {
                        type: row[0], last: row[1], first: row[2], middle: row[3] || '', suffix: row[4] || '', bplace: row[5] || '', bdate: row[6], sex: row[7], civil: row[8], citizen: row[9] || 'FILIPINO',
                        prof: row[10] || '', contact: row[11] || '', email: row[12] || '', edu: row[13] || '', mother_first: row[14] || '', mother_middle: row[15] || '', mother_last: row[16] || '',
                        isPwd: false, isSoloParent: false, isOSY: false, isDead: false, address: '', hh_name: '', hh_role: 'MEMBER'
                    };
                    if(!tempRec.last || !tempRec.first || !tempRec.bdate) { stagingInvalid.push({ line: i+1, data: tempRec }); continue; }
                    const exists = db.some(x => x.last.toLowerCase() === tempRec.last.toLowerCase() && x.first.toLowerCase() === tempRec.first.toLowerCase() && x.bdate === tempRec.bdate);
                    if(exists) { stagingDup.push({ line: i+1, name: `${tempRec.last}, ${tempRec.first}` }); continue; }
                    tempRec.id = Date.now().toString() + i; stagingValid.push(tempRec);
                }
                document.getElementById('count-valid').innerText = stagingValid.length; document.getElementById('lbl-valid-count').innerText = stagingValid.length;
                document.getElementById('count-invalid').innerText = stagingInvalid.length; document.getElementById('count-dup').innerText = stagingDup.length;
                document.getElementById('btn-commit-import').disabled = (stagingValid.length === 0);
                document.getElementById('list-dup').innerHTML = stagingDup.map(x => `<div class="border-bottom p-1">Row ${x.line}: ${x.name}</div>`).join('');
                document.getElementById('list-invalid').innerHTML = stagingInvalid.map(x => `<div class="border-bottom p-1">Row ${x.line}: Missing Data</div>`).join('');
                document.getElementById('modal-import').style.display = 'block'; document.getElementById('modal-import').classList.add('show'); showImportTab('valid');
            }; reader.readAsBinaryString(file);
        }

        function showImportTab(tab) { document.querySelectorAll('.import-view').forEach(el => el.classList.add('d-none')); document.getElementById('view-'+tab).classList.remove('d-none'); }
        function closeImportModal() { document.getElementById('modal-import').style.display = 'none'; document.getElementById('modal-import').classList.remove('show'); document.getElementById('import-file').value = ''; }
        function commitImport() { if(stagingValid.length === 0) return; db = db.concat(stagingValid); saveDB(); closeImportModal(); alert(`Imported ${stagingValid.length} records.`); showHome(); }

        function saveSettings() {
            const sec = document.getElementById('set-sec').value; 
            const brgy = document.getElementById('set-brgy').value; 
            const prov = document.getElementById('set-prov').value; 
            const muni = document.getElementById('set-muni').value; 
            const lguType = document.getElementById('set-lgu-type').value;

            if(!sec || !brgy) return alert("Please fill in Barangay and Secretary name.");
            
            settings.secretary = sec.toUpperCase(); 
            settings.barangay = brgy.toUpperCase(); 
            settings.province = prov ? prov.toUpperCase() : ''; 
            settings.municipality = muni ? muni.toUpperCase() : ''; 
            settings.lguType = lguType;

            localStorage.setItem('rbi_settings', JSON.stringify(settings)); 
            alert('Configuration Saved!');
        }
    </script>
</body>
</html>
